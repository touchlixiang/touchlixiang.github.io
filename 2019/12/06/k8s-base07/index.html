<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="k8s,">










<meta name="keywords" content="k8s">
<meta property="og:type" content="article">
<meta property="og:title" content="05 Helm 应用包管理器">
<meta property="og:url" content="https://touchlixiang.github.io/2019/12/06/k8s-base07/index.html">
<meta property="og:site_name" content="My Notes">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://touchlixiang.github.io/img/mix_3.jpg">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_93.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_94.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_95.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_96.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_98.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_99.png">
<meta property="og:updated_time" content="2019-12-20T07:40:09.409Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="05 Helm 应用包管理器">
<meta name="twitter:image" content="https://touchlixiang.github.io/img/mix_3.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://touchlixiang.github.io/2019/12/06/k8s-base07/">





  <title>05 Helm 应用包管理器 | My Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">My Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记不住的一定要写在这里</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://touchlixiang.github.io/2019/12/06/k8s-base07/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Harris Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/Greeen.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">05 Helm 应用包管理器</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-06T17:13:56+08:00">
                2019-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="/img/mix_3.jpg" width="50%"><br><a id="more"></a></p>
<h2 id="为什么需要-Helm？"><a href="#为什么需要-Helm？" class="headerlink" title="为什么需要 Helm？"></a>为什么需要 Helm？</h2><ol>
<li>K8S上的应用对象，都是由特定的资源描述组成，包括deployment、service等。</li>
<li>都保存各自文件中或者集中写到一个配置文件。然后kubectl apply –f 部署。</li>
</ol>
<p><img src="/img/k8s/k8s_93.png" width="50%"></p>
<ol start="3">
<li>如果应用只由一个或几个这样的服务组成，上面部署方式足够了。</li>
<li>而对于一个复杂的应用，会有很多类似上面的资源描述文件，例如微服务架构应用，组成应用的服务可能多达十个，几十个。</li>
<li>如果有更新或回滚应用的需求，可能要修改和维护所涉及的大量资源文件，而这种组织和管理应用的方式就显得力不从心了。</li>
<li>且由于缺少对发布过的应用版本管理和控制，使Kubernetes上的应用维护和更新等面临诸多的挑战，主要面临以下问题：<ul>
<li><strong>如何将这些服务作为一个整体管理</strong></li>
<li><strong>这些资源文件如何高效复用</strong></li>
<li><strong>不支持应用级别的版本管理</strong></li>
</ul>
</li>
</ol>
<h2 id="Helm-介绍"><a href="#Helm-介绍" class="headerlink" title="Helm 介绍"></a>Helm 介绍</h2><ol>
<li>Helm是一个Kubernetes的包管理工具，就像Linux下的包管理器，如yum/apt等，可以很方便的将之前打包好的yaml文件部署到kubernetes上。</li>
<li><p>Helm有3个重要概念:</p>
<ul>
<li><p><strong>helm：</strong>一个命令行客户端工具，主要用于Kubernetes应用chart的创建、打包、发布和管理。</p>
</li>
<li><p><strong>Chart：</strong>应用描述，一系列用于描述 k8s 资源相关文件的集合。</p>
</li>
<li><strong>Release：</strong>基于Chart的部署实体，一个 chart 被 Helm 运行后将会生成对应的一个 release；将在k8s中创建出真实运行的资源对象。</li>
</ul>
</li>
</ol>
<h2 id="Helm-v3-变化"><a href="#Helm-v3-变化" class="headerlink" title="Helm v3 变化"></a>Helm v3 变化</h2><ol>
<li><strong>2019年11月13日，</strong> Helm团队发布 <code>Helm v3</code>的第一个稳定版本。</li>
<li><strong>该版本主要变化如下：</strong></li>
</ol>
<h3 id="架构变化"><a href="#架构变化" class="headerlink" title="架构变化"></a>架构变化</h3><ol>
<li><strong>最明显的变化是 <code>Tiller</code>的删除</strong></li>
<li><code>Release</code>名称可以在不同命名空间重用</li>
<li>支持将 Chart 推送至 Docker 镜像仓库中  </li>
<li>使用JSONSchema验证chart values  </li>
</ol>
<p><img src="/img/k8s/k8s_94.png" width="50%"></p>
<ol start="5">
<li>其他 </li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1. 为了更好地协调其他包管理者的措辞 `Helm CLI `个别更名</span><br><span class="line"></span><br><span class="line">helm delete   更名为 helm uninstall</span><br><span class="line">helm inspect  更名为 helm show</span><br><span class="line">helm fetch    更名为 helm pull</span><br><span class="line">但以上旧的命令当前仍能使用。</span><br><span class="line"></span><br><span class="line">2. 移除了用于本地临时搭建 `Chart Repository `的 `helm serve` 命令。</span><br><span class="line"></span><br><span class="line">3. 自动创建名称空间</span><br><span class="line">在不存在的命名空间中创建发行版时，Helm 2创建了命名空间。Helm 3遵循其他Kubernetes对象的行为，如果命名空间不存在则返回错误。</span><br><span class="line"></span><br><span class="line">4. 不再需要`requirements.yaml`, 依赖关系是直接在`chart.yaml`中定义。</span><br></pre></td></tr></table></figure>
<h2 id="Helm-客户端"><a href="#Helm-客户端" class="headerlink" title="Helm 客户端"></a>Helm 客户端</h2><h3 id="部署-Helm-客户端"><a href="#部署-Helm-客户端" class="headerlink" title="部署 Helm 客户端"></a>部署 Helm 客户端</h3><ol>
<li>Helm客户端下载地址：<a href="https://github.com/helm/helm/releases" target="_blank" rel="noopener">https://github.com/helm/helm/releases</a></li>
<li>解压移动到/usr/bin/目录即可。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://get.helm.sh/helm-v3.0.0-linux-amd64.tar.gz</span><br><span class="line">tar zxvf helm-v3.0.0-linux-amd64.tar.gz </span><br><span class="line">mv linux-amd64/helm /usr/bin/</span><br></pre></td></tr></table></figure>
<h3 id="Helm-常用命令"><a href="#Helm-常用命令" class="headerlink" title="Helm 常用命令"></a>Helm 常用命令</h3><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>create</td>
<td>创建一个chart并指定名字</td>
</tr>
<tr>
<td>dependency</td>
<td>管理chart依赖</td>
</tr>
<tr>
<td>get</td>
<td>下载一个release。可用子命令：all、hooks、manifest、notes、values</td>
</tr>
<tr>
<td>history</td>
<td>获取release历史</td>
</tr>
<tr>
<td>install</td>
<td>安装一个chart</td>
</tr>
<tr>
<td>list</td>
<td>列出release</td>
</tr>
<tr>
<td>package</td>
<td>将chart目录打包到chart存档文件中</td>
</tr>
<tr>
<td>pull</td>
<td>从远程仓库中下载chart并解压到本地  # helm pull stable/mysql –untar</td>
</tr>
<tr>
<td>repo</td>
<td>添加，列出，移除，更新和索引chart仓库。可用子命令：add、index、list、remove、update</td>
</tr>
<tr>
<td>rollback</td>
<td>从之前版本回滚</td>
</tr>
<tr>
<td>search</td>
<td>根据关键字搜索chart。可用子命令：hub、repo</td>
</tr>
<tr>
<td>show</td>
<td>查看chart详细信息。可用子命令：all、chart、readme、values</td>
</tr>
<tr>
<td>status</td>
<td>显示已命名版本的状态</td>
</tr>
<tr>
<td>template</td>
<td>本地呈现模板</td>
</tr>
<tr>
<td>uninstall</td>
<td>卸载一个release</td>
</tr>
<tr>
<td>upgrade</td>
<td>更新一个release</td>
</tr>
<tr>
<td>version</td>
<td>查看helm客户端版本</td>
</tr>
</tbody>
</table>
<h3 id="配置国内-Chart-仓库"><a href="#配置国内-Chart-仓库" class="headerlink" title="配置国内 Chart 仓库"></a>配置国内 Chart 仓库</h3><ul>
<li>微软仓库（<a href="http://mirror.azure.cn/kubernetes/charts/）" target="_blank" rel="noopener">http://mirror.azure.cn/kubernetes/charts/）</a>   这个仓库强烈推荐，基本上官网有的chart这里都有。</li>
<li>阿里云仓库（<a href="https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts" target="_blank" rel="noopener">https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</a>  ）</li>
<li>官方仓库（<a href="https://hub.kubeapps.com/charts/incubator）" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/incubator）</a>   官方chart仓库，国内有点不好使。</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add stable http://mirror.azure.cn/kubernetes/charts</span><br><span class="line">helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts </span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# helm repo add stable http://mirror.azure.cn/kubernetes/charts</span><br><span class="line">"stable" has been added to your repositories</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# helm repo list</span><br><span class="line">NAME  	URL                                     </span><br><span class="line">stable	http://mirror.azure.cn/kubernetes/charts</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# helm search repo mysql</span><br><span class="line">NAME                            	CHART VERSION	APP VERSION	DESCRIPTION                                       </span><br><span class="line">stable/mysql                    	1.6.2        	5.7.28     	Fast, reliable, scalable, and easy to use open-...</span><br><span class="line">stable/mysqldump                	2.6.0        	2.4.1      	A Helm chart to help backup MySQL databases usi...</span><br><span class="line">stable/prometheus-mysql-exporter	0.5.2        	v0.11.0    	A Helm chart for prometheus mysql exporter with...</span><br><span class="line">stable/percona                  	1.2.0        	5.7.17     	free, fully compatible, enhanced, open source d...</span><br><span class="line">stable/percona-xtradb-cluster   	1.0.3        	5.7.19     	free, fully compatible, enhanced, open source d...</span><br><span class="line">stable/phpmyadmin               	4.2.4        	4.9.2      	phpMyAdmin is an mysql administration frontend    </span><br><span class="line">stable/gcloud-sqlproxy          	0.6.1        	1.11       	DEPRECATED Google Cloud SQL Proxy                 </span><br><span class="line">stable/mariadb                  	7.3.1        	10.3.21    	Fast, reliable, scalable, and easy to use open-...</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 查看仓库中所有chart</span><br><span class="line">[root@k8s-master1 ~]# helm search repo stable</span><br><span class="line">[root@k8s-master1 ~]# helm search repo stable |grep swift</span><br></pre></td></tr></table></figure>
<h3 id="添加多个仓库"><a href="#添加多个仓库" class="headerlink" title="添加多个仓库"></a>添加多个仓库</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts </span><br><span class="line">"aliyun" has been added to your repositories</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# helm repo list</span><br><span class="line">NAME  	URL                                                   </span><br><span class="line">stable	http://mirror.azure.cn/kubernetes/charts              </span><br><span class="line">aliyun	https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# helm search repo mysql</span><br><span class="line">NAME                            	CHART VERSION	APP VERSION	DESCRIPTION                                       </span><br><span class="line">aliyun/mysql                    	0.3.5        	           	Fast, reliable, scalable, and easy to use open-...</span><br><span class="line">stable/mysql                    	1.6.2        	5.7.28     	Fast, reliable, scalable, and easy to use open-...</span><br><span class="line">stable/mysqldump                	2.6.0        	2.4.1      	A Helm chart to help backup MySQL databases usi...</span><br><span class="line">stable/prometheus-mysql-exporter	0.5.2        	v0.11.0    	A Helm chart for prometheus mysql exporter with...</span><br><span class="line">aliyun/percona                  	0.3.0        	           	free, fully compatible, enhanced, open source d...</span><br><span class="line">aliyun/percona-xtradb-cluster   	0.0.2        	5.7.19     	free, fully compatible, enhanced, open source d...</span><br><span class="line">stable/percona                  	1.2.0        	5.7.17     	free, fully compatible, enhanced, open source d...</span><br><span class="line">stable/percona-xtradb-cluster   	1.0.3        	5.7.19     	free, fully compatible, enhanced, open source d...</span><br><span class="line">stable/phpmyadmin               	4.2.4        	4.9.2      	phpMyAdmin is an mysql administration frontend    </span><br><span class="line">aliyun/gcloud-sqlproxy          	0.2.3        	           	Google Cloud SQL Proxy                            </span><br><span class="line">aliyun/mariadb                  	2.1.6        	10.1.31    	Fast, reliable, scalable, and easy to use open-...</span><br><span class="line">stable/gcloud-sqlproxy          	0.6.1        	1.11       	DEPRECATED Google Cloud SQL Proxy                 </span><br><span class="line">stable/mariadb                  	7.3.1        	10.3.21    	Fast, reliable, scalable, and easy to use open-...</span><br></pre></td></tr></table></figure>
<h3 id="删除存储库"><a href="#删除存储库" class="headerlink" title="删除存储库"></a>删除存储库</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# helm repo remove aliyun</span><br></pre></td></tr></table></figure>
<h2 id="Helm-基本使用"><a href="#Helm-基本使用" class="headerlink" title="Helm 基本使用"></a>Helm 基本使用</h2><ol>
<li><p>主要介绍三个命令:</p>
<ul>
<li><p><strong>chart install</strong></p>
</li>
<li><p><strong>chart update</strong></p>
</li>
<li><p><strong>chart rollback</strong></p>
</li>
</ul>
</li>
</ol>
<h3 id="使用-chart-部署一个应用"><a href="#使用-chart-部署一个应用" class="headerlink" title="使用 chart 部署一个应用"></a>使用 chart 部署一个应用</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 查找chart </span><br><span class="line">[root@k8s-master1 ~]# helm search repo</span><br><span class="line">[root@k8s-master1 ~]# helm search repo mysql</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查看chart信息</span><br><span class="line">[root@k8s-master1 ~]# helm show chart stable/mysql</span><br><span class="line"># values 相当于 模板的变量 yaml文件中的动态字段需要动态传值</span><br><span class="line">[root@k8s-master1 ~]# helm show values stable/mysql</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 安装 db1 是 Release 的名称</span><br><span class="line"># 部署后会弹出 使用信息</span><br><span class="line">[root@k8s-master1 ~]# helm install db1 stable/mysql</span><br><span class="line"># 获取密码</span><br><span class="line">[root@k8s-master1 ~]# kubectl get secret --namespace default db1-mysql -o jsonpath="&#123;.data.mysql-root-password&#125;" | base64 --decode; echo</span><br><span class="line">5R4VprCnNT</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_95.png" width="50%"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查看部署状态</span><br><span class="line">[root@k8s-master1 ~]# helm  list</span><br><span class="line">NAME	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART      	APP VERSION</span><br><span class="line">db1 	default  	1       	2019-12-17 11:23:30.533875697 +0800 CST	deployed	mysql-1.6.2	5.7.28</span><br></pre></td></tr></table></figure>
<h4 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看发布状态</span><br><span class="line">[root@k8s-master1 ~]# helm status db1</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 查看pod状态</span><br><span class="line">[root@k8s-master1 ~]# kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">db1-mysql-868b97747b-tnpwk                0/1     Pending   0          9m59s        # 等待</span><br><span class="line">metrics-app-7674cfb699-nzmdz              1/1     Running   0          132m</span><br><span class="line">metrics-app-7674cfb699-thjzk              1/1     Running   0          132m</span><br><span class="line">metrics-app-7674cfb699-xvfpx              1/1     Running   0          132m</span><br><span class="line">nfs-client-provisioner-5dd6f66f47-w5t6w   1/1     Running   0          137m</span><br><span class="line">web-6f4b67f8cc-j2ccg                      1/1     Running   0          148m</span><br><span class="line">web-6f4b67f8cc-mljnd                      1/1     Running   0          148m</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 查看事件</span><br><span class="line">[root@k8s-master1 ~]# kubectl describe pod db1-mysql-868b97747b-tnpwk</span><br><span class="line"></span><br><span class="line"># 没有 pvc</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age        From               Message</span><br><span class="line">  ----     ------            ----       ----               -------</span><br><span class="line">  Warning  FailedScheduling  <span class="tag">&lt;<span class="name">unknown</span>&gt;</span>  default-scheduler  pod has unbound immediate PersistentVolumeClaims (repeated 2 times)</span><br><span class="line">  Warning  FailedScheduling  <span class="tag">&lt;<span class="name">unknown</span>&gt;</span>  default-scheduler  pod has unbound immediate PersistentVolumeClaims (repeated 2 times)</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 绑定pvc的方法:</span><br><span class="line">1. 静态</span><br><span class="line">2. 动态</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查看pvc</span><br><span class="line">[root@k8s-master1 ~]# kubectl get pvc</span><br><span class="line">NAME        STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">db1-mysql   Pending                                                     12m</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个pvc匹配到 db1-mysql </span><br><span class="line">[root@k8s-master1 ~]# kubectl describe pvc db1-mysql</span><br><span class="line">Name:          db1-mysql</span><br><span class="line">Namespace:     default</span><br><span class="line">StorageClass:  </span><br><span class="line">Status:        Pending</span><br><span class="line">Volume:        </span><br><span class="line">Labels:        app=db1-mysql</span><br><span class="line">               chart=mysql-1.6.2</span><br><span class="line">               heritage=Helm</span><br><span class="line">               release=db1</span><br><span class="line">Annotations:   <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">Finalizers:    [kubernetes.io/pvc-protection]</span><br><span class="line">Capacity:      </span><br><span class="line">Access Modes:  </span><br><span class="line">VolumeMode:    Filesystem</span><br><span class="line">Mounted By:    db1-mysql-868b97747b-tnpwk</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason         Age                   From                         Message</span><br><span class="line">  ----    ------         ----                  ----                         -------</span><br><span class="line">  Normal  FailedBinding  3m57s (x42 over 14m)  persistentvolume-controller  no persistent volumes available for this claim and no storage class is set</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# kubectl get pvc db1-mysql -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: "2019-12-17T03:23:30Z"</span><br><span class="line">  finalizers:</span><br><span class="line">  - kubernetes.io/pvc-protection</span><br><span class="line">  labels:</span><br><span class="line">    app: db1-mysql</span><br><span class="line">    chart: mysql-1.6.2</span><br><span class="line">    heritage: Helm</span><br><span class="line">    release: db1</span><br><span class="line">  name: db1-mysql</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: "18423"</span><br><span class="line">  selfLink: /api/v1/namespaces/default/persistentvolumeclaims/db1-mysql</span><br><span class="line">  uid: 8fc33553-3154-448b-92a5-cff2a7c3b757</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce           # 所有节点可以读写</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 8Gi          # 8G存储</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">status:</span><br><span class="line">  phase: Pending</span><br></pre></td></tr></table></figure>
<h4 id="创建-pv"><a href="#创建-pv" class="headerlink" title="创建 pv"></a>创建 pv</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 模板</span><br><span class="line">https://kubernetes.io/docs/concepts/storage/persistent-volumes/</span><br><span class="line"></span><br><span class="line"># Persistent Volumes</span><br><span class="line"># Each PV contains a spec and status, which is the specification and status of the volume.</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv0003</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Gi</span><br><span class="line">  volumeMode: Filesystem</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">  storageClassName: slow</span><br><span class="line">  mountOptions:</span><br><span class="line">    - hard</span><br><span class="line">    - nfsvers=4.1</span><br><span class="line">  nfs:</span><br><span class="line">    path: /tmp</span><br><span class="line">    server: 172.17.0.2</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># nfs主机上创建目录</span><br><span class="line">[root@k8s-node2 ~]# mkdir /ifs/kubernetes/db</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 创建 pv</span><br><span class="line">[root@k8s-master1 pv]# vim pv.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: pv0003</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 8Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  nfs:</span><br><span class="line">    path: /ifs/kubernetes/db</span><br><span class="line">    server: 172.17.70.254</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 pv]# kubectl apply -f pv.yaml </span><br><span class="line">persistentvolume/pv0003 created</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 pv]# kubectl get pv,pvc</span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                      STORAGECLASS          REASON   AGE</span><br><span class="line">persistentvolume/pv0003                                     8Gi        RWO            Retain           Bound    default/db1-mysql                                                         70s</span><br><span class="line">persistentvolume/pvc-56346fbf-b298-4573-a0dd-1429325dcb71   16Gi       RWO            Delete           Bound    kube-system/prometheus-data-prometheus-0   managed-nfs-storage            151m</span><br><span class="line"></span><br><span class="line">NAME                              STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">persistentvolumeclaim/db1-mysql   Bound    pv0003   8Gi        RWO                           25m</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 pv]# kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">db1-mysql-868b97747b-tnpwk                1/1     Running   0          26m</span><br></pre></td></tr></table></figure>
<h4 id="登录测试"><a href="#登录测试" class="headerlink" title="登录测试"></a>登录测试</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"># 由于网络原因 就不使用官网容器测试了 直接登录测试</span><br><span class="line"># 先拿到密码</span><br><span class="line">[root@k8s-master1 pv]# helm list</span><br><span class="line">[root@k8s-master1 pv]# helm status db1</span><br><span class="line">[root@k8s-master1 pv]# kubectl get secret --namespace default db1-mysql -o jsonpath="&#123;.data.mysql-root-password&#125;" | base64 --decode; echo</span><br><span class="line">5R4VprCnNT</span><br><span class="line"></span><br><span class="line"># 登录 mysql</span><br><span class="line">[root@k8s-master1 pv]# kubectl get pods</span><br><span class="line">[root@k8s-master1 pv]# kubectl exec -it db1-mysql-868b97747b-tnpwk bash</span><br><span class="line"></span><br><span class="line">root@db1-mysql-868b97747b-tnpwk:/# mysql -uroot -p5R4VprCnNT</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 58</span><br><span class="line">Server version: 5.7.28 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; create database test;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line"># 看下变量 发现有的是空的</span><br><span class="line">root@db1-mysql-868b97747b-tnpwk:/# echo $MYSQL_ROOT_PASSWORD</span><br><span class="line">5R4VprCnNT</span><br><span class="line">root@db1-mysql-868b97747b-tnpwk:/# echo $MYSQL_PORT         </span><br><span class="line"></span><br><span class="line">root@db1-mysql-868b97747b-tnpwk:/# echo $MYSQL_HOST</span><br></pre></td></tr></table></figure>
<h3 id="使用自己的-nfs-pv自动供给"><a href="#使用自己的-nfs-pv自动供给" class="headerlink" title="使用自己的 nfs pv自动供给"></a>使用自己的 nfs pv自动供给</h3><ol>
<li>修改chart的部署选项</li>
<li>上面部署的mysql一开始并没有成功，这是因为并不是所有的chart都能按照默认配置运行成功，可能会需要一些环境依赖，例如PV。</li>
<li>所以我们需要自定义chart配置选项，安装过程中有两种方法可以传递配置数据：<ul>
<li>–values（或-f）：指定带有覆盖的YAML文件。这可以多次指定，最右边的文件优先</li>
<li>–set：在命令行上指定替代。如果两者都用，–set优先级高</li>
</ul>
</li>
</ol>
<h4 id="values-使用"><a href="#values-使用" class="headerlink" title="values 使用"></a>values 使用</h4><ol>
<li>先将修改的变量写到一个文件中</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 pv]# helm show values stable/mysql &gt; values.yaml   # 后面看默认的位置</span><br><span class="line"># 只保留要配置的地方 比如pvc</span><br><span class="line"># 增加一些配置 如 创建用户 数据库 等</span><br><span class="line"># 查看下自动供给</span><br><span class="line">[root@k8s-master1 ~]# kubectl get sc</span><br><span class="line">NAME                  PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri/ifs   169m</span><br><span class="line"></span><br><span class="line"># 修改配置文件</span><br><span class="line">[root@k8s-master1 pv]# vim values.yaml </span><br><span class="line"></span><br><span class="line">## Specify password for root user</span><br><span class="line">## Default: random 10 character string</span><br><span class="line">mysqlRootPassword: testing</span><br><span class="line"></span><br><span class="line">## Create a database user</span><br><span class="line">mysqlUser: k8s</span><br><span class="line">## Default: random 10 character string</span><br><span class="line">mysqlPassword: k8s123</span><br><span class="line"></span><br><span class="line">## Create a database</span><br><span class="line">mysqlDatabase: k8s</span><br><span class="line"></span><br><span class="line">## Persist data to a persistent volume</span><br><span class="line">persistence:</span><br><span class="line">  enabled: true</span><br><span class="line">  ## database data Persistent Volume Storage Class</span><br><span class="line">  ## If defined, storageClassName: <span class="tag">&lt;<span class="name">storageClass</span>&gt;</span></span><br><span class="line">  ## If set to "-", storageClassName: "", which disables dynamic provisioning</span><br><span class="line">  ## If undefined (the default) or set to null, no storageClassName spec is</span><br><span class="line">  ##   set, choosing the default provisioner.  (gp2 on AWS, standard on</span><br><span class="line">  ##   GKE, AWS &amp; OpenStack)</span><br><span class="line">  ##</span><br><span class="line">  storageClass: "managed-nfs-storage"</span><br><span class="line">  accessMode: ReadWriteOnce</span><br><span class="line">  size: 8Gi</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># 以上将创建具有名称的默认MySQL用户k8s，并授予此用户访问新创建的k8s数据库的权限，但将接受该图表的所有其余默认值。</span><br><span class="line"># 指定配置文件部署</span><br><span class="line">[root@k8s-master1 pv]# helm install db2 -f values.yaml stable/mysql</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 pv]# helm list</span><br><span class="line">NAME	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART      	APP VERSION</span><br><span class="line">db1 	default  	1       	2019-12-17 11:23:30.533875697 +0800 CST	deployed	mysql-1.6.2	5.7.28     </span><br><span class="line">db2 	default  	1       	2019-12-17 12:08:36.436489783 +0800 CST	deployed	mysql-1.6.2	5.7.28 </span><br><span class="line"></span><br><span class="line"># 直接可以运行</span><br><span class="line">[root@k8s-master1 pv]# kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">db1-mysql-868b97747b-tnpwk                1/1     Running   0          45m</span><br><span class="line">db2-mysql-76495946b5-7x9jw                1/1     Running   0          44s</span><br><span class="line"></span><br><span class="line"># 进入测试</span><br><span class="line">root@db2-mysql-76495946b5-7x9jw:/# mysql -uroot -ptesting</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 19</span><br><span class="line">Server version: 5.7.28 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| k8s                |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.05 sec)</span><br><span class="line"></span><br><span class="line">root@db2-mysql-76495946b5-7x9jw:/# mysql -uk8s -pk8s123</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 小总结: </span><br><span class="line">如果helm使用官方创建，有一些依赖需要提前准备,比如pv</span><br><span class="line">1. 引用values.yaml</span><br><span class="line">2. --set</span><br></pre></td></tr></table></figure>
<h4 id="set-使用"><a href="#set-使用" class="headerlink" title="set 使用"></a>set 使用</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 pv]# helm install db3 --set persistence.storageClass="managed-nfs-storage" stable/mysql</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 pv]# helm list</span><br><span class="line">NAME	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART      	APP VERSION</span><br><span class="line">db1 	default  	1       	2019-12-17 11:23:30.533875697 +0800 CST	deployed	mysql-1.6.2	5.7.28     </span><br><span class="line">db2 	default  	1       	2019-12-17 12:08:36.436489783 +0800 CST	deployed	mysql-1.6.2	5.7.28     </span><br><span class="line">db3 	default  	1       	2019-12-17 12:13:53.856941497 +0800 CST	deployed	mysql-1.6.2	5.7.28 </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 pv]# kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">db1-mysql-868b97747b-tnpwk                1/1     Running   0          51m</span><br><span class="line">db2-mysql-76495946b5-7x9jw                1/1     Running   0          6m1s</span><br><span class="line">db3-mysql-59585b7656-vwfvw                1/1     Running   0          40s</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># set传入需要遵循语法 values 结构化数据</span><br><span class="line"># values yaml与set使用：</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_96.png" width="50%"></p>
<h4 id="拉取整个chart包"><a href="#拉取整个chart包" class="headerlink" title="拉取整个chart包"></a>拉取整个chart包</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># --untar 拉取后直接解压</span><br><span class="line">[root@k8s-master1 pv]# helm pull stable/mysql --untar </span><br><span class="line">[root@k8s-master1 pv]# ls</span><br><span class="line">mysql</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 pv]# cd mysql/</span><br><span class="line">[root@k8s-master1 mysql]# ls -l</span><br><span class="line">total 40</span><br><span class="line">-rw-r--r-- 1 root root   502 Dec 17 12:17 Chart.yaml   </span><br><span class="line">-rw-r--r-- 1 root root 22284 Dec 17 12:17 README.md</span><br><span class="line">drwxr-xr-x 3 root root  4096 Dec 17 12:17 templates</span><br><span class="line">-rw-r--r-- 1 root root  5646 Dec 17 12:17 values.yaml   # 覆盖的就是这个配置文件 </span><br><span class="line"></span><br><span class="line"># 部署mysql的yaml文件目录</span><br><span class="line">[root@k8s-master1 mysql]# ls -l templates/</span><br><span class="line">total 52</span><br><span class="line">-rw-r--r-- 1 root root  292 Dec 17 12:17 configurationFiles-configmap.yaml</span><br><span class="line">-rw-r--r-- 1 root root 8610 Dec 17 12:17 deployment.yaml</span><br><span class="line">-rw-r--r-- 1 root root 1290 Dec 17 12:17 _helpers.tpl</span><br><span class="line">-rw-r--r-- 1 root root  295 Dec 17 12:17 initializationFiles-configmap.yaml</span><br><span class="line">-rw-r--r-- 1 root root 1797 Dec 17 12:17 NOTES.txt</span><br><span class="line">-rw-r--r-- 1 root root  868 Dec 17 12:17 pvc.yaml</span><br><span class="line">-rw-r--r-- 1 root root 1475 Dec 17 12:17 secrets.yaml</span><br><span class="line">-rw-r--r-- 1 root root  328 Dec 17 12:17 serviceaccount.yaml</span><br><span class="line">-rw-r--r-- 1 root root  800 Dec 17 12:17 servicemonitor.yaml</span><br><span class="line">-rw-r--r-- 1 root root 1104 Dec 17 12:17 svc.yaml</span><br><span class="line">drwxr-xr-x 2 root root 4096 Dec 17 12:17 tests</span><br></pre></td></tr></table></figure>
<h4 id="helm-install-命令可以从多个来源安装"><a href="#helm-install-命令可以从多个来源安装" class="headerlink" title="helm install 命令可以从多个来源安装"></a>helm install 命令可以从多个来源安装</h4><ul>
<li>chart存储库</li>
<li>本地chart存档（helm install foo-0.1.1.tgz）</li>
<li>chart目录（helm install path/to/foo）</li>
<li>完整的URL（helm install <a href="https://example.com/charts/foo-1.2.3.tgz）" target="_blank" rel="noopener">https://example.com/charts/foo-1.2.3.tgz）</a></li>
</ul>
<h2 id="构建一个-Helm-Chart"><a href="#构建一个-Helm-Chart" class="headerlink" title="构建一个 Helm Chart"></a>构建一个 Helm Chart</h2><h3 id="自动生成目录"><a href="#自动生成目录" class="headerlink" title="自动生成目录"></a>自动生成目录</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# helm create mychart</span><br><span class="line">Creating mychart</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# cd mychart/</span><br><span class="line">[root@k8s-master1 mychart]# ls -l</span><br><span class="line">drwxr-xr-x 2 root root 4096 Dec 17 16:54 charts</span><br><span class="line">-rw-r--r-- 1 root root  905 Dec 17 16:54 Chart.yaml</span><br><span class="line">drwxr-xr-x 3 root root 4096 Dec 17 16:54 templates</span><br><span class="line">-rw-r--r-- 1 root root 1490 Dec 17 16:54 values.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 启动这个默认自动创建的 mychart 会发现是一个 nginx服务</span><br><span class="line">[root@k8s-master1 ~]# helm install test mychart/</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# kubectl get pods | grep test</span><br><span class="line">test-mychart-b5cd6d7c8-5mz8b              1/1     Running   0          42s</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# kubectl get pods -o wide | grep test</span><br><span class="line">test-mychart-b5cd6d7c8-5mz8b              1/1     Running   0          59s     10.244.2.9   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">[root@k8s-master1 ~]# curl -I 10.244.2.9</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.16.0</span><br><span class="line">Date: Tue, 17 Dec 2019 08:58:21 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Tue, 23 Apr 2019 10:18:21 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: "5cbee66d-264"</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# helm list</span><br><span class="line">NAME	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART        	APP VERSION</span><br><span class="line">db1 	default  	1       	2019-12-17 11:23:30.533875697 +0800 CST	deployed	mysql-1.6.2  	5.7.28     </span><br><span class="line">db2 	default  	1       	2019-12-17 12:08:36.436489783 +0800 CST	deployed	mysql-1.6.2  	5.7.28     </span><br><span class="line">db3 	default  	1       	2019-12-17 12:13:53.856941497 +0800 CST	deployed	mysql-1.6.2  	5.7.28     </span><br><span class="line">test	default  	1       	2019-12-17 16:57:09.278738153 +0800 CST	deployed	mychart-0.1.0	1.16.0</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 文件内容: </span><br><span class="line">[root@k8s-master1 ~]# tree /root/mychart/</span><br><span class="line">/root/mychart/</span><br><span class="line">├── charts               # 目录里存放这个chart依赖的所有子chart。</span><br><span class="line">├── Chart.yaml           # 用于描述这个 Chart的基本信息，包括名字、描述信息以及版本等。</span><br><span class="line">├── templates            # 目录里面存放所有yaml模板文件。</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── _helpers.tpl     # 放置模板助手的地方，可以在整个 chart 中重复使用</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   ├── NOTES.txt        # 用于介绍Chart帮助信息，helm install 部署后展示给用户。例如：如何使用这个 Chart、列出缺省的设置等。</span><br><span class="line">│   ├── serviceaccount.yaml</span><br><span class="line">│   ├── service.yaml</span><br><span class="line">│   └── tests</span><br><span class="line">│       └── test-connection.yaml</span><br><span class="line">└── values.yaml         # 动态变量 用于存储 templates 目录中模板文件中用到变量的值。</span><br></pre></td></tr></table></figure>
<h3 id="简单制作一个-chart"><a href="#简单制作一个-chart" class="headerlink" title="简单制作一个 chart"></a>简单制作一个 chart</h3><h4 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 将文件和目录清空</span><br><span class="line">[root@k8s-master1 mychart]# tree</span><br><span class="line">.</span><br><span class="line">├── charts</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── templates</span><br><span class="line">└── values.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 创建nginx的 deployment</span><br><span class="line">[root@k8s-master1 templates]# kubectl create deployment mychart --image=nginx:1.16 -o yaml --dry-run &gt; deployment.yaml</span><br><span class="line"># 删除不要的配置</span><br><span class="line">[root@k8s-master1 templates]# vim deployment.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: mychart</span><br><span class="line">  name: mychart</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mychart</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mychart</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.16</span><br><span class="line">        name: nginx</span><br></pre></td></tr></table></figure>
<h4 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h4><ol>
<li>Helm最核心的就是模板，即模板化的K8S manifests文件。</li>
<li>它本质上就是一个Go的template模板。Helm在Go template模板的基础上，还会增加很多东西。</li>
<li>如一些自定义的元数据信息、扩展的库以及一些类似于编程形式的工作流，例如条件语句、管道等等。这些东西都会使得我们的模板变得更加丰富。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 修改成 动态模板</span><br><span class="line"># 有了模板，我们怎么把我们的配置融入进去呢？用的就是这个values文件。这两部分内容其实就是chart的核心功能。</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 templates]# vim deployment.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; .Values.name &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  replicas: &#123;&#123; .Values.replicas &#125;&#125;</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mychart</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mychart</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: &#123;&#123; .Values.image  &#125;&#125;:&#123;&#123; .Values.imageTag &#125;&#125;</span><br><span class="line">        name: nginx</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 加入变量 引入名字需要一致</span><br><span class="line">[root@k8s-master1 templates]# vim ../values.yaml </span><br><span class="line"></span><br><span class="line">name: hello</span><br><span class="line">replicas: 3</span><br><span class="line">image: nginx</span><br><span class="line">imageTag: 1.15</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line">[root@k8s-master1 ~]# helm install hello mychart/</span><br><span class="line">NAME: hello</span><br><span class="line">LAST DEPLOYED: Tue Dec 17 17:56:12 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line"></span><br><span class="line"># 卸载</span><br><span class="line">[root@k8s-master1 ~]# helm uninstall hello</span><br><span class="line">release "hello" uninstalled</span><br><span class="line"></span><br><span class="line"># 查看</span><br><span class="line">[root@k8s-master1 ~]# kubectl get pods -o wide| grep hello</span><br><span class="line">hello-d8ccdfdd8-cw7qh                     1/1     Running   0          38s     10.244.2.10   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">hello-d8ccdfdd8-mqh76                     1/1     Running   0          38s     10.244.1.9    k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">hello-d8ccdfdd8-skdjw                     1/1     Running   0          38s     10.244.0.11   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# helm list|grep hello</span><br><span class="line">hello	default  	1       	2019-12-17 17:56:12.316160884 +0800 CST	deployed	mychart-0.1.0	1.16.0  </span><br><span class="line"></span><br><span class="line"># 查看渲染后的部署文件</span><br><span class="line"># 我们希望能在一个地方统一定义这些会经常变换的字段，这就需要用到Chart的模板了。</span><br><span class="line">[root@k8s-master1 ~]# helm get manifest hello</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># Source: mychart/templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: hello</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: mychart</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mychart</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.15</span><br><span class="line">        name: nginx</span><br></pre></td></tr></table></figure>
<h4 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h4><ol>
<li>发布新版本的chart时，或者当您要更改发布的配置时，可以使用该<code>helm upgrade</code> 命令。 </li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 修改values.yaml</span><br><span class="line">[root@k8s-master1 mychart]# vim values.yaml </span><br><span class="line"></span><br><span class="line">name: hello</span><br><span class="line">replicas: 3</span><br><span class="line">image: nginx</span><br><span class="line">imageTag: 1.16</span><br><span class="line"></span><br><span class="line"># 升级</span><br><span class="line">[root@k8s-master1 mychart]# helm upgrade hello /root/mychart/</span><br><span class="line">Release "hello" has been upgraded. Happy Helming!</span><br><span class="line">NAME: hello</span><br><span class="line">LAST DEPLOYED: Tue Dec 17 18:04:30 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 2</span><br><span class="line">TEST SUITE: None</span><br><span class="line">[root@k8s-master1 mychart]# kubectl get pods -o wide| grep hello</span><br><span class="line">hello-5b97fb4c85-hssrt                    1/1     Running       0          7s      10.244.0.12   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">hello-5b97fb4c85-wlwnj                    1/1     Running       0          3s      10.244.1.10   k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">hello-5b97fb4c85-x2zp7                    1/1     Running       0          4s      10.244.2.11   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">hello-d8ccdfdd8-mqh76                     0/1     Terminating   0          8m25s   10.244.1.9    k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">hello-d8ccdfdd8-skdjw                     1/1     Terminating   0          8m25s   10.244.0.11   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">[root@k8s-master1 mychart]# curl -I 10.244.0.12</span><br></pre></td></tr></table></figure>
<h4 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h4><ol>
<li>如果在发布后没有达到预期的效果，则可以使用<code>helm rollback</code>回滚到之前的版本。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 回滚到上一个版本</span><br><span class="line">[root@k8s-master1 mychart]# helm rollback hello</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 回滚到指定版本</span><br><span class="line">[root@k8s-master1 mychart]# helm history hello</span><br><span class="line">REVISION	UPDATED                 	STATUS    	CHART        	APP VERSION	DESCRIPTION     </span><br><span class="line">1       	Tue Dec 17 17:56:12 2019	superseded	mychart-0.1.0	1.16.0     	Install complete</span><br><span class="line">2       	Tue Dec 17 18:04:30 2019	superseded	mychart-0.1.0	1.16.0     	Upgrade complete</span><br><span class="line">3       	Tue Dec 17 18:07:56 2019	deployed  	mychart-0.1.0	1.16.0     	Rollback to 1   </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 mychart]# helm rollback hello 2</span><br></pre></td></tr></table></figure>
<h4 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 卸载</span><br><span class="line">[root@k8s-master1 ~]# helm list</span><br><span class="line">[root@k8s-master1 ~]# helm uninstall hello</span><br><span class="line">release "hello" uninstalled</span><br></pre></td></tr></table></figure>
<h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 可以打包推送的charts仓库共享别人使用。</span><br><span class="line">[root@k8s-master1 ~]# helm package mychart</span><br><span class="line">Successfully packaged chart and saved it to: /root/mychart-0.1.0.tgz</span><br></pre></td></tr></table></figure>
<h2 id="深入学习-Helm"><a href="#深入学习-Helm" class="headerlink" title="深入学习 Helm"></a>深入学习 Helm</h2><h3 id="Chart-模板"><a href="#Chart-模板" class="headerlink" title="Chart 模板"></a>Chart 模板</h3><ol>
<li>Helm最核心的就是模板，即模板化的K8S manifests文件。</li>
<li>它本质上就是一个Go的template模板。Helm在Go template模板的基础上，还会增加很多东西。</li>
<li>如一些自定义的元数据信息、扩展的库以及一些类似于编程形式的工作流，例如条件语句、管道等等。这些东西都会使得我们的模板变得更加丰富。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# helm create app01</span><br><span class="line">Creating app01</span><br><span class="line">[root@k8s-master1 ~]# cd app01/</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 清除默认生成的模板文件</span><br><span class="line">[root@k8s-master1 templates]# rm -rf *</span><br><span class="line"></span><br><span class="line"># 保留变量</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 创建deployment 和 service</span><br><span class="line">[root@k8s-master1 templates]# kubectl create deployment web --image=nginx:1.16 --dry-run -o yaml &gt; deployment.yaml</span><br><span class="line">[root@k8s-master1 templates]# kubectl apply -f deployment.yaml </span><br><span class="line">[root@k8s-master1 templates]# kubectl expose deployment web --port=80 --target-port=80 --dry-run -o yaml &gt; service.yaml</span><br><span class="line">[root@k8s-master1 templates]# kubectl delete deploy web</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 直接部署</span><br><span class="line">[root@k8s-master1 templates]# kubectl apply -f .</span><br><span class="line">deployment.apps/web created</span><br><span class="line">service/web created</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 templates]# kubectl get pods,svc</span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/db2-mysql-76495946b5-kv76b                1/1     Running   2          7h27m</span><br><span class="line">pod/nfs-client-provisioner-5dd6f66f47-9gb4k   1/1     Running   2          7h31m</span><br><span class="line">pod/web-866f97c649-vrmrm                      1/1     Running   0          5s</span><br><span class="line"></span><br><span class="line">NAME                  TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/db2-mysql     ClusterIP   10.0.0.159   <span class="tag">&lt;<span class="name">none</span>&gt;</span>        3306/TCP   7h27m</span><br><span class="line">service/kubernetes    ClusterIP   10.0.0.1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>        443/TCP    30h</span><br><span class="line">service/metrics-app   ClusterIP   10.0.0.24    <span class="tag">&lt;<span class="name">none</span>&gt;</span>        80/TCP     30h</span><br><span class="line">service/web           ClusterIP   10.0.0.29    <span class="tag">&lt;<span class="name">none</span>&gt;</span>        80/TCP     5s</span><br></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># helm 部署</span></span><br><span class="line">[root@k8s-master1 templates]# helm install app01 /root/app01/</span><br><span class="line">NAME: app01</span><br><span class="line">LAST DEPLOYED: Thu Dec 19 08:00:41 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 templates]# kubectl <span class="builtin-name">get</span> pods,svc</span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-5dd6f66f47-9gb4k   1/1     Running   3          23h</span><br><span class="line">pod/web-866f97c649-b76cr                      1/1     Running   0          5s</span><br><span class="line"></span><br><span class="line">NAME                 <span class="built_in"> TYPE </span>       CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/kubernetes    ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP   47h</span><br><span class="line">service/metrics-app   ClusterIP   10.0.0.24    &lt;none&gt;        80/TCP    46h</span><br><span class="line">service/web           ClusterIP   10.0.0.206   &lt;none&gt;        80/TCP    5s</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 templates]# curl -I 10.0.0.206</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.16.1</span><br><span class="line">Date: Thu, 19 Dec 2019 00:00:54 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Tue, 13 Aug 2019 10:05:00 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">"5d528b4c-264"</span></span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>
<h3 id="动态使用模板"><a href="#动态使用模板" class="headerlink" title="动态使用模板"></a>动态使用模板</h3><h4 id="使用内置对象"><a href="#使用内置对象" class="headerlink" title="使用内置对象"></a>使用内置对象</h4><table>
<thead>
<tr>
<th>Release.Name</th>
<th>release 名称</th>
</tr>
</thead>
<tbody>
<tr>
<td>Release.Name</td>
<td>release 名字</td>
</tr>
<tr>
<td>Release.Namespace</td>
<td>release 命名空间</td>
</tr>
<tr>
<td>Release.Service</td>
<td>release 服务的名称</td>
</tr>
<tr>
<td>Release.Revision</td>
<td>release 修订版本号，从1开始累加</td>
</tr>
</tbody>
</table>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 部署另外的应用 修改标签选择器和镜像名称</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 通过模板渲染</span><br><span class="line">[root@k8s-master1 templates]# vim deployment.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: &#123;&#123; .Chart.name &#125;&#125;                                        # Chart.yaml定义变量</span><br><span class="line">    app: &#123;&#123; .Release.Name &#125;&#125;                                        # 内置变量</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  replicas: &#123;&#123; .Values.replicas  &#125;&#125;                                 # Values.yaml 定义变量 副本数</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: &#123;&#123; .Values.label &#125;&#125;                                      # Pod 标签</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: &#123;&#123; .Values.label &#125;&#125;                                    # Pod 标签</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: &#123;&#123; .Values.image &#125;&#125;:&#123;&#123; .Values.imageTag &#125;&#125;           # 镜像</span><br><span class="line">        name: &#123;&#123; .Release.Name &#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 templates]# vim service.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">    app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    # 匹配POD标签</span><br><span class="line">    app: &#123;&#123; .Values.label &#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 修改 values.yaml 引用变量的值</span><br><span class="line">[root@k8s-master1 app01]# &gt;values.yaml </span><br><span class="line">[root@k8s-master1 app01]# vim values.yaml </span><br><span class="line"></span><br><span class="line">replicas: 3</span><br><span class="line">image: nginx</span><br><span class="line">imageTag: 1.17</span><br><span class="line">label: app01</span><br></pre></td></tr></table></figure>
<h4 id="调试验证"><a href="#调试验证" class="headerlink" title="调试验证"></a>调试验证</h4><ol>
<li>Helm也提供了<code>--dry-run --debug</code>调试参数，帮助你验证模板正确性。</li>
<li>在执行<code>helm install</code>时候带上这两个参数就可以把对应的values值和渲染的资源清单打印出来，而不会真正的去部署一个release。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 app01]# helm install web --dry-run /root/app01/</span><br><span class="line">NAME: web</span><br><span class="line">LAST DEPLOYED: Thu Dec 19 08:44:16 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: pending-install</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">HOOKS:</span><br><span class="line">MANIFEST:</span><br><span class="line">---</span><br><span class="line"># Source: app01/templates/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: app01</span><br><span class="line">    app: web</span><br><span class="line">  name: web</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    # 匹配POD标签</span><br><span class="line">    app: app01</span><br><span class="line">---</span><br><span class="line"># Source: app01/templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: app01</span><br><span class="line">    app: web</span><br><span class="line">  name: web</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: app01</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: app01</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.17</span><br><span class="line">        name: web</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># 执行验证</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 app01]# helm install web /root/app01/</span><br><span class="line">NAME: web</span><br><span class="line">LAST DEPLOYED: Thu Dec 19 08:45:22 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">[root@k8s-master1 app01]# kubectl get pods,svc,ep</span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-5dd6f66f47-9gb4k   1/1     Running   3          24h</span><br><span class="line">pod/web-79dd649678-2q7s9                      1/1     Running   0          5s</span><br><span class="line">pod/web-79dd649678-l95t2                      1/1     Running   0          5s</span><br><span class="line">pod/web-79dd649678-v9tjv                      1/1     Running   0          5s</span><br><span class="line"></span><br><span class="line">NAME                  TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/kubernetes    ClusterIP   10.0.0.1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>        443/TCP   47h</span><br><span class="line">service/web           ClusterIP   10.0.0.98    <span class="tag">&lt;<span class="name">none</span>&gt;</span>        80/TCP    5s</span><br><span class="line"></span><br><span class="line">NAME                       ENDPOINTS                                      AGE</span><br><span class="line">endpoints/kubernetes       172.17.70.251:6443                             47h</span><br><span class="line">endpoints/web              10.244.0.43:80,10.244.1.42:80,10.244.2.52:80   5s</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 app01]# curl -I 10.0.0.98</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.17.6</span><br><span class="line">Date: Thu, 19 Dec 2019 00:47:09 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Tue, 19 Nov 2019 12:50:08 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: "5dd3e500-264"</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># 升级更新</span><br><span class="line">[root@k8s-master1 app01]# vim values.yaml </span><br><span class="line"></span><br><span class="line">replicas: 3</span><br><span class="line">image: nginx</span><br><span class="line">imageTag: 1.16</span><br><span class="line">label: app01</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 app01]# helm upgrade web /root/app01/</span><br><span class="line">Release "web" has been upgraded. Happy Helming!</span><br><span class="line">NAME: web</span><br><span class="line">LAST DEPLOYED: Thu Dec 19 08:48:16 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 2</span><br><span class="line">TEST SUITE: None</span><br><span class="line">[root@k8s-master1 app01]# kubectl get pod,svc,ep</span><br><span class="line">NAME                                          READY   STATUS        RESTARTS   AGE</span><br><span class="line">pod/nfs-client-provisioner-5dd6f66f47-9gb4k   1/1     Running       3          24h</span><br><span class="line">pod/web-559fb69f57-4gsqj                      1/1     Running       0          12s</span><br><span class="line">pod/web-559fb69f57-9hsx2                      1/1     Running       0          14s</span><br><span class="line">pod/web-559fb69f57-ghvls                      1/1     Running       0          11s</span><br><span class="line">pod/web-79dd649678-l95t2                      0/1     Terminating   0          3m7s</span><br><span class="line"></span><br><span class="line">NAME                  TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/kubernetes    ClusterIP   10.0.0.1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>        443/TCP   47h</span><br><span class="line">service/metrics-app   ClusterIP   10.0.0.24    <span class="tag">&lt;<span class="name">none</span>&gt;</span>        80/TCP    47h</span><br><span class="line">service/web           ClusterIP   10.0.0.98    <span class="tag">&lt;<span class="name">none</span>&gt;</span>        80/TCP    3m7s</span><br><span class="line"></span><br><span class="line">NAME                       ENDPOINTS                                      AGE</span><br><span class="line">endpoints/kubernetes       172.17.70.251:6443                             47h</span><br><span class="line">endpoints/web              10.244.0.44:80,10.244.1.43:80,10.244.2.53:80   3m7s   # 一组新的pod</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 app01]# curl -I 10.0.0.98</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.16.1                                                             # 镜像版本变化</span><br><span class="line">Date: Thu, 19 Dec 2019 00:48:38 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 612</span><br><span class="line">Last-Modified: Tue, 13 Aug 2019 10:05:00 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: "5d528b4c-264"</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>
<h4 id="使用通用模板-创建新的POD"><a href="#使用通用模板-创建新的POD" class="headerlink" title="使用通用模板 创建新的POD"></a>使用通用模板 创建新的POD</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 app01]# vim values.yaml </span><br><span class="line"></span><br><span class="line">replicas: 1</span><br><span class="line">image: lizhenliang/java-demo</span><br><span class="line">imageTag: latest</span><br><span class="line">label: java-demo</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 app01]# helm install java-demo /root/app01/</span><br><span class="line">NAME: java-demo</span><br><span class="line">LAST DEPLOYED: Thu Dec 19 08:57:34 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 app01]# helm install java-demo /root/app01/</span><br><span class="line">NAME: java-demo</span><br><span class="line">LAST DEPLOYED: Thu Dec 19 08:57:34 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">[root@k8s-master1 app01]# kubectl get pods,svc,ep</span><br><span class="line">NAME                                          READY   STATUS              RESTARTS   AGE</span><br><span class="line">pod/java-demo-89485b486-gfnzd                 0/1     ContainerCreating   0          12s</span><br><span class="line">pod/nfs-client-provisioner-5dd6f66f47-9gb4k   1/1     Running             3          24h</span><br><span class="line">pod/web-559fb69f57-4gsqj                      1/1     Running             0          9m28s</span><br><span class="line">pod/web-559fb69f57-9hsx2                      1/1     Running             0          9m30s</span><br><span class="line">pod/web-559fb69f57-ghvls                      1/1     Running             0          9m27s</span><br><span class="line"></span><br><span class="line">NAME                  TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/java-demo     ClusterIP   10.0.0.118   <span class="tag">&lt;<span class="name">none</span>&gt;</span>        80/TCP    12s</span><br><span class="line">service/kubernetes    ClusterIP   10.0.0.1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>        443/TCP   47h</span><br><span class="line">service/metrics-app   ClusterIP   10.0.0.24    <span class="tag">&lt;<span class="name">none</span>&gt;</span>        80/TCP    47h</span><br><span class="line">service/web           ClusterIP   10.0.0.98    <span class="tag">&lt;<span class="name">none</span>&gt;</span>        80/TCP    12m</span><br><span class="line"></span><br><span class="line">NAME                       ENDPOINTS                                      AGE</span><br><span class="line">endpoints/kubernetes       172.17.70.251:6443                             47h</span><br><span class="line">endpoints/web              10.244.0.44:80,10.244.1.43:80,10.244.2.53:80   12m</span><br></pre></td></tr></table></figure>
<h3 id="Values"><a href="#Values" class="headerlink" title="Values"></a>Values</h3><ol>
<li>Values对象是为Chart模板提供值，这个对象的值有4个来源：<ul>
<li>chart 包中的 values.yaml 文件</li>
<li>父 chart 包的 values.yaml 文件</li>
<li>通过 helm install 或者 helm upgrade 的 <code>-f</code>或者 <code>--values</code>参数传入的自定义的 yaml 文件</li>
<li>通过 <code>--set</code> 参数传入的值</li>
</ul>
</li>
</ol>
<ol start="2">
<li>chart 的 values.yaml 提供的值可以被用户提供的 values 文件覆盖，而该文件同样可以被 <code>--set</code>提供的参数所覆盖。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 通过set传值创建</span><br><span class="line">[root@k8s-master1 app01]# helm install web3 --set replicas=1 /root/app01/</span><br></pre></td></tr></table></figure>
<h3 id="管道与函数"><a href="#管道与函数" class="headerlink" title="管道与函数"></a>管道与函数</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># quote 函数增加双引号</span><br><span class="line">chart: &#123;&#123; quote .Chart.Name &#125;&#125;   # 将后面的值作为参数传递给quote函数。</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 templates]# helm install web05 --dry-run /root/app01/</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: "app01"</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># default 默认值</span><br><span class="line"># default函数，该函数允许在模板中指定默认值，以防止该值被忽略掉。</span><br><span class="line"># 例如忘记定义，执行helm install 会因为缺少字段无法创建资源，这时就可以定义一个默认值。</span><br><span class="line"># 如果values.yaml里面test存在,则会使用模板文件中的值</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 templates]# vim deployment.yaml </span><br><span class="line">...</span><br><span class="line">      app: &#123;&#123; quote .Values.label &#125;&#125;</span><br><span class="line">      test: &#123;&#123; default "hello" .Values.test &#125;&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 templates]# helm install web05 --dry-run /root/app01/</span><br><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: "java-demo"</span><br><span class="line">      test: hello</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>其他函数：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">缩进：&#123;&#123; .Values.resources | indent 12 &#125;&#125;</span><br><span class="line">大写：&#123;&#123; upper .Values.resources &#125;&#125;</span><br><span class="line">首字母大写：&#123;&#123; title .Values.resources &#125;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h3><p>Helm模板语言提供以下流程控制语句：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 满足更复杂的数据逻辑处理 </span><br><span class="line">if/else     条件块</span><br><span class="line">with        指定范围</span><br><span class="line">range       循环块</span><br></pre></td></tr></table></figure>
<h4 id="if-…-else"><a href="#if-…-else" class="headerlink" title="if … else"></a>if … else</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 templates]# vim deployment.yaml </span><br><span class="line"># 如果 test = “k8s” 那么 devops的值就是123</span><br><span class="line"># 判断会留下空行,需要去除</span><br><span class="line">spec:</span><br><span class="line">  replicas: &#123;&#123; .Values.replicas  &#125;&#125;</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: &#123;&#123; quote .Values.label &#125;&#125;</span><br><span class="line">      test: &#123;&#123; default "hello" .Values.test &#125;&#125;</span><br><span class="line">      &#123;&#123; if eq .Values.test "k8s"&#125;&#125;</span><br><span class="line">      devops: 123</span><br><span class="line">      &#123;&#123; else &#125;&#125;</span><br><span class="line">      devops: 456</span><br><span class="line">      &#123;&#123; end &#125;&#125;</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 templates]# helm install web05 --dry-run /root/app01/</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: "java-demo"</span><br><span class="line">      test: k8s</span><br><span class="line">       </span><br><span class="line">      devops: 123</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># 去除空行 加上 - </span><br><span class="line">[root@k8s-master1 templates]# vim deployment.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: &#123;&#123; quote .Chart.Name &#125;&#125;</span><br><span class="line">    app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  replicas: &#123;&#123; .Values.replicas  &#125;&#125;</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: &#123;&#123; quote .Values.label &#125;&#125;</span><br><span class="line">      test: &#123;&#123; default "hello" .Values.test &#125;&#125;</span><br><span class="line">      &#123;&#123;- if eq .Values.test "k8s"&#125;&#125;</span><br><span class="line">      devops: 123</span><br><span class="line">      &#123;&#123;- else &#125;&#125;</span><br><span class="line">      devops: 456</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: &#123;&#123; .Values.label &#125;&#125;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: &#123;&#123; .Values.image &#125;&#125;:&#123;&#123; .Values.imageTag &#125;&#125;</span><br><span class="line">        name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master1 templates]# helm install web05 --dry-run /root/app01/</span><br><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: "java-demo"</span><br><span class="line">      test: k8s </span><br><span class="line">      devops: 123 </span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: java-demo</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: lizhenliang/java-demo:latest</span><br><span class="line">        name: web05</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="修改回实例变量"><a href="#修改回实例变量" class="headerlink" title="修改回实例变量"></a>修改回实例变量</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 使用默认模板</span><br><span class="line">[root@k8s-master1 app01]# cp values.yaml values.yaml_bak </span><br><span class="line">[root@k8s-master1 ~]# helm create /root/app02</span><br><span class="line">[root@k8s-master1 app01]# cp /root/app02/values.yaml .</span><br><span class="line">cp: overwrite ‘./values.yaml’? y</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 app01]# vim values.yaml</span><br><span class="line"></span><br><span class="line">replicaCount: 1</span><br><span class="line"></span><br><span class="line">image:</span><br><span class="line">  repository: nginx</span><br><span class="line">  tag: 1.16</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># 修改deployment和service文件的变量引用</span><br><span class="line">[root@k8s-master1 app01]# vim templates/deployment.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">    app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  replicas: &#123;&#123; .Values.replicaCount  &#125;&#125;</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">      app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">        app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: &#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag &#125;&#125;</span><br><span class="line">        name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 app01]# vim templates/service.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">    app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    # 匹配POD标签</span><br><span class="line">    app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">    chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"># 测试 </span><br><span class="line">[root@k8s-master1 app01]# helm install web05 --dry-run /root/app01/</span><br><span class="line">NAME: web05</span><br><span class="line">LAST DEPLOYED: Thu Dec 19 10:44:59 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: pending-install</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">HOOKS:</span><br><span class="line">MANIFEST:</span><br><span class="line">---</span><br><span class="line"># Source: app01/templates/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: app01</span><br><span class="line">    app: web05</span><br><span class="line">  name: web05</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    # 匹配POD标签</span><br><span class="line">    app: web05</span><br><span class="line">    chart: app01</span><br><span class="line">---</span><br><span class="line"># Source: app01/templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: app01</span><br><span class="line">    app: web05</span><br><span class="line">  name: web05</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      chart: app01</span><br><span class="line">      app: web05</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        chart: app01</span><br><span class="line">        app: web05</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.16</span><br><span class="line">        name: web05</span><br></pre></td></tr></table></figure>
<h4 id="资源限制判断"><a href="#资源限制判断" class="headerlink" title="资源限制判断"></a>资源限制判断</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 修改 values 增加资源限制</span><br><span class="line">resources:</span><br><span class="line">  limits:</span><br><span class="line">    cpu: 100m</span><br><span class="line">    memory: 128Mi</span><br><span class="line">  # requests:</span><br><span class="line">  #   cpu: 100m</span><br><span class="line">  #   memory: 128Mi</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 修改 deployment </span><br><span class="line"># 加上条件判断,如果values没有资源的值 就使用&#123;&#125;空 如果有就使用 </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 app01]# vim templates/deployment.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">    app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  replicas: &#123;&#123; .Values.replicaCount  &#125;&#125;</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">      app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">        app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: &#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag &#125;&#125;</span><br><span class="line">        name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">        &#123;&#123;- if .Values.resources &#125;&#125;</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: &#123;&#123; .Values.resources.limits.cpu &#125;&#125;</span><br><span class="line">            memory: &#123;&#123; .Values.resources.limits.memory &#125;&#125;</span><br><span class="line">        &#123;&#123;- else &#125;&#125;</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">        &#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 app01]# helm install web05 --dry-run /root/app01/</span><br><span class="line">NAME: web05</span><br><span class="line">LAST DEPLOYED: Thu Dec 19 11:07:36 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: pending-install</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">HOOKS:</span><br><span class="line">MANIFEST:</span><br><span class="line">---</span><br><span class="line"># Source: app01/templates/service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: app01</span><br><span class="line">    app: web05</span><br><span class="line">  name: web05</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    # 匹配POD标签</span><br><span class="line">    app: web05</span><br><span class="line">    chart: app01</span><br><span class="line">---</span><br><span class="line"># Source: app01/templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: app01</span><br><span class="line">    app: web05</span><br><span class="line">  name: web05</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      chart: app01</span><br><span class="line">      app: web05</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        chart: app01</span><br><span class="line">        app: web05</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.16</span><br><span class="line">        name: web05</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 128Mi</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 app01]# kubectl get pods -o wide </span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE    IP            NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">web05-6bcbfb5fdc-7fwn2                    1/1     Running   0          81s    10.244.0.45   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master1 app01]# kubectl describe node k8s-master1</span><br><span class="line">...</span><br><span class="line">  Namespace                  Name                                       CPU Requests  CPU Limits  Memory Requests  Memory Limits  AGE</span><br><span class="line">  ---------                  ----                                       ------------  ----------  ---------------  -------------  ---</span><br><span class="line">  default                    web05-6bcbfb5fdc-7fwn2                     100m (5%)     100m (5%)   128Mi (7%)       128Mi (7%)     42s</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="设置开关"><a href="#设置开关" class="headerlink" title="设置开关"></a>设置开关</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 设置开关 判断 enable: false | true</span><br><span class="line">resources:</span><br><span class="line">  enable: false</span><br><span class="line">  limits:</span><br><span class="line">    cpu: 100m</span><br><span class="line">    memory: 128Mi</span><br><span class="line">  # requests:</span><br><span class="line">  #   cpu: 100m</span><br><span class="line">  #   memory: 128Mi</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 app01]# vim templates/deployment.yaml </span><br><span class="line"></span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: &#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag &#125;&#125;</span><br><span class="line">        name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">        &#123;&#123;- if .Values.resources.enable &#125;&#125;</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: &#123;&#123; .Values.resources.limits.cpu &#125;&#125;</span><br><span class="line">            memory: &#123;&#123; .Values.resources.limits.memory &#125;&#125;</span><br><span class="line">        &#123;&#123;- else &#125;&#125;</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">        &#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ingress-开关"><a href="#ingress-开关" class="headerlink" title="ingress 开关"></a>ingress 开关</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># 如果Values存在ingress 就进行资源配置 否则不进行</span><br><span class="line">[root@k8s-master1 templates]# vim ingress.yaml</span><br><span class="line"></span><br><span class="line">&#123;&#123;- if .Values.ingress.enabled &#125;&#125;</span><br><span class="line"># 如果Values存在 ingress 就要配置 资源文件</span><br><span class="line"></span><br><span class="line">apiVersion: networking.k8s.io/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: test-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target: /</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /testpath</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: test</span><br><span class="line">          servicePort: 80</span><br><span class="line"></span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 app01]# vim values.yaml</span><br><span class="line">...</span><br><span class="line">ingress:</span><br><span class="line">  enabled: false</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">    # kubernetes.io/ingress.class: nginx</span><br><span class="line">    # kubernetes.io/tls-acme: "true"</span><br><span class="line">  hosts:</span><br><span class="line">    - host: chart-example.local</span><br><span class="line">      paths: []</span><br><span class="line">  tls: []</span><br><span class="line">  #  - secretName: chart-example-tls</span><br><span class="line">  #    hosts:</span><br><span class="line">  #      - chart-example.local</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_98.png" width="50%"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 启用 如果是false则不会创建</span><br><span class="line">ingress:</span><br><span class="line">  enabled: true</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_99.png" width="50%"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 app01]# helm install web /root/app01/</span><br><span class="line">NAME: web</span><br><span class="line">LAST DEPLOYED: Thu Dec 19 11:39:30 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 app01]# kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner-5dd6f66f47-9gb4k   1/1     Running   3          27h</span><br><span class="line">web-944f58c9c-n2nw9                       1/1     Running   0          14s</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 app01]# kubectl get ingress</span><br><span class="line">NAME           HOSTS   ADDRESS   PORTS   AGE</span><br><span class="line">test-ingress   *                 80      43s</span><br></pre></td></tr></table></figure>
<h3 id="with-控制变量作用域"><a href="#with-控制变量作用域" class="headerlink" title="with 控制变量作用域"></a>with 控制变量作用域</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 app01]# vim values.yaml</span><br><span class="line"></span><br><span class="line">nodeSelector: </span><br><span class="line">  # node 标签</span><br><span class="line">  team: a</span><br><span class="line">  gpu: ok</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"># 正常写法</span><br><span class="line">[root@k8s-master1 ~]# vim /root/app01/templates/deployment.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">    app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">spec:</span><br><span class="line">  replicas: &#123;&#123; .Values.replicaCount  &#125;&#125;</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">      app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">        app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      &#123;&#123; if .Values.nodeSelector &#125;&#125;</span><br><span class="line">      nodeSelector:</span><br><span class="line">        team: &#123;&#123; .Values.nodeSelector.team &#125;&#125;</span><br><span class="line">        gpu: &#123;&#123; .Values.nodeSelector.gpu &#125;&#125;</span><br><span class="line">      &#123;&#123; end &#125;&#125;</span><br><span class="line">      - image: &#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag &#125;&#125;</span><br><span class="line">        name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">        &#123;&#123;- if .Values.resources.enable &#125;&#125;</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: &#123;&#123; .Values.resources.limits.cpu &#125;&#125;</span><br><span class="line">            memory: &#123;&#123; .Values.resources.limits.memory &#125;&#125;</span><br><span class="line">        &#123;&#123;- else &#125;&#125;</span><br><span class="line">        resources: &#123;&#125;</span><br><span class="line">        &#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 app01]# helm install web05 --dry-run /root/app01/</span><br><span class="line">...</span><br><span class="line"># Source: app01/templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: app01</span><br><span class="line">    app: web05</span><br><span class="line">  name: web05</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      chart: app01</span><br><span class="line">      app: web05</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        chart: app01</span><br><span class="line">        app: web05</span><br><span class="line">    spec:</span><br><span class="line">      nodeSelector:</span><br><span class="line">        team: a</span><br><span class="line">        gpu: true</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.16</span><br><span class="line">        name: web05</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 128Mi</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 使用 with </span><br><span class="line"># 值会被取出</span><br><span class="line">    spec:</span><br><span class="line">      &#123;&#123;- with .Values.nodeSelector &#125;&#125;</span><br><span class="line">      nodeSelector:</span><br><span class="line">        team: &#123;&#123; .team &#125;&#125;</span><br><span class="line">        gpu: &#123;&#123; .gpu &#125;&#125;</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    spec:</span><br><span class="line">      nodeSelector:</span><br><span class="line">        team: a</span><br><span class="line">        gpu: ok</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># with + toYaml + 缩进</span><br><span class="line"># 先看有多少个 空格  </span><br><span class="line"># | nindent 8 缩进8个空格并且换行 不加n不换行</span><br><span class="line"></span><br><span class="line">    spec:</span><br><span class="line">      &#123;&#123;- with .Values.nodeSelector &#125;&#125;</span><br><span class="line">      nodeSelector:</span><br><span class="line">        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="range-循环"><a href="#range-循环" class="headerlink" title="range 循环"></a>range 循环</h3><ol>
<li>在 Helm 模板语言中，使用 <code>range</code>关键字来进行循环操作。</li>
<li>循环内部我们使用的是一个 <code>.</code>，这是因为当前的作用域就在当前循环内，这个 <code>.</code>引用的当前读取的元素。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">test:</span><br><span class="line"> - 1</span><br><span class="line"> - 2</span><br><span class="line"> - 3</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Source: app01/templates/configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: web05</span><br><span class="line">data:</span><br><span class="line">  test: |</span><br><span class="line">    1</span><br><span class="line">    2</span><br><span class="line">    3</span><br></pre></td></tr></table></figure>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><ol>
<li>在with中使用内置变量</li>
<li>直接使用$引用</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 在with里面引用内置变量会报错 找不到</span><br><span class="line">    spec:</span><br><span class="line">      &#123;&#123;- with .Values.nodeSelector &#125;&#125;</span><br><span class="line">      nodeSelector:</span><br><span class="line">        app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 使用$引用内置变量</span><br><span class="line">    spec:</span><br><span class="line">      &#123;&#123;- with .Values.nodeSelector &#125;&#125;</span><br><span class="line">      nodeSelector:</span><br><span class="line">        app: &#123;&#123; $.Release.Name &#125;&#125;</span><br><span class="line">        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">      nodeSelector:</span><br><span class="line">        app: web05</span><br><span class="line">        gpu: ok</span><br><span class="line">        team: a</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 在with上面定义变量</span><br><span class="line">    spec:</span><br><span class="line">      &#123;&#123;- $releaseName := .Release.Name -&#125;&#125;</span><br><span class="line">      &#123;&#123;- with .Values.nodeSelector &#125;&#125;</span><br><span class="line">      nodeSelector:</span><br><span class="line">        app: &#123;&#123; $releaseName &#125;&#125;</span><br><span class="line">        &#123;&#123;- toYaml . | nindent 8 &#125;&#125;</span><br><span class="line">      &#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># range 使用变量 </span><br><span class="line"># 正常使用</span><br><span class="line">      containers:</span><br><span class="line">      - image: &#123;&#123; .Values.image.repository &#125;&#125;:&#123;&#123; .Values.image.tag &#125;&#125;</span><br><span class="line">        name: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">        env:</span><br><span class="line">        - name: TEST</span><br><span class="line">          value: 123</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 引用变量 错误引用</span><br><span class="line">        &#123;&#123;- range .Values.env &#125;&#125;</span><br><span class="line">        env:</span><br><span class="line">        - name: &#123;&#123; . &#125;&#125;</span><br><span class="line">          value: &#123;&#123; . &#125;&#125;</span><br><span class="line">        &#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">        env:</span><br><span class="line">        - name: -Xmx1g</span><br><span class="line">          value: -Xmx1g</span><br><span class="line">        env:</span><br><span class="line">        - name: JAVA</span><br><span class="line">          value: JAVA</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 正确引用</span><br><span class="line">        env:</span><br><span class="line">        &#123;&#123;- range $key,$val := .Values.env &#125;&#125;</span><br><span class="line">        - name: &#123;&#123; $key &#125;&#125;</span><br><span class="line">          value: &#123;&#123; $val &#125;&#125;</span><br><span class="line">        &#123;&#123;- end &#125;&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">        env:</span><br><span class="line">        - name: JAVA_OPTS</span><br><span class="line">          value: -Xmx1g</span><br><span class="line">        - name: NAME</span><br><span class="line">          value: JAVA</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="命名模板"><a href="#命名模板" class="headerlink" title="命名模板"></a>命名模板</h3><ol>
<li>命名模板：使用define定义，template引入，在templates目录中默认下划线_开头的文件为公共模板(_helpers.tpl)</li>
<li>重复使用的代码块 放到命名模板</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 定义</span><br><span class="line">[root@k8s-master1 templates]# vim _helpers.tpl</span><br><span class="line"></span><br><span class="line">&#123;&#123;- define "name" -&#125;&#125;</span><br><span class="line">&#123;&#123;- .Chart.Name -&#125;&#125;-&#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 引用 </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    chart: &#123;&#123; .Chart.Name &#125;&#125;</span><br><span class="line">    app: &#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">  name: &#123;&#123; template "name" . &#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># include 支持函数处理 </span><br><span class="line"># 模板里面定投写  在引用的时候缩进空格</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 templates]# vim _helpers.tpl </span><br><span class="line"></span><br><span class="line">&#123;&#123;- define "name" -&#125;&#125;</span><br><span class="line">&#123;&#123;- .Chart.Name -&#125;&#125;-&#123;&#123; .Release.Name &#125;&#125;</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;- define "labels" -&#125;&#125;</span><br><span class="line">app: &#123;&#123; template "name" . &#125;&#125;</span><br><span class="line">chart: "&#123;&#123; .Chart.Name &#125;&#125;-&#123;&#123; .Chart.Version &#125;&#125;"</span><br><span class="line">release: "&#123;&#123; .Release.Name &#125;&#125;"</span><br><span class="line">&#123;&#123;- end -&#125;&#125;</span><br><span class="line"></span><br><span class="line"># 引入</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    &#123;&#123;- include "labels" . | nindent 4 &#125;&#125;</span><br><span class="line">  name: &#123;&#123; template "name" . &#125;&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 结果</span><br><span class="line">...</span><br><span class="line"># Source: app01/templates/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: app01-web05</span><br><span class="line">    chart: "app01-0.1.0"</span><br><span class="line">    release: "web05"</span><br><span class="line">  name: app01-web05</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="开发自己的-Chart-Java应用实例"><a href="#开发自己的-Chart-Java应用实例" class="headerlink" title="开发自己的 Chart Java应用实例"></a>开发自己的 Chart Java应用实例</h2><ol>
<li>先创建模板</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm create demo</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>修改Chart.yaml，Values.yaml，添加常用的变量</li>
<li>在templates目录下创建部署镜像所需要的yaml文件，并变量引用yaml里经常变动的字段</li>
</ol>
<h3 id="创建模板目录"><a href="#创建模板目录" class="headerlink" title="创建模板目录"></a>创建模板目录</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 opt]# cd /opt/</span><br><span class="line">[root@k8s-master1 opt]# helm create demo</span><br><span class="line">Creating demo</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# cd /opt/demo/</span><br><span class="line">[root@k8s-master1 demo]# mkdir bak</span><br><span class="line">[root@k8s-master1 demo]# cp Chart.yaml values.yaml bak/</span><br><span class="line"></span><br><span class="line"># 清理文件注释</span><br><span class="line">[root@k8s-master1 demo]# egrep -v '#|^$' /opt/demo/bak/Chart.yaml &gt; Chart.yaml</span><br></pre></td></tr></table></figure>
<h4 id="修改-Chart-yaml"><a href="#修改-Chart-yaml" class="headerlink" title="修改 Chart.yaml"></a>修改 Chart.yaml</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# vim Chart.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: v2</span><br><span class="line">name: demo</span><br><span class="line">description: My java demo</span><br><span class="line">type: application</span><br><span class="line"># chart 版本</span><br><span class="line">version: 0.1.0</span><br><span class="line"># app 版本</span><br><span class="line">appVersion: 1.16.0</span><br></pre></td></tr></table></figure>
<h4 id="修改-Values-yaml"><a href="#修改-Values-yaml" class="headerlink" title="修改 Values.yaml"></a>修改 Values.yaml</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># 只保留用到的变量 </span><br><span class="line">[root@k8s-master1 demo]# vim values.yaml </span><br><span class="line"></span><br><span class="line"># Default values for demo.</span><br><span class="line"># This is a YAML-formatted file.</span><br><span class="line"># Declare variables to be passed into your templates.</span><br><span class="line"></span><br><span class="line">replicaCount: 1</span><br><span class="line"></span><br><span class="line">image:</span><br><span class="line">  repository: nginx</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">imagePullSecrets: []</span><br><span class="line"></span><br><span class="line">service:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  port: 80</span><br><span class="line"></span><br><span class="line">ingress:</span><br><span class="line">  enabled: false</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">    # kubernetes.io/ingress.class: nginx</span><br><span class="line">    # kubernetes.io/tls-acme: "true"</span><br><span class="line">  hosts:</span><br><span class="line">    - host: chart-example.local</span><br><span class="line">      paths: []</span><br><span class="line">  tls: []</span><br><span class="line">  #  - secretName: chart-example-tls</span><br><span class="line">  #    hosts:</span><br><span class="line">  #      - chart-example.local</span><br><span class="line"></span><br><span class="line">resources: &#123;&#125;</span><br><span class="line">  # limits:</span><br><span class="line">  #   cpu: 100m</span><br><span class="line">  #   memory: 128Mi</span><br><span class="line">  # requests:</span><br><span class="line">  #   cpu: 100m</span><br><span class="line">  #   memory: 128Mi</span><br><span class="line"></span><br><span class="line">nodeSelector: &#123;&#125;</span><br><span class="line"></span><br><span class="line">tolerations: []</span><br></pre></td></tr></table></figure>
<h3 id="准备应用-yaml-文件"><a href="#准备应用-yaml-文件" class="headerlink" title="准备应用 yaml 文件"></a>准备应用 yaml 文件</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 templates]# rm -rf tests/</span><br><span class="line">[root@k8s-master1 templates]# rm -rf serviceaccount.yaml </span><br><span class="line">[root@k8s-master1 templates]# ls</span><br><span class="line">deployment.yaml  _helpers.tpl  ingress.yaml  NOTES.txt  service.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 三个公共模板</span><br><span class="line"># _helpers.tpl 公共模板 service deploy ingress 都会用到 </span><br><span class="line">name: &#123;&#123; include "demo.fullname" . &#125;&#125;</span><br><span class="line"></span><br><span class="line"># deploy 标签</span><br><span class="line">&#123;&#123;- include "demo.labels" . | nindent 4 &#125;&#125;</span><br><span class="line"></span><br><span class="line">#  标签选择器 service.selector 一致</span><br><span class="line">&#123;&#123;- include "demo.selectorLabels" . | nindent 8 &#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 打包</span><br><span class="line">[root@k8s-master1 opt]# helm package demo/</span><br><span class="line"></span><br><span class="line"># 再启动一个</span><br><span class="line">[root@k8s-master1 opt]# cp demo/values.yaml ./</span><br><span class="line">[root@k8s-master1 opt]# helm install web2 -f values.yaml demo-0.1.0.tgz</span><br></pre></td></tr></table></figure>
<h2 id="使用-Harbor-作为-Chart-仓库"><a href="#使用-Harbor-作为-Chart-仓库" class="headerlink" title="使用 Harbor 作为 Chart 仓库"></a>使用 Harbor 作为 Chart 仓库</h2>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/06/k8s-base06/" rel="next" title="04 k8s 弹性伸缩">
                <i class="fa fa-chevron-left"></i> 04 k8s 弹性伸缩
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/06/k8s-base08/" rel="prev" title="06 K8S 集群网络">
                06 K8S 集群网络 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/Greeen.jpg" alt="Harris Li">
            
              <p class="site-author-name" itemprop="name">Harris Li</p>
              <p class="site-description motion-element" itemprop="description">Beijing</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">119</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么需要-Helm？"><span class="nav-number">1.</span> <span class="nav-text">为什么需要 Helm？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Helm-介绍"><span class="nav-number">2.</span> <span class="nav-text">Helm 介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Helm-v3-变化"><span class="nav-number">3.</span> <span class="nav-text">Helm v3 变化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#架构变化"><span class="nav-number">3.1.</span> <span class="nav-text">架构变化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Helm-客户端"><span class="nav-number">4.</span> <span class="nav-text">Helm 客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#部署-Helm-客户端"><span class="nav-number">4.1.</span> <span class="nav-text">部署 Helm 客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Helm-常用命令"><span class="nav-number">4.2.</span> <span class="nav-text">Helm 常用命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置国内-Chart-仓库"><span class="nav-number">4.3.</span> <span class="nav-text">配置国内 Chart 仓库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加多个仓库"><span class="nav-number">4.4.</span> <span class="nav-text">添加多个仓库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除存储库"><span class="nav-number">4.5.</span> <span class="nav-text">删除存储库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Helm-基本使用"><span class="nav-number">5.</span> <span class="nav-text">Helm 基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-chart-部署一个应用"><span class="nav-number">5.1.</span> <span class="nav-text">使用 chart 部署一个应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#查看状态"><span class="nav-number">5.1.1.</span> <span class="nav-text">查看状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建-pv"><span class="nav-number">5.1.2.</span> <span class="nav-text">创建 pv</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#登录测试"><span class="nav-number">5.1.3.</span> <span class="nav-text">登录测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用自己的-nfs-pv自动供给"><span class="nav-number">5.2.</span> <span class="nav-text">使用自己的 nfs pv自动供给</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#values-使用"><span class="nav-number">5.2.1.</span> <span class="nav-text">values 使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#set-使用"><span class="nav-number">5.2.2.</span> <span class="nav-text">set 使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#拉取整个chart包"><span class="nav-number">5.2.3.</span> <span class="nav-text">拉取整个chart包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#helm-install-命令可以从多个来源安装"><span class="nav-number">5.2.4.</span> <span class="nav-text">helm install 命令可以从多个来源安装</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#构建一个-Helm-Chart"><span class="nav-number">6.</span> <span class="nav-text">构建一个 Helm Chart</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自动生成目录"><span class="nav-number">6.1.</span> <span class="nav-text">自动生成目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简单制作一个-chart"><span class="nav-number">6.2.</span> <span class="nav-text">简单制作一个 chart</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建"><span class="nav-number">6.2.1.</span> <span class="nav-text">创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模板"><span class="nav-number">6.2.2.</span> <span class="nav-text">模板</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#升级"><span class="nav-number">6.2.3.</span> <span class="nav-text">升级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#回滚"><span class="nav-number">6.2.4.</span> <span class="nav-text">回滚</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#卸载"><span class="nav-number">6.2.5.</span> <span class="nav-text">卸载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#打包"><span class="nav-number">6.2.6.</span> <span class="nav-text">打包</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#深入学习-Helm"><span class="nav-number">7.</span> <span class="nav-text">深入学习 Helm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Chart-模板"><span class="nav-number">7.1.</span> <span class="nav-text">Chart 模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态使用模板"><span class="nav-number">7.2.</span> <span class="nav-text">动态使用模板</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用内置对象"><span class="nav-number">7.2.1.</span> <span class="nav-text">使用内置对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#调试验证"><span class="nav-number">7.2.2.</span> <span class="nav-text">调试验证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用通用模板-创建新的POD"><span class="nav-number">7.2.3.</span> <span class="nav-text">使用通用模板 创建新的POD</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Values"><span class="nav-number">7.3.</span> <span class="nav-text">Values</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#管道与函数"><span class="nav-number">7.4.</span> <span class="nav-text">管道与函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#流程控制"><span class="nav-number">7.5.</span> <span class="nav-text">流程控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#if-…-else"><span class="nav-number">7.5.1.</span> <span class="nav-text">if … else</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改回实例变量"><span class="nav-number">7.5.2.</span> <span class="nav-text">修改回实例变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#资源限制判断"><span class="nav-number">7.5.3.</span> <span class="nav-text">资源限制判断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置开关"><span class="nav-number">7.5.4.</span> <span class="nav-text">设置开关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ingress-开关"><span class="nav-number">7.5.5.</span> <span class="nav-text">ingress 开关</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#with-控制变量作用域"><span class="nav-number">7.6.</span> <span class="nav-text">with 控制变量作用域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#range-循环"><span class="nav-number">7.7.</span> <span class="nav-text">range 循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#变量"><span class="nav-number">7.8.</span> <span class="nav-text">变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#命名模板"><span class="nav-number">7.9.</span> <span class="nav-text">命名模板</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开发自己的-Chart-Java应用实例"><span class="nav-number">8.</span> <span class="nav-text">开发自己的 Chart Java应用实例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建模板目录"><span class="nav-number">8.1.</span> <span class="nav-text">创建模板目录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-Chart-yaml"><span class="nav-number">8.1.1.</span> <span class="nav-text">修改 Chart.yaml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-Values-yaml"><span class="nav-number">8.1.2.</span> <span class="nav-text">修改 Values.yaml</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备应用-yaml-文件"><span class="nav-number">8.2.</span> <span class="nav-text">准备应用 yaml 文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用-Harbor-作为-Chart-仓库"><span class="nav-number">9.</span> <span class="nav-text">使用 Harbor 作为 Chart 仓库</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Harris Li</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
