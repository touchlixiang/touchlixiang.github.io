<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="k8s,">










<meta name="keywords" content="k8s">
<meta property="og:type" content="article">
<meta property="og:title" content="06 K8S 集群网络">
<meta property="og:url" content="https://touchlixiang.github.io/2019/12/06/k8s-base08/index.html">
<meta property="og:site_name" content="My Notes">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://touchlixiang.github.io/img/mix_3.jpg">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_347.jpeg">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_346.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_349.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_348.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_350.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_351.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_352.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_354.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_355.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_356.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_357.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_358.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_366.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_367.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_359.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_360.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_361.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_362.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_368.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_364.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_365.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_370.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_369.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_371.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_372.png">
<meta property="og:updated_time" content="2020-01-13T09:43:10.359Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="06 K8S 集群网络">
<meta name="twitter:image" content="https://touchlixiang.github.io/img/mix_3.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://touchlixiang.github.io/2019/12/06/k8s-base08/">





  <title>06 K8S 集群网络 | My Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">My Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记不住的一定要写在这里</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://touchlixiang.github.io/2019/12/06/k8s-base08/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Harris Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/Greeen.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">06 K8S 集群网络</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-06T17:14:00+08:00">
                2019-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="/img/mix_3.jpg" width="50%"><br><a id="more"></a></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 查看cni网桥的接入</span><br><span class="line">[root@k8s-master1 opt]# yum install bridge-utils -y</span><br><span class="line">[root@k8s-node2 ~]# brctl show cni0</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">cni0		8000.b6051fb07b10	no		veth1938bf5f</span><br><span class="line">							veth70d9e02c</span><br><span class="line">							vethcc33255a</span><br><span class="line">							vethce666639</span><br><span class="line"></span><br><span class="line"># docker 网桥</span><br><span class="line">[root@k8s-node2 ~]# brctl show docker0</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">docker0		8000.0242c8d4d7fe	no</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 网络插件 就是解决跨主机node上的pod通信</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># kubelet 创建 容器</span><br><span class="line">kubelet -&gt; dockerapi (dockershim) </span><br><span class="line"></span><br><span class="line"># pod的形成 </span><br><span class="line">kubelet -&gt; dockerapi -&gt; 容器1</span><br><span class="line">kubelet -&gt; 二进制文件 -&gt; 网络配置 -&gt; 容器1</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cni 网络规范:</span><br><span class="line"># 接入 第三方网络插件</span><br><span class="line"># kubelet 去调用网络插件 为容器 创建 网络</span><br><span class="line"># 实现解耦,可以接入任何网络组建</span><br></pre></td></tr></table></figure>
<h2 id="交换和路由"><a href="#交换和路由" class="headerlink" title="交换和路由"></a>交换和路由</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 两个问题: </span></span><br><span class="line"><span class="bullet">1. </span>一个局域网内,主机A 和 主机B 之间通信,数据包传输流程</span><br><span class="line"><span class="bullet">2. </span>不在一个局域网之内,主机A 和 主机B 通信流程</span><br></pre></td></tr></table></figure>
<h3 id="交换技术"><a href="#交换技术" class="headerlink" title="交换技术"></a>交换技术</h3><p><img src="/img/k8s/k8s_347.jpeg">  </p>
<p><img src="/img/k8s/k8s_346.png">  </p>
<p><img src="/img/k8s/k8s_349.png" width="50%">  </p>
<ul>
<li><strong>路由器：</strong>网络出口</li>
<li><strong>核心层：</strong>主要完成数据高效转发、链路备份等</li>
<li><strong>汇聚层：</strong>网络策略、安全、工作站交换机的接入、VLAN之间通信等功能</li>
<li><strong>接入层：</strong>工作站的接入</li>
</ul>
<ol>
<li>交换机工作在OSI参考模型的第二层，即数据链路层。</li>
<li>交换机拥有一条高带宽的背部总线交换矩阵，在同一时间可进行多个端口对之间的数据传输。</li>
</ol>
<p><strong>交换技术分为2层和3层：</strong></p>
<ul>
<li><p>2层：主要用于小型局域网，仅支持在数据链路层转发数据，对工作站接入。</p>
</li>
<li><p>3层：三层交换技术诞生，最初是为了解决广播域的问题，多年发展，三层交换机书已经成为构建中大型网络的主要力量。</p>
</li>
</ul>
<p><strong>广播域</strong></p>
<ol>
<li>交换机在转发数据时会先进行广播，这个广播可以发送的区域就是一个广播域。</li>
<li>交换机之间对广播帧是透明的，所以交换机之间组成的网络是一个广播域。</li>
<li>路由器的一个接口下的网络是一个广播域，所以路由器可以隔离广播域。</li>
</ol>
<p><strong>ARP（地址解析协议</strong>，在IPV6中用NDP替代）</p>
<ol>
<li>发送这个广播帧是由ARP协议实现，ARP是通过IP地址获取物理地址的一个TCP/IP协议。</li>
</ol>
<p><strong>三层交换机</strong></p>
<ol>
<li>前面讲的二层交换机只工作在数据链路层，路由器则工作在网络层。</li>
<li>而功能强大的三层交换机可同时工作在数据链路层和网络层，并根据 MAC地址或IP地址转发数据包。</li>
</ol>
<p><strong>VLAN（Virtual Local Area Network）：虚拟局域网</strong> </p>
<ol>
<li>VLAN是一种将局域网设备从逻辑上划分成一个个网段。</li>
<li>一个VLAN就是一个广播域，VLAN之间的通信是通过第3层的路由器来完成的。</li>
<li>VLAN应用非常广泛，基本上大部分网络项目都会划分vlan。</li>
<li>VLAN的主要好处：</li>
</ol>
<ul>
<li>分割广播域，减少广播风暴影响范围。</li>
<li>提高网络安全性，根据不同的部门、用途、应用划分不同网段</li>
</ul>
<h4 id="重点1-在一个2层交换机下的两台服务器的通信流程"><a href="#重点1-在一个2层交换机下的两台服务器的通信流程" class="headerlink" title="重点1: 在一个2层交换机下的两台服务器的通信流程"></a>重点1: 在一个2层交换机下的两台服务器的通信流程</h4><p><img src="/img/k8s/k8s_348.png" width="50%">  </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">主机A(10)</span><br><span class="line">主机B(20)</span><br><span class="line">网段:192.168.31.0/24 </span><br><span class="line">源IP 和 目的IP 都是一个子网</span><br><span class="line">四元组: 源IP 源MAC 目的IP 目的MAC ?</span><br></pre></td></tr></table></figure>
<ol>
<li>在本机查找ARP缓存表,是否存在要发送的数据的目的地之 -&gt; 主机B的MAC地址</li>
<li>如果没有,本机会发送ARP广播包,达到2层交换机，询问20(主机B)的MAC地址是多少</li>
<li>交换机也会查本地ARP缓存表<ul>
<li>如果有 就直接响应主机A,主机A得到后重新封装数据包中的目的MAC</li>
<li>如果没有,会发送除主机A之外的所有主机，每个主机都判断目的IP是不是自己,主机B发现是自己将mac地址响应回给交换机,交换机返回给主机A,并保存到自己的缓存表,不同的则将包丢弃</li>
</ul>
</li>
<li>主机A获取到主机B的MAC地址,将目的MAC封装在包内发送给交换机,交换机再转发给主机B。</li>
<li><p>ARP缓存表记录着经过二层传输的源IP和目的IP的MAC地址,以便下次传输能直接使用。</p>
</li>
<li><p>主机A发送的广播包 是否会被所有的交换机收到？ </p>
<ul>
<li>交换机A 和 交换机B 并不是直连的 无法收到</li>
<li>交换机A 可以通过 3层交换机 转发给 交换机B ,如果没有3层交换机,上面是路由器就无法收到,路由器隔离广播域。</li>
<li>3层交换机 既可以处理2层数据包也可以处理3层数据包 </li>
</ul>
</li>
</ol>
<h4 id="重点2-不在一个局域网之内-主机A-和-主机B-通信流程"><a href="#重点2-不在一个局域网之内-主机A-和-主机B-通信流程" class="headerlink" title="重点2: 不在一个局域网之内,主机A 和 主机B 通信流程"></a>重点2: 不在一个局域网之内,主机A 和 主机B 通信流程</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 主机A 和 主机B 不在一个Vlan </span><br><span class="line">2. Vlan1 192.168.31.0/24</span><br><span class="line">3. Vlan2 192.168.32.0/24</span><br></pre></td></tr></table></figure>
<ol>
<li>目的地址与本机不在同一个子网，会走默认网关</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# ip route</span><br><span class="line">default via 172.31.239.253 dev eth0          # 默认网关</span><br><span class="line">10.244.0.0/24 via 10.244.0.0 dev flannel.1 onlink </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>网关会查询路由表</p>
</li>
<li><p>路由器的路由表得知接口是哪个,到达哪个交换机，最后到服务器上。此时交换机会记录mac地址</p>
<ul>
<li>目的地址 192.168.32.0  网关  接口 B </li>
</ul>
</li>
</ol>
<h2 id="Kubernetes-网络模型"><a href="#Kubernetes-网络模型" class="headerlink" title="Kubernetes 网络模型"></a>Kubernetes 网络模型</h2><ol>
<li><p>Kubernetes 要求所有的网络插件实现必须满足如下要求：</p>
<ul>
<li>一个Pod一个IP</li>
<li>所有的 Pod 可以与任何其他 Pod 直接通信，无需使用 NAT 映射</li>
<li>所有节点可以与所有 Pod 直接通信，无需使用 NAT 映射</li>
<li>Pod 内部获取到的 IP 地址与其他 Pod 或节点与其通信时的 IP 地址是同一个。</li>
</ul>
</li>
</ol>
<h2 id="Kubernetes-网络组件之-Flannel"><a href="#Kubernetes-网络组件之-Flannel" class="headerlink" title="Kubernetes 网络组件之 Flannel"></a>Kubernetes 网络组件之 Flannel</h2><ol>
<li>Flannel是CoreOS维护的一个网络组件，Flannel为每个Pod提供全局唯一的IP，Flannel使用ETCD来存储Pod子网与Node IP之间的关系。</li>
<li>flanneld守护进程在每台主机上运行，并负责维护ETCD信息和路由数据包。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. k8s中所有的pod的IP地址都必须是唯一的，如果不唯一,数据包就不知道发送给谁，因为是全联通。</span><br><span class="line">2. 如何保证POD的IP唯一,就是再每个node上都分配一个 子网 ,每个node都由单独的子网(不同网段的Vlan)</span><br><span class="line">3. Flannel 会预先设计一个大的子网，再从大子网将node分配成小子网, 这些信息都会被存储在 etcd中</span><br><span class="line">4. 每个子网与node绑定都有关系记录，用于二层数据包传输</span><br><span class="line">5. flanneld守护进程在每台主机上运行，维护路由规则和etcd中的路由信息</span><br></pre></td></tr></table></figure>
<h3 id="Flannel-部署"><a href="#Flannel-部署" class="headerlink" title="Flannel 部署"></a>Flannel 部署</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/coreos/flannel</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 每个node节点都以 DaemonSet 形式部署 ,保证每个node节点上运行守护进程</span><br><span class="line"># flanneld 守护进程 负责本地路由表设定和维护etcd中的数据,比如将本地分配的子网上报给etcd</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# kubectl get pods -n kube-system</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d8cfdd59d-k5wl9      1/1     Running   16         9d</span><br><span class="line">kube-flannel-ds-amd64-2k5kz   1/1     Running   9          9d</span><br><span class="line">kube-flannel-ds-amd64-gvs6b   1/1     Running   16         9d</span><br><span class="line">kube-flannel-ds-amd64-hwglz   1/1     Running   16         9d</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 查看 yaml 文件</span><br><span class="line"># 1. 使用 ConfigMap 存储了 flannel的配置文件 -&gt; 子网的配置文件</span><br><span class="line"># 2. 重要的两个配置:</span><br><span class="line">#    预先规划好大子网,然后填写进去,大子网一定不能与物理网络冲突</span><br><span class="line">#    还需要对应好 工作模式,VXLAN 是默认的</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 prometheus-k8s]# vim /tmp/k8s/kube-flannel.yaml </span><br><span class="line"></span><br><span class="line"># 大子网配置 和 工作模式(封装数据包的方式)</span><br><span class="line">...</span><br><span class="line">  net-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      "Network": "10.244.0.0/16",</span><br><span class="line">      "Backend": &#123;</span><br><span class="line">        "Type": "vxlan"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 1. 部署后,配置信息会在每个node上的 </span><br><span class="line">[root@k8s-master1 cni]# cd /etc/cni/net.d/</span><br><span class="line">[root@k8s-master1 net.d]# ls</span><br><span class="line">10-flannel.conflist</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 net.d]# cat 10-flannel.conflist </span><br><span class="line">&#123;</span><br><span class="line">  "cniVersion": "0.2.0",</span><br><span class="line">  "name": "cbr0",</span><br><span class="line">  "plugins": [</span><br><span class="line">    &#123;</span><br><span class="line">      "type": "flannel",</span><br><span class="line">      "delegate": &#123;</span><br><span class="line">        "hairpinMode": true,</span><br><span class="line">        "isDefaultGateway": true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "type": "portmap",</span><br><span class="line">      "capabilities": &#123;</span><br><span class="line">        "portMappings": true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. flannel 的网络配置在</span><br><span class="line">[root@k8s-master1 net.d]# cat /var/run/flannel/subnet.env</span><br><span class="line">FLANNEL_NETWORK=10.244.0.0/16       # 大子网 </span><br><span class="line">FLANNEL_SUBNET=10.244.2.1/24        # 被分配的小子网 可被分配255个小子网</span><br><span class="line">FLANNEL_MTU=1450</span><br><span class="line">FLANNEL_IPMASQ=true</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">3. 二进制文件,kubelet会调用这个二进制文件 为创建的每个pod 配置网络信息，从小子网网段里分配IP地址</span><br><span class="line">[root@k8s-master1 net.d]# ls -l /opt/cni/bin/firewall </span><br><span class="line">-rwxr-xr-x 1 root root 5968249 Aug 15 18:05 /opt/cni/bin/firewall</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_350.png" width="50%">  </p>
<h3 id="Flannel-工作模式及原理"><a href="#Flannel-工作模式及原理" class="headerlink" title="Flannel 工作模式及原理"></a>Flannel 工作模式及原理</h3><p><strong>Flannel支持多种数据转发方式</strong></p>
<ul>
<li>UDP：最早支持的一种方式，由于性能最差，目前已经弃用。</li>
<li>VXLAN：Overlay Network方案 ? ，源数据包封装在另一种网络包里面进行路由转发和通信  - 隧道方案</li>
<li>Host-GW：Flannel 通过在各个节点上的Agent进程，将容器网络的路由信息刷到主机的路由表上，这样一来所有的主机都有整个容器网络的路由数据了。 - 路由方案</li>
<li>大多数网络插件都具有这两种方案,比如 Calico </li>
</ul>
<h3 id="VXLAN"><a href="#VXLAN" class="headerlink" title="VXLAN"></a>VXLAN</h3><ol>
<li>二进制部署 支持 cni  </li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 net.d]# cat /opt/kubernetes/cfg/kube-controller-manager.conf</span><br><span class="line"># 允许node自动分配网络</span><br><span class="line">--allocate-node-cidrs=true \</span><br><span class="line"># 指定 pod 网络网段 需要与 Flannel 的网段对应上 kube-flannel.yaml 中的 Network</span><br><span class="line">--cluster-cidr=10.244.0.0/16 \</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># kubelet 配置</span><br><span class="line">[root@k8s-master1 net.d]# cat /opt/kubernetes/cfg/kubelet.conf </span><br><span class="line">--network-plugin=cni \</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>为了能够在二层网络上打通“隧道”，VXLAN 会在宿主机上设置一个特殊的网络设备作为“隧道”的两端。</li>
<li>这个设备就叫作 VTEP，即：VXLAN Tunnel End Point（虚拟隧道端点）。解决跨网段的数据通信。</li>
<li>下图flannel.1的设备就是VXLAN所需的VTEP设备。示意图如下：</li>
</ol>
<p><img src="/img/k8s/k8s_351.png" width="50%">  </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查看 每个node上flannel分配的子网</span><br><span class="line">[root@k8s-node1 ~]# ifconfig </span><br><span class="line"># flannel.1 虚拟网卡</span><br><span class="line"># 当前这个node上创建的pod 都是从这个子网网段拿到IP，所以每个POD的IP地址不唯一</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_352.png" width="50%">  </p>
<h3 id="VXLAN-数据包的传输流程"><a href="#VXLAN-数据包的传输流程" class="headerlink" title="VXLAN 数据包的传输流程"></a>VXLAN 数据包的传输流程</h3><p><strong>1.容器路由：</strong> 容器根据路由表从eth0发出,通过 veth 到达cni0也就到达了node服务器</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@my-nginx-67f56d94f7-lwl9c:/# ip route</span><br><span class="line">default via 10.244.2.1 dev eth0         # 默认路由</span><br><span class="line">10.244.0.0/16 via 10.244.2.1 dev eth0 </span><br><span class="line">10.244.2.0/24 dev eth0  proto kernel  scope link  src 10.244.2.61</span><br></pre></td></tr></table></figure>
<h4 id="veth-pair-对"><a href="#veth-pair-对" class="headerlink" title="veth pair(对)"></a>veth pair(对)</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">1. veth 设备对 网线的一头在容器,一头在node上</span><br><span class="line">[root@k8s-master1 ~]# vim /opt/demo/my-nginx.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: my-nginx</span><br><span class="line">  name: my-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: my-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: my-nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.7.9</span><br><span class="line">        name: nginx</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl apply -f my-nginx.yaml </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# kubectl get pods -o wide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE     IP            NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">my-nginx-67f56d94f7-975h7  1/1     Running   0          8m49s   10.244.0.67   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-67f56d94f7-lngj2  1/1     Running   0          8m49s   10.244.1.55   k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-67f56d94f7-lwl9c  1/1     Running   0          8m49s   10.244.2.61   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line"># 进入master1里面的一个容器 </span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it my-nginx-67f56d94f7-lwl9c bash</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_354.png" width="50%"> </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 创建容器时, node上 会被创建一个新的网络接口 </span><br><span class="line"># veth6cdc3884 被挂到了 cni0 上，veth6cdc3884 就是新创建容器的虚拟网卡。</span><br><span class="line"># cni0 就像是一个二层交换机,所有的pod的网络都会到达这里</span><br><span class="line"># cni0 就是 flannel帮助创建的 拥有独立的IP地址和子网</span><br><span class="line"># 如果当前node上还有其他的pod 他们都通过这个 cni0 就可以通信,因为cni0就好比一个二层交换机</span><br><span class="line"># 同节点pod通信 走 cni0 </span><br><span class="line"># 不同节点 需要走 宿主机路由表 走默认网关: ip route default via 172.31.239.253 dev eth0 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 安装网桥工具 </span><br><span class="line">yum install bridge-utils</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# brctl show</span><br><span class="line"># [root@k8s-master1 ~]# brctl show cni0</span><br><span class="line"></span><br><span class="line">bridge name	bridge id		    STP enabled	    interfaces</span><br><span class="line">cni0		8000.1e9a263ac57d	no		        veth6cdc3884   # 好比交换机的一个端口</span><br><span class="line">							                    vethe28b9770</span><br><span class="line">docker0		8000.02427b6ab66d	no</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_355.png" width="50%"> </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 进入容器,里面的 网卡 eth0@if10 和 node上的 veth6cdc3884 就是 一对 veth pair</span><br><span class="line"># veth pair 是一种成对出现的特殊网络设备，可以把它们想象成由一根虚拟网线连接起来的一对网卡，</span><br><span class="line"># 网卡的一头（eth0@if10）在容器中，另一头（veth6cdc3884）挂在网桥 cni0 上，</span><br><span class="line"># 其效果就是将 eth0@if10 也挂在了 cni0 上。</span><br><span class="line"># eth0@if10 也已经配置cni0提供的网段 </span><br><span class="line"></span><br><span class="line">node上的cni0</span><br><span class="line">7: cni0: <span class="tag">&lt;<span class="name">BROADCAST,MULTICAST,UP,LOWER_UP</span>&gt;</span> mtu 1450 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 1e:9a:26:3a:c5:7d brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.244.2.1/24 brd 10.244.2.255 scope global cni0</span><br><span class="line"></span><br><span class="line"># 容器的网络被cni0分配,所以容器的默认路由就是 cni0</span><br><span class="line">3: eth0@if10: <span class="tag">&lt;<span class="name">BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN</span>&gt;</span> mtu 1450 qdisc noqueue state UP </span><br><span class="line">    link/ether 86:8b:cb:72:68:d2 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.244.2.61/24 brd 10.244.2.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line">root@my-nginx-67f56d94f7-lwl9c:/# ip route</span><br><span class="line">default via 10.244.2.1 dev eth0         # 默认路由</span><br><span class="line">10.244.0.0/16 via 10.244.2.1 dev eth0 </span><br><span class="line">10.244.2.0/24 dev eth0  proto kernel  scope link  src 10.244.2.61</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 不同节点 需要走 宿主机路由表 走默认网关</span><br><span class="line">[root@k8s-master1 ~]# ip route</span><br><span class="line"></span><br><span class="line">default via 172.31.239.253 dev eth0 </span><br><span class="line">10.244.0.0/24 via 10.244.0.0 dev flannel.1 onlink               # flannel 生成           </span><br><span class="line">10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink               # flannel 生成</span><br><span class="line">10.244.2.0/24 dev cni0 proto kernel scope link src 10.244.2.1   # flannel 生成</span><br><span class="line"></span><br><span class="line">169.254.0.0/16 dev eth0 scope link metric 1002 </span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1     # docker0 flannel并没有走 </span><br><span class="line">172.31.224.0/20 dev eth0 proto kernel scope link src 172.31.228.50   # 默认自带</span><br><span class="line"></span><br><span class="line"># 现在数据已经到了宿主机上,数据包里面的数据 源IP 10.244.1.10 目的IP 10.244.2.10</span><br></pre></td></tr></table></figure>
<p><strong>2.主机路由：</strong> 数据包进入到宿主机虚拟网卡cni0，根据路由表转发到flannel.1虚拟网卡，也就是，来到了隧道的入口。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1. 宿主机发现目的IP 10.244.2.10 本机是无法处理，需要走默认网关</span><br><span class="line">2. 他会查看哪个是匹配 10.244.2.10 我这里和图上的实例有区别,因为本机node是10.244.2.0/24 实际上会有匹配的</span><br><span class="line"></span><br><span class="line">default via 172.31.239.253 dev eth0 </span><br><span class="line"></span><br><span class="line">10.244.0.0/24 via 10.244.0.0 dev flannel.1 onlink               # flannel 生成           </span><br><span class="line">10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink               # flannel 生成 </span><br><span class="line">10.244.2.0/24 dev cni0 proto kernel scope link src 10.244.2.1   # flannel 生成</span><br><span class="line"></span><br><span class="line"># 目的 10.244.1.0/24 下一跳 10.244.1.0 发给 flannel.1 onlink</span><br><span class="line"></span><br><span class="line">6: flannel.1: <span class="tag">&lt;<span class="name">BROADCAST,MULTICAST,UP,LOWER_UP</span>&gt;</span> mtu 1450 qdisc noqueue state UNKNOWN group default </span><br><span class="line">    link/ether e6:1e:c6:83:6d:8c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.244.2.0/32 scope global flannel.1</span><br><span class="line"></span><br><span class="line"># 1. 数据到达 node后 根据路由表 转给了 flannel.1 </span><br><span class="line"># 2. flannel.1 交给 VXLAN  ，VXLAN 来进行封包</span><br></pre></td></tr></table></figure>
<p><strong>3. VXLAN封装：</strong> 而这些VTEP设备（二层）之间组成二层网络必须要知道目的MAC地址。这个MAC地址从哪获取到呢？其实在flanneld进程启动后，就会自动添加其他节点ARP记录，可以通过ip命令查看，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# ip neigh show dev flannel.1</span><br><span class="line">10.244.0.0 lladdr fa:8c:e4:15:e4:20 PERMANENT</span><br><span class="line">10.244.1.0 lladdr 36:9d:f8:71:19:e0 PERMANENT</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 数据包解析:</span><br><span class="line">源IP： 10.244.1.10</span><br><span class="line">源MAC： 自己</span><br><span class="line">目的IP: 10.244.2.10</span><br><span class="line">目的MAC : flannel.1 提供，flannel每个节点都存储下一跳网关的MAC地址 ,ip neigh show dev flannel.1 可以看到</span><br><span class="line"></span><br><span class="line"># 对于宿主机来说这个帧没有实际意义,宿主机发不出去 </span><br><span class="line"># 需要二次封包</span><br></pre></td></tr></table></figure>
<p><strong>4. 二次封包：</strong> 知道了目的MAC地址，封装二层数据帧（容器源IP和目的IP）后，对于宿主机网络来说这个帧并没有什么实际意义。接下来，Linux内核还要把这个数据帧进一步封装成为宿主机网络的一个普通数据帧，好让它载着内部数据帧，通过宿主机的eth0网卡进行传输。</p>
<p><img src="/img/k8s/k8s_356.png" width="50%"> </p>
<p><strong>5. 封装到UDP包发出去:</strong> 现在能直接发UDP包嘛？到目前为止，我们只知道另一端的flannel.1设备的MAC地址，却不知道对应的宿主机地址是什么。</p>
<ol>
<li>flanneld进程也维护着一个叫做FDB的转发数据库，可以通过bridge fdb命令查看：</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# bridge fdb show  dev flannel.1</span><br><span class="line">36:9d:f8:71:19:e0 dst 172.31.228.52 self permanent</span><br><span class="line">fa:8c:e4:15:e4:20 dst 172.31.228.53 self permanent</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 根据图中 udp数据包解析 将原来的包上面再加一次层 :</span><br><span class="line"># 目的就是让这个包直接传输到目的node主机上</span><br><span class="line"></span><br><span class="line"># 里面一层 容器到容器数据包</span><br><span class="line">源IP： 10.244.1.10</span><br><span class="line">源MAC： 自己</span><br><span class="line">目的IP: 10.244.2.10</span><br><span class="line">目的MAC : flannel.1 提供 : ip neigh show dev flannel.1 </span><br><span class="line"></span><br><span class="line"># 外面一层 两个宿主机</span><br><span class="line">源IP：  192.168.31.62</span><br><span class="line">源MAC： 自己</span><br><span class="line">目的IP: 192.168.31.63</span><br><span class="line">目的MAC : flannel.1 提供 : bridge fdb show  dev flannel.1 对应目的ip的mac地址</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# bridge fdb show  dev flannel.1</span><br><span class="line"></span><br><span class="line">36:9d:f8:71:19:e0 dst 172.31.228.52 self permanent</span><br><span class="line">fa:8c:e4:15:e4:20 dst 172.31.228.53 self permanent</span><br></pre></td></tr></table></figure>
<p>可以看到，上面用的对方flannel.1的MAC地址对应宿主机IP，也就是UDP要发往的目的地。使用这个目的IP进行封装。</p>
<p><strong>6. 数据包到达目的宿主机</strong> Node1的eth0网卡发出去，发现是VXLAN数据包，把它交给flannel.1设备。flannel.1设备则会进一步拆包，取出原始二层数据帧包，发送ARP请求，经由cni0网桥转发给container。</p>
<ol>
<li>数据包头部里面会有 VXLAN 标记，加了编号VNI，flannel.1的1就是编号，交给flannel.1去处理</li>
<li>拿到源IP和目的IP，去判断,一看是cni0网桥的交给cni0</li>
<li>cni0进行广播 拿着ip进行广播, 最后转发到容器里</li>
<li>最复杂的地方在于flannel.1的vtep 对数据的封包与解封包</li>
<li>flannel.1 这种封包 会导致效率下降 ，VXLAN这种形式就是Overlay Network方案,源数据包封装到另一层网络里,叠加网络</li>
<li>VXLAN 只是实现封包解封包的技术 </li>
<li>VXLAN 在大型网络架构中,效率并不高</li>
</ol>
<p><img src="/img/k8s/k8s_357.png" width="50%"> </p>
<h3 id="Host-GW"><a href="#Host-GW" class="headerlink" title="Host-GW"></a>Host-GW</h3><p><img src="/img/k8s/k8s_358.png" width="50%"> </p>
<ol>
<li>host-gw模式相比vxlan简单了许多，直接添加路由，将目的主机当做网关，直接路由原始封包。 </li>
<li>没有 flannel.1 阶段了 </li>
<li>host-gw模式 就像把每一个node主机当做网关</li>
</ol>
<p><strong>设置flannel使用host-gw模式</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# vim /tmp/k8s/kube-flannel.yaml </span><br><span class="line">  net-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      "Network": "10.244.0.0/16",</span><br><span class="line">      "Backend": &#123;</span><br><span class="line">        "Type": "host-gw"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 更新 flannel 部署</span><br><span class="line"># 更新网络相关操作,切换模式,一定要再停机维护的时候进行,因为网络会受到修改,以免出现网络冲突</span><br><span class="line"># 肯定要再模拟测试环境完成后 再上线更改</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# kubectl delete -f /tmp/k8s/kube-flannel.yaml </span><br><span class="line">[root@k8s-master1 ~]# kubectl apply -f /tmp/k8s/kube-flannel.yaml </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# kubectl get pods -n kube-system</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d8cfdd59d-k5wl9      1/1     Running   17         10d</span><br><span class="line">kube-flannel-ds-amd64-5gfps   1/1     Running   0          2m5s</span><br><span class="line">kube-flannel-ds-amd64-6hpzc   1/1     Running   0          2m5s</span><br><span class="line">kube-flannel-ds-amd64-ht9ll   1/1     Running   0          2m5s</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">当你设置flannel使用host-gw模式,flanneld会在宿主机上创建节点的路由表：</span><br><span class="line">[root@k8s-master1 ~]# ip route</span><br><span class="line">default via 172.31.239.253 dev eth0 </span><br><span class="line">10.244.0.0/24 via 172.31.228.53 dev eth0 </span><br><span class="line">10.244.1.0/24 via 172.31.228.52 dev eth0 </span><br><span class="line">10.244.2.0/24 dev cni0 proto kernel scope link src 10.244.2.1 </span><br><span class="line">169.254.0.0/16 dev eth0 scope link metric 1002 </span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 </span><br><span class="line">172.31.224.0/20 dev eth0 proto kernel scope link src 172.31.228.50</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1. 目的 IP 地址属于 10.244.1.0/24 网段的 IP 包，应该经过本机的 eth0 设备发出去（即：dev eth0）；</span><br><span class="line">2. 并且，它下一跳地址是 172.31.228.52（即：via172.31.228.52）。</span><br><span class="line">3. 一旦配置了下一跳地址，那么接下来，当 IP 包从网络层进入链路层封装成帧的时候，eth0 设备就会使用下一跳地址对应的 MAC 地址，作为该数据帧的目的 MAC 地址。</span><br><span class="line">4. 不会再使用 flannel.1 这个设备,cni0网桥的数据包会走路由表，因为发送的目的IP地址并非同一网段,需要走路由表</span><br><span class="line">5. 宿主机重新封包 目的地址就是 路由表中对应的地址 比如 172.31.228.52 （测试里面的 192.168.31.63 ）</span><br><span class="line">6. 他看到 172.31.228.52 和自己node服务器所在同一个网段,也就是二层传输,需要获取目的的mac地址</span><br><span class="line">7. 如果不知道 172.31.228.52 的mac地址，就会走arp广播 也就是一个局域网之内的主机A和主机B通信</span><br><span class="line"></span><br><span class="line"># 根据二层数据转发的包</span><br><span class="line">源IP： 10.244.1.10</span><br><span class="line">源MAC： 自己</span><br><span class="line">目的IP: 10.244.1.20</span><br><span class="line">目的MAC : ARP广播包响应回来的</span><br><span class="line">8. 而 Node 2 的内核网络栈从二层数据帧里拿到 IP 包后，会“看到”这个 IP 包的目的 IP 地址是 10.244.1.20，即 container-2 的 IP 地址。这时候，根据 Node 2 上的路由表，该目的地址会匹配到第二条路由规则（也就是 10.244.1.0 对应的路由规则），从而进入 cni0 网桥，进而进入到 container-2 当中。</span><br><span class="line"># 这里写的乱的原因是 图和实际的数据不一致,不过大概的路线没错,即走本地路由到达对应node，二层路由</span><br><span class="line"># 限制就是 每个node节点的 二层能通 (在同一个网段)</span><br><span class="line"># 性能更好,没有封包解封包</span><br></pre></td></tr></table></figure>
<h3 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h3><ol>
<li>如果追求性能 并且 node的二层网络能通 可以使用 Host-GW 工作模式</li>
<li>如果node不能通过二层通信，需要路由转发(可能不同Vlan)，使用 VXLAN </li>
<li>用户访问 - svc(nodeport) -&gt; iptables/ipvs -&gt; node1\node2\node3 ,如果访问的pod正好是本机的node那么直接走本地的路由访问,<br>如果到了其他node,那么就是跨主机网络通信,需要走路由表,如果工作模式是vxlan,那么要走flannel.1进行封包解封包流程<br>重点是看哪种工作流程和路由规则,一定要搞清楚里面的概念很多,加油吧</li>
<li>Host-GW 二层包转发 </li>
</ol>
<h3 id="阿里云主机的-host-gw方案不通"><a href="#阿里云主机的-host-gw方案不通" class="headerlink" title="阿里云主机的 host-gw方案不通"></a>阿里云主机的 host-gw方案不通</h3><p><img src="/img/k8s/k8s_366.png" width="50%"> </p>
<p><img src="/img/k8s/k8s_367.png" width="50%"> </p>
<ol>
<li>阿里云不通,但是本地虚拟机是通的,测试环境迁移到虚拟机</li>
<li>Calico BGP 也没通，测试下虚拟机 通不通</li>
</ol>
<h2 id="Kubernetes-网络方案之-Calico"><a href="#Kubernetes-网络方案之-Calico" class="headerlink" title="Kubernetes 网络方案之 Calico"></a>Kubernetes 网络方案之 Calico</h2><ol>
<li>Calico是一个纯三层的数据中心网络方案，Calico支持广泛的平台，包括Kubernetes、OpenStack等。</li>
<li>Calico 在每一个计算节点利用 Linux Kernel 实现了一个高效的虚拟路由器（ vRouter） 来负责数据转发，而每个 vRouter 通过 BGP 协议负责把自己上运行的 workload 的路由信息向整个 Calico 网络内传播。</li>
<li>此外，Calico 项目还实现了 Kubernetes 网络策略，提供ACL功能。</li>
<li>访问控制列表(ACL)是一种基于包过滤的访问控制技术，它可以根据设定的条件对接口上的数据包进行过滤，允许其通过或丢弃。</li>
</ol>
<h3 id="BGP-概述"><a href="#BGP-概述" class="headerlink" title="BGP 概述"></a>BGP 概述</h3><ol>
<li>实际上，Calico项目提供的网络解决方案，与Flannel的host-gw模式几乎一样。</li>
<li>也就是说，Calico也是基于路由表实现容器数据包转发，但不同于Flannel使用flanneld进程来维护路由信息的做法，而Calico项目使用BGP协议来自动维护整个集群的路由信息。</li>
<li>GP英文全称是Border Gateway Protocol，即边界网关协议，它是一种自治系统间的动态路由发现协议，与其他 BGP 系统交换网络可达信息。 </li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 维护路由信息</span><br><span class="line">Calico  BGP协议        Flannel Host-GW工作方式基本一致,BGP完成数据交换,大型网络架构的动态协议,技术高大上,性能牛逼</span><br><span class="line">Flannel flanneld进程   Flannel 自己做数据交换</span><br><span class="line"></span><br><span class="line"># BGP 协议 在集群规模达到一定量时 性能更棒</span><br><span class="line">BGP 机房多线(双线) </span><br><span class="line">BGP 协议 涉及到 静态路由和动态路由，路由选择路径转发,根据路由表,理由表又分为静态和动态</span><br><span class="line">静态路由表 由人工添加维护</span><br><span class="line">动态路由表 相互感知</span><br><span class="line">当网络架构中的路由很多时,甚至跨公司跨机房,需要手动配置？人工两很大,到达一定的规模 就会使用动态路由协议 BGP就是其中一个</span><br><span class="line">目的: 动态感知整个网络路由拓扑 路由之间相互学习</span><br></pre></td></tr></table></figure>
<p><strong>为了能让你更清楚理解BGP，举个例子：</strong></p>
<p><img src="/img/k8s/k8s_359.png" width="50%"> </p>
<ol>
<li>在这个图中，有两个自治系统（autonomous system，简称为AS）：AS 1 和 AS 2。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 什么是自治系统</span><br><span class="line">1. 在互联网中，一个自治系统(AS)是一个有权自主地决定在本系统中应采用何种路由协议的小型单位。</span><br><span class="line">2. 这个网络单位可以是一个简单的网络也可以是一个由一个或多个普通的网络管理员来控制的网络群体，</span><br><span class="line">3. 它是一个单独的可管理的网络单元（例如一所大学，一个企业或者一个公司个体）。</span><br><span class="line">4. 一个自治系统有时也被称为是一个路由选择域（routing domain）。</span><br><span class="line">5. 一个自治系统将会分配一个全局的唯一的16位号码，有时我们把这个号码叫做自治系统号（ASN）。</span><br><span class="line"></span><br><span class="line">简单来说:就是两个不依赖其他公司的网络系统,独立运行管理</span><br><span class="line"></span><br><span class="line">6. 在正常情况下，自治系统之间不会有任何来往。</span><br><span class="line">7. 如果两个自治系统里的主机，要通过 IP 地址直接进行通信，我们就必须使用路由器把这两个自治系统连接起来。</span><br><span class="line">8. BGP协议就是让他们互联的一种方式。</span><br><span class="line"></span><br><span class="line">BGP的作用: 让两个独立的网络互通,只要两个路由相通,BGP来负责动态添加路由,就可以实现，动态学习相互的路由表信息。</span><br><span class="line">           减少人工添加路由</span><br></pre></td></tr></table></figure>
<h3 id="Calico-BGP实现"><a href="#Calico-BGP实现" class="headerlink" title="Calico BGP实现"></a>Calico BGP实现</h3><p><img src="/img/k8s/k8s_360.png" width="50%"> </p>
<ol>
<li>在了解了 BGP 之后，Calico 项目的架构就非常容易理解了，Calico主要由三个部分组成： </li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- Felix：以DaemonSet方式部署，运行在每一个Node节点上，主要负责维护宿主机上路由规则以及ACL规则。</span><br><span class="line">- BGP Client（BIRD）：主要负责把 Felix 写入 Kernel 的路由信息分发到集群 Calico 网络。</span><br><span class="line">- Etcd：分布式键值存储，保存Calico的策略和网络配置状态。</span><br><span class="line">- calicoctl：允许您从简单的命令行界面实现高级策略和网络。</span><br></pre></td></tr></table></figure>
<h3 id="Calico-部署"><a href="#Calico-部署" class="headerlink" title="Calico 部署"></a>Calico 部署</h3><p><strong>1. 删除Flannel</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 切换网络别忘记停机维护 夜深人静</span><br><span class="line"># 正式环境先做好配置再删除</span><br><span class="line">[root@k8s-master1 ~]# kubectl delete -f /tmp/k8s/kube-flannel.yaml </span><br><span class="line"></span><br><span class="line"># 下载部署文件</span><br><span class="line">[root@k8s-master1 k8s]# cd /tmp/k8s/</span><br><span class="line">[root@k8s-master1 k8s]# curl https://docs.projectcalico.org/v3.9/manifests/calico-etcd.yaml -o calico.yaml</span><br><span class="line"></span><br><span class="line"># 下载完后还需要修改里面配置项：</span><br><span class="line">1. 配置连接etcd地址，如果使用https，还需要配置证书。（ConfigMap，Secret）</span><br><span class="line">2. 根据实际网络规划修改Pod CIDR（CALICO_IPV4POOL_CIDR）</span><br><span class="line">3. 选择工作模式（CALICO_IPV4POOL_IPIP），支持BGP，IPIP</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 k8s]# vim calico.yaml </span><br><span class="line"># 在k8s中 etcd一定要独立部署</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 1 添加证书</span><br><span class="line"># 证书位置 [root@k8s-master1 ~]# cd /opt/etcd/ssl/</span><br><span class="line"># 放在secret 需要base64编码</span><br><span class="line">[root@k8s-master1 ssl]# cat /opt/etcd/ssl/ca.pem |base64 -w 0</span><br><span class="line">[root@k8s-master1 ssl]# cat /opt/etcd/ssl/server-key.pem |base64 -w 0</span><br><span class="line">[root@k8s-master1 ssl]# cat /opt/etcd/ssl/server.pem |base64 -w 0</span><br><span class="line"></span><br><span class="line"># 复制粘贴到 calico.yaml 中</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_361.png" width="50%"> </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 2 指定读取位置</span><br><span class="line">  etcd_ca: "/calico-secrets/etcd-ca"</span><br><span class="line">  etcd_cert: "/calico-secrets/etcd-cert"</span><br><span class="line">  etcd_key: "/calico-secrets/etcd-key"</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 3. 指定etcd连接字符串</span><br><span class="line">[root@k8s-master1 ssl]# cat /opt/kubernetes/cfg/kube-apiserver.conf </span><br><span class="line">https://172.31.228.50:2379,https://172.31.228.52:2379,https://172.31.228.53:2379</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_362.png" width="50%"> </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 4. 修改 Pod CIDR  </span><br><span class="line"># 要与 [root@k8s-master1 ssl]# cat /opt/kubernetes/cfg/kube-controller-manager.conf 中的 --cluster-cidr=10.244.0.0/16 \ 一致</span><br><span class="line">[root@k8s-master1 k8s]# vim calico.yaml </span><br><span class="line">/CALICO_IPV4POOL_CIDR </span><br><span class="line"></span><br><span class="line">            - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">              value: "10.244.0.0/16"</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 5. 修改工作模式，也有两种 IPIP 和 BGP(应用最多)</span><br><span class="line"># 不修改的话 默认是 IPIP 注释掉就是BGP</span><br><span class="line"></span><br><span class="line">            # Enable IPIP</span><br><span class="line">            - name: CALICO_IPV4POOL_IPIP</span><br><span class="line">              value: "Always"</span><br><span class="line">            </span><br><span class="line">            # 修改成 Never 或者 off 关闭 默认就走BGP</span><br><span class="line">            # Enable IPIP</span><br><span class="line">            - name: CALICO_IPV4POOL_IPIP</span><br><span class="line">              value: "Never"</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 6. 清理网络 每台node都要做</span><br><span class="line"># 修改后保存,再删除 flannel网络 </span><br><span class="line"># 还需要删除 flannel的虚拟网卡配置 以免冲突 </span><br><span class="line">[root@k8s-master1 ssl]# ip link delete cni0</span><br><span class="line">[root@k8s-master1 ssl]# ip link delete flannel.1</span><br><span class="line"></span><br><span class="line"># 把之前 host-gw 路由也删除 保持纯净路由表</span><br><span class="line">[root@k8s-master1 ssl]# ip route</span><br><span class="line">default via 172.31.239.253 dev eth0 </span><br><span class="line">10.244.0.0/24 via 172.31.228.53 dev eth0 </span><br><span class="line">10.244.1.0/24 via 172.31.228.52 dev eth0 </span><br><span class="line">169.254.0.0/16 dev eth0 scope link metric 1002 </span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 </span><br><span class="line">172.31.224.0/20 dev eth0 proto kernel scope link src 172.31.228.50 </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ssl]# ip route delete 10.244.0.0/24 via 172.31.228.53 dev eth0 </span><br><span class="line">[root@k8s-master1 ssl]# ip route delete 10.244.1.0/24 via 172.31.228.52 dev eth0</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># 7. 部署 calico</span><br><span class="line">[root@k8s-master1 k8s]# kubectl apply -f /tmp/k8s/calico.yaml </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 k8s]# kubectl get pods -n kube-system</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-5cc7b68d7c-qszdt   1/1     Running   0          6m16s</span><br><span class="line">calico-node-pbs44                          1/1     Running   0          6m16s</span><br><span class="line">calico-node-qdbz4                          1/1     Running   0          6m16s</span><br><span class="line">calico-node-tk4lg                          1/1     Running   0          6m16s</span><br><span class="line">coredns-6d8cfdd59d-k5wl9                   1/1     Running   23         10d</span><br><span class="line"></span><br><span class="line">calico-node 在每台node上都部署,包含了BGP Client（BIRD）和 Felix</span><br><span class="line">calico-kube-controllers 从etcd获取网络规则和策略</span><br><span class="line"></span><br><span class="line"># 原先运行的pod 如果要是要 calico 网络 都需要重建，切换网络的影响还是挺大的</span><br><span class="line"># 我之前的 jenkins和nfs pvc 都需要重建了</span><br><span class="line">[root@k8s-master1 demo]# kubectl delete -f my-nginx.yaml </span><br><span class="line">[root@k8s-master1 demo]# kubectl apply -f my-nginx.yaml </span><br><span class="line"></span><br><span class="line"># 重建pod后相当于让网络做了路由学习 查看路由</span><br><span class="line"># 阿里云主机不通 我改为 本地虚拟机 多创建几个pod</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl get pods --all-namespaces -o wide</span><br><span class="line">NAMESPACE              NAME                                         READY   STATUS             RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">default                my-nginx-77fdbc8556-g9hqp                    1/1     Running            0          12m   10.244.36.65     k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">default                my-nginx-77fdbc8556-m7mp7                    1/1     Running            0          12m   10.244.159.128   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">default                my-nginx-77fdbc8556-pdn9z                    1/1     Running            0          12m   10.244.169.128   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">default                my-nginx2-8f86ff956-2tksg                    1/1     Running            0          11m   10.244.169.129   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">default                my-nginx2-8f86ff956-4krd6                    1/1     Running            0          11m   10.244.159.129   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">default                my-nginx2-8f86ff956-b2jld                    1/1     Running            0          11m   10.244.36.66     k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">ingress-nginx          nginx-ingress-controller-2lmzq               1/1     Running            0          87m   192.168.0.101    k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">ingress-nginx          nginx-ingress-controller-mnf44               1/1     Running            0          87m   192.168.0.103    k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">ingress-nginx          nginx-ingress-controller-v22ld               1/1     Running            0          87m   192.168.0.102    k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">kube-system            calico-kube-controllers-5cc7b68d7c-xb5rf     1/1     Running            0          35m   192.168.0.102    k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">kube-system            calico-node-hwt8c                            1/1     Running            0          35m   192.168.0.103    k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">kube-system            calico-node-v7c4g                            1/1     Running            0          35m   192.168.0.101    k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">kube-system            calico-node-wfp2f                            1/1     Running            0          35m   192.168.0.102    k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">kube-system            coredns-6d8cfdd59d-6wwkz                     1/1     Running            0          13m   10.244.36.64     k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">kubernetes-dashboard   dashboard-metrics-scraper-566cddb686-57z4p   0/1     CrashLoopBackOff   11         87m   10.244.0.2       k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard-c4bc5bd44-ntrlj         0/1     CrashLoopBackOff   10         87m   10.244.1.2       k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# ping 10.244.36.65</span><br><span class="line">[root@k8s-master1 demo]# ping 10.244.169.129</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# ip route</span><br><span class="line"></span><br><span class="line">10.244.36.64/26 via 192.168.0.102 dev eth0 proto bird </span><br><span class="line">10.244.159.128 dev cali196b9d660e1 scope link </span><br><span class="line">blackhole 10.244.159.128/26 proto bird </span><br><span class="line">10.244.159.129 dev cali642ae61a996 scope link </span><br><span class="line">10.244.169.128/26 via 192.168.0.103 dev eth0 proto bird</span><br></pre></td></tr></table></figure>
<h3 id="Calico-管理工具"><a href="#Calico-管理工具" class="headerlink" title="Calico 管理工具"></a>Calico 管理工具</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">下载工具：</span><br><span class="line">https://github.com/projectcalico/calicoctl/releases</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 opt]# ls -l calicoctl </span><br><span class="line">-rw-r--r-- 1 root root 37090848 Jan 10 17:45 calicoctl</span><br><span class="line">[root@k8s-master1 opt]# chmod +x calicoctl </span><br><span class="line">[root@k8s-master1 opt]# mv calicoctl /usr/bin/</span><br><span class="line"></span><br><span class="line"># 查看BGP节点的建立状态 ipv4 看到其他节点</span><br><span class="line">[root@k8s-master1 k8s]# /usr/bin/calicoctl node status</span><br><span class="line">Calico process is running.</span><br><span class="line"></span><br><span class="line">IPv4 BGP status</span><br><span class="line">+---------------+-------------------+-------+----------+-------------+</span><br><span class="line">| PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |</span><br><span class="line">+---------------+-------------------+-------+----------+-------------+</span><br><span class="line">| 192.168.0.102 | node-to-node mesh | up    | 02:10:36 | Established |</span><br><span class="line">| 192.168.0.103 | node-to-node mesh | up    | 02:13:43 | Established |</span><br><span class="line">+---------------+-------------------+-------+----------+-------------+</span><br><span class="line"></span><br><span class="line">IPv6 BGP status</span><br><span class="line">No IPv6 peers found.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># calicoctl 也有很多其他操作,更多的是向etcd里操作 需要配置文件 上面这个结果是tcp连接做的并没有读取etcd</span><br><span class="line">[root@k8s-master1 opt]# netstat -anlp|grep bird      </span><br><span class="line"></span><br><span class="line"># 如果有其他操作比如修改工作模式,需要做配置文件</span><br><span class="line">[root@k8s-master1 opt]# mkdir /etc/calico</span><br><span class="line">[root@k8s-master1 k8s]# vim /etc/calico/calicoctl.cfg </span><br><span class="line"></span><br><span class="line">apiVersion: projectcalico.org/v3</span><br><span class="line">kind: CalicoAPIConfig</span><br><span class="line">metadata:</span><br><span class="line">spec:</span><br><span class="line">  datastoreType: "etcdv3"</span><br><span class="line">  etcdEndpoints: "https://192.168.0.101:2379,https://192.168.0.102:2379,https://192.168.0.103:2379"</span><br><span class="line">  etcdKeyFile: "/opt/etcd/ssl/server-key.pem"</span><br><span class="line">  etcdCertFile: "/opt/etcd/ssl/server.pem"</span><br><span class="line">  etcdCACertFile: "/opt/etcd/ssl/ca.pem</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_368.png" width="50%"> </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 向etcd读取数据</span><br><span class="line">[root@k8s-master1 opt]# calicoctl get nodes</span><br><span class="line">NAME          </span><br><span class="line">k8s-master1   </span><br><span class="line">k8s-node1     </span><br><span class="line">k8s-node2  </span><br><span class="line"></span><br><span class="line"># 查看 IPAM的IP地址池：</span><br><span class="line">[root@k8s-master1 opt]# calicoctl get ippool</span><br><span class="line">NAME                  CIDR            SELECTOR   </span><br><span class="line">default-ipv4-ippool   10.244.0.0/16   all()</span><br></pre></td></tr></table></figure>
<h3 id="Calico-BGP-原理剖析"><a href="#Calico-BGP-原理剖析" class="headerlink" title="Calico BGP 原理剖析"></a>Calico BGP 原理剖析</h3><p><img src="/img/k8s/k8s_364.png" width="50%"> </p>
<ol>
<li>Pod 1 访问 Pod 2大致流程如下： </li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1. 数据包从容器1出 到达Veth Pair另一端（宿主机上，以cali前缀开头）；</span><br><span class="line">2. 宿主机根据路由规则，将数据包转发给下一跳（网关）；</span><br><span class="line">3. 到达Node2，根据路由规则将数据包转发给cali设备，从而到达容器2。</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 jenkins]# kubectl get pods -o wide</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">my-nginx-77fdbc8556-nzhhs                 1/1     Running   0          48m   10.244.159.128   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-q759m                 1/1     Running   0          48m   10.244.169.128   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-s7r75                 1/1     Running   0          48m   10.24.436.64     k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">nfs-client-provisioner-769f87c8f6-hw9m7   1/1     Running   0          45m   10.244.36.65     k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_365.png" width="50%"> </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 创建pod kubelet 调用 calico 二进制程序创建网络，配置IP地址</span><br><span class="line">[root@k8s-node1 tmp]# ls -l /opt/cni/bin/calico-ipam 和 calico   # yaml文件中镜像准备</span><br><span class="line"></span><br><span class="line"># 子网配置信息</span><br><span class="line">[root@k8s-node1 tmp]# cat /etc/cni/net.d/10-calico.conflist</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">1. 到达cali之后就是到达了宿主机node服务器身上</span><br><span class="line">2. 查看路由表</span><br><span class="line"></span><br><span class="line">[root@k8s-node1 net.d]# ip route</span><br><span class="line">default via 172.31.239.253 dev eth0 </span><br><span class="line">10.244.36.64 dev cali358923ad8fb scope link </span><br><span class="line">blackhole 10.244.36.64/26 proto bird </span><br><span class="line">10.244.36.65 dev calia8a14e44e0f scope link </span><br><span class="line">10.244.159.128/26 via 172.31.228.50 dev eth0 proto bird </span><br><span class="line">10.244.169.128/26 via 172.31.228.53 dev eth0 proto bird </span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">3. 比如node1数据通往node2 10.24.436.64 -&gt; 10.244.169.128 </span><br><span class="line"># 此时数据包里面:</span><br><span class="line">源IP： 10.24.436.64</span><br><span class="line">目的IP： 10.244.169.128 </span><br><span class="line"></span><br><span class="line">路由规则走: </span><br><span class="line">10.244.169.128/26 via 172.31.228.53 dev eth0 proto bird # 走eth0口 下一条 172.31.228.53(node2的eth0地址)</span><br><span class="line"></span><br><span class="line">4. 数据包到达node2后 </span><br><span class="line"># 首先看veth对 </span><br><span class="line"># 查看node2的路由规则 </span><br><span class="line">[root@k8s-node2 kubernetes]# ip route</span><br><span class="line">default via 172.31.239.253 dev eth0 </span><br><span class="line">10.244.36.64/26 via 172.31.228.52 dev eth0 proto bird </span><br><span class="line">10.244.159.128/26 via 172.31.228.50 dev eth0 proto bird </span><br><span class="line">10.244.169.128 dev cali3480203cfd9 scope link  # 这一条</span><br><span class="line">blackhole 10.244.169.128/26 proto bird </span><br><span class="line">... </span><br><span class="line"></span><br><span class="line"># 数据目的地址是 10.244.169.128的 都会到达 cali3480203cfd9 也就是那块虚拟网卡cali</span><br><span class="line"># cali3480203cfd9 又是容器的 veth 在宿主机上的一端 然后就发往容器了 </span><br><span class="line"></span><br><span class="line">5. Calico 没有网桥 没有cni0 数据怎么到达node上呢？</span><br><span class="line">因为 cali3480203cfd9 cali这个虚拟网卡里面有个 arp代理机制</span><br><span class="line"></span><br><span class="line">容器1 -&gt; cali -&gt; node1 -&gt; 路由表 -&gt; node2 -&gt; cali -&gt; 容器2  很像host-gw 2层网络互通</span><br><span class="line"># 如果2层IP不能互通,就需要使用 IPIP模式 也就是node1 与 node2 无法直接互通的情况</span><br></pre></td></tr></table></figure>
<ol>
<li>其中，这里最核心的“下一跳”路由规则，就是由 Calico 的 Felix 进程负责维护的。</li>
<li>这些路由规则信息，则是通过 BGP Client 也就是 BIRD 组件，使用 BGP 协议传输而来的。</li>
<li>不难发现，Calico 项目实际上将集群里的所有节点，都当作是边界路由器来处理，它们一起组成了一个全连通的网络，互相之间通过 BGP 协议交换路由规则。</li>
<li>这些节点，我们称为 BGP Peer。</li>
</ol>
<h3 id="Route-Reflector-模式（RR）"><a href="#Route-Reflector-模式（RR）" class="headerlink" title="Route Reflector 模式（RR）"></a>Route Reflector 模式（RR）</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">参考：</span><br><span class="line">https://docs.projectcalico.org/master/networking/bgp</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# calicoctl node status</span><br><span class="line"></span><br><span class="line">+---------------+-------------------+-------+----------+-------------+</span><br><span class="line">| PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |</span><br><span class="line">+---------------+-------------------+-------+----------+-------------+</span><br><span class="line">| 192.168.0.102 | node-to-node mesh | up    | 02:10:36 | Established |</span><br><span class="line">| 192.168.0.103 | node-to-node mesh | up    | 02:13:43 | Established |</span><br><span class="line">+---------------+-------------------+-------+----------+-------------+</span><br></pre></td></tr></table></figure>
<ol start="0">
<li>Node-to-Node 在100台以下</li>
<li>Calico 维护的网络在默认是（Node-to-Node Mesh）全互联模式，Calico集群中的节点之间都会相互建立连接，用于路由交换。</li>
<li>但是随着集群规模的扩大，mesh模式将形成一个巨大服务网格，连接数成倍增加。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 默认连接</span><br><span class="line">b1 -&gt; b2 b3</span><br><span class="line">b2 -&gt; b1 b3</span><br><span class="line">b3 -&gt; b1 b2 </span><br><span class="line">... 增加一个加点 每个几点都要n+1 上百个建立连接就大了</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>这时就需要使用 Route Reflector（路由器反射）模式解决这个问题。</li>
<li>确定一个或多个Calico节点充当路由反射器，让其他节点从这个RR节点获取路由信息。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 路由反射 至少2-3个 有备用</span><br><span class="line">b1 -&gt; 路由反射节点1 </span><br><span class="line">b2 -&gt; 路由反射节点2</span><br><span class="line">b3 -&gt; 路由反射节点1</span><br></pre></td></tr></table></figure>
<p><strong>1. 关闭 node-to-node BGP网格</strong> </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# vim bgp.yaml</span><br><span class="line"></span><br><span class="line"> apiVersion: projectcalico.org/v3</span><br><span class="line"> kind: BGPConfiguration</span><br><span class="line"> metadata:</span><br><span class="line">   name: default</span><br><span class="line"> spec:</span><br><span class="line">   logSeverityScreen: Info</span><br><span class="line">   nodeToNodeMeshEnabled: false</span><br><span class="line">   asNumber: 63400</span><br><span class="line"></span><br><span class="line"># 执行这部时，整个网络会断开 请在停机维护时操作</span><br><span class="line">[root@k8s-master1 demo]# calicoctl apply -f bgp.yaml </span><br><span class="line">Successfully applied 1 'BGPConfiguration' resource(s)</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# calicoctl get bgpconfig</span><br><span class="line">NAME      LOGSEVERITY   MESHENABLED   ASNUMBER   </span><br><span class="line">default   Info          false         63400      </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# ping 10.244.169.132</span><br><span class="line">PING 10.244.169.132 (10.244.169.132) 56(84) bytes of data.</span><br><span class="line"># 网络已经不通</span><br><span class="line"></span><br><span class="line">ASN号可以通过获取 # calicoctl get nodes --output=wide</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# calicoctl get nodes --output=wide</span><br><span class="line">NAME          ASN       IPV4               IPV6   </span><br><span class="line">k8s-master1   (63400)   192.168.0.101/24          </span><br><span class="line">k8s-node1     (63400)   192.168.0.102/24          </span><br><span class="line">k8s-node2     (63400)   192.168.0.103/24</span><br></pre></td></tr></table></figure>
<p><strong>2. 配置指定节点充当路由反射器</strong></p>
<ol>
<li>为方便让BGP Peer轻松选择节点，通过标签选择器匹配。</li>
<li>给路由器反射器节点打标签: </li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node my-node route-reflector=true</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl label node k8s-node2 route-reflector=true </span><br><span class="line">node/k8s-node2 labeled</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# calicoctl node status</span><br><span class="line">Calico process is running.</span><br><span class="line"></span><br><span class="line">IPv4 BGP status</span><br><span class="line">No IPv4 peers found.</span><br><span class="line"></span><br><span class="line">IPv6 BGP status</span><br><span class="line">No IPv6 peers found.</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 然后配置路由器反射器节点 routeReflectorClusterID：</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# calicoctl get node k8s-node2 -o yaml &gt; node.yaml</span><br><span class="line">[root@k8s-master1 demo]# vim node.yaml </span><br><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  bgp:</span><br><span class="line">    ipv4Address: 192.168.0.103/24</span><br><span class="line">    routeReflectorClusterID: 244.0.0.1   # 集群ID</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# calicoctl apply -f node.yaml </span><br><span class="line">Successfully applied 1 'Node' resource(s)</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># 将非路由反射器节点 连接路由反射器 获取交换信息</span><br><span class="line">[root@k8s-master1 demo]# vim bgp2.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: projectcalico.org/v3</span><br><span class="line">kind: BGPPeer</span><br><span class="line">metadata:</span><br><span class="line">  name: peer-with-route-reflectors</span><br><span class="line">spec:</span><br><span class="line">  nodeSelector: all()</span><br><span class="line">  # 所有的node 都去找 route-reflector == 'true' 这个标签</span><br><span class="line">  peerSelector: route-reflector == 'true'</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# calicoctl apply -f bgp2.yaml </span><br><span class="line">Successfully applied 1 'BGPPeer' resource(s)</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# calicoctl get bgppeer</span><br><span class="line">NAME                         PEERIP   NODE    ASN   </span><br><span class="line">peer-with-route-reflectors            all()   0   </span><br><span class="line"></span><br><span class="line"># 查看节点的连接状态 只显示路由反射器的节点</span><br><span class="line">[root@k8s-master1 demo]# calicoctl node status</span><br><span class="line">Calico process is running.</span><br><span class="line"></span><br><span class="line">IPv4 BGP status</span><br><span class="line">+---------------+---------------+-------+----------+-------------+</span><br><span class="line">| PEER ADDRESS  |   PEER TYPE   | STATE |  SINCE   |    INFO     |</span><br><span class="line">+---------------+---------------+-------+----------+-------------+</span><br><span class="line">| 192.168.0.103 | node specific | up    | 02:56:50 | Established |</span><br><span class="line">+---------------+---------------+-------+----------+-------------+</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# ip route</span><br><span class="line">default via 192.168.0.2 dev eth0 proto static metric 100 </span><br><span class="line">10.244.36.64/26 via 192.168.0.102 dev eth0 proto bird </span><br><span class="line">blackhole 10.244.159.128/26 proto bird </span><br><span class="line">10.244.159.130 dev cali1f778af678e scope link </span><br><span class="line">10.244.169.128/26 via 192.168.0.103 dev eth0 proto bird </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl get pods -o wide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">my-nginx-77fdbc8556-6qfxs   1/1     Running   0          28s   10.244.169.130   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-wc4mr   1/1     Running   0          28s   10.244.159.130   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-z9cpp   1/1     Running   0          28s   10.244.36.67     k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line"># 网络可以通</span><br><span class="line">[root@k8s-master1 demo]# ping 10.244.169.130</span><br><span class="line">[root@k8s-master1 demo]# ping 10.244.36.67</span><br><span class="line">PING 10.244.36.67 (10.244.36.67) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.244.36.67: icmp_seq=1 ttl=63 time=1.01 ms</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 使用路由反射器解决当bgp越来越大时的路由消耗</span><br><span class="line"># RP模式可以设置多个节点,再其他的node上打个标签 就会自动加入进来</span><br><span class="line"># 一般两个节点以上</span><br><span class="line">kubectl label node k8s-node1 route-reflector=true </span><br><span class="line">calicoctl get node k8s-node2 -o yaml &gt; node.yaml</span><br><span class="line">增加:routeReflectorClusterID: 244.0.0.1   # 集群ID</span><br><span class="line"></span><br><span class="line"># 不允许跨VLAN 2层传输 源地址和目的地址都是容器 </span><br><span class="line"># 增加路由器 每个集群pod的网段和节点下一跳 才可以跨vlan 需要验证</span><br><span class="line"># 得把容器的网段写成静态路由</span><br><span class="line"></span><br><span class="line"># IPIP 支持跨子网</span><br></pre></td></tr></table></figure>
<h3 id="IPIP-模式"><a href="#IPIP-模式" class="headerlink" title="IPIP 模式"></a>IPIP 模式</h3><ol>
<li>在前面提到过，Flannel host-gw 模式最主要的限制，就是要求集群宿主机之间是二层连通的。</li>
<li>而这个限制对于 Calico 来说，也同样存在。</li>
</ol>
<p><strong>修改为IPIP模式：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# calicoctl get ipPool -o yaml &gt; ipip.yaml</span><br><span class="line">[root@k8s-master1 demo]# vim ipip.yaml </span><br><span class="line">...</span><br><span class="line">    cidr: 10.244.0.0/16</span><br><span class="line">    ipipMode: Always</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># 也可以在原来的yaml里面修改 再重新创建</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# calicoctl apply -f ipip.yaml</span><br><span class="line">Successfully applied 1 'IPPool' resource(s)</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# calicoctl get ippool -o wide</span><br><span class="line">NAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR   </span><br><span class="line">default-ipv4-ippool   10.244.0.0/16   true   Always     Never       false      all()</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># ip route 变化 tunl0 隧道网卡 有自己的IP 10.244.159.131</span><br><span class="line">[root@k8s-master1 demo]# ip route</span><br><span class="line">10.244.36.64/26 via 192.168.0.102 dev tunl0 proto bird onlink </span><br><span class="line">blackhole 10.244.159.128/26 proto bird </span><br><span class="line">10.244.159.130 dev cali1f778af678e scope link </span><br><span class="line">10.244.169.128/26 via 192.168.0.103 dev tunl0 proto bird onlink </span><br><span class="line"></span><br><span class="line"># bgp支持2层网络,如果要实现3层,那么需要路由器</span><br><span class="line"># 原先的数据包中 源IP是容器IP 目的IP也是容器IP 但是路由器里没有相应规则,所以数据不可达</span><br><span class="line"># 要想实现数据可达,需要一层路由器,并完成路由表信息</span><br><span class="line"># IPIP 模式 可以对数据包进行隧道 与 VXLAN类似</span><br><span class="line"># IPIP 也将原始数据包 进行封装和解封装</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_370.png" width="50%"> </p>
<p><strong>IPIP示意图：</strong></p>
<p><img src="/img/k8s/k8s_369.png" width="50%"> </p>
<p><strong>Pod 1 访问 Pod 2大致流程如下：</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 数据包从容器1出,到达Veth Pair另一端（宿主机上，以cali前缀开头）；</span><br><span class="line">2. 进入IP隧道设备（tunl0），由Linux内核IPIP驱动封装在宿主机网络的IP包中（新的IP包目的地之是原IP包的下一跳地址，即192.168.31.63），这样，就成了Node1 到Node2的数据包；</span><br><span class="line">3. 数据包经过路由器三层转发到Node2；</span><br><span class="line">4. Node2收到数据包后，网络协议栈会使用IPIP驱动进行解包，从中拿到原始IP包；</span><br><span class="line">5. 然后根据路由规则，根据路由规则将数据包转发给cali设备，从而到达容器2。</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# kubectl get pods -o wide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">my-nginx-77fdbc8556-gfqd5   1/1     Running   0          12m   10.244.36.72     k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-sm5ln   1/1     Running   0          12m   10.244.159.135   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-tbm4n   1/1     Running   0          12m   10.244.169.132   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line"># 10.244.36.72 -&gt; 10.244.169.132 流程:</span><br><span class="line"># 10.244.36.72 -&gt; pod calif -&gt; 10.244.169.132/26 via 192.168.0.103 dev tunl0 proto bird onlink</span><br><span class="line"># -&gt; 10.244.169.132 dev cali8567c6b7944 scope link -&gt; pod calif -&gt; 10.244.169.132</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 里面一层 容器到容器数据包 原始IP包</span><br><span class="line">源IP： 10.244.1.10</span><br><span class="line">目的IP: 10.244.2.10</span><br><span class="line"></span><br><span class="line"># 外面一层 两个宿主机 TCP</span><br><span class="line">源IP：  192.168.31.62</span><br><span class="line">目的IP: 192.168.32.63</span><br><span class="line"></span><br><span class="line"># IPIP与 VXLAN一样 工作在三层</span><br><span class="line"># bgp 与 host-gw 工作在二层</span><br></pre></td></tr></table></figure>
<ol>
<li>不难看到，当 Calico 使用 IPIP 模式的时候，集群的网络性能会因为额外的封包和解包工作而下降。</li>
<li>所以建议你将所有宿主机节点放在一个子网里，避免使用 IPIP。</li>
</ol>
<h3 id="CNI-网络方案优缺点及最终选择"><a href="#CNI-网络方案优缺点及最终选择" class="headerlink" title="CNI 网络方案优缺点及最终选择"></a>CNI 网络方案优缺点及最终选择</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">先考虑几个问题： </span><br><span class="line">- 需要细粒度网络访问控制？      Calico 支持 acl ,  Flannel 不支持 acl</span><br><span class="line">- 追求网络性能？               bgp 或者 host-gw</span><br><span class="line">- 服务器之间是否可以跑BGP协议？ 公有云不支持bgp协议</span><br><span class="line">- 集群规模多大？               简单的 Flannel </span><br><span class="line">- 是否有维护能力？             Calico 路由多 一旦出现问题 查看起来非常难</span><br></pre></td></tr></table></figure>
<h3 id="办公网络与K8S网络如何互通"><a href="#办公网络与K8S网络如何互通" class="headerlink" title="办公网络与K8S网络如何互通"></a>办公网络与K8S网络如何互通</h3><ol>
<li>测试环境 k8s 集群</li>
<li>开发人员 办公网络</li>
<li>微服务通过 podip 调用 </li>
<li>办公网络 如何 访问 podip  打通网络</li>
</ol>
<p><img src="/img/k8s/k8s_371.png" width="50%"> </p>
<h2 id="网络策略"><a href="#网络策略" class="headerlink" title="网络策略"></a>网络策略</h2><h3 id="为什么需要网络隔离？"><a href="#为什么需要网络隔离？" class="headerlink" title="为什么需要网络隔离？"></a>为什么需要网络隔离？</h3><ol>
<li>CNI插件插件解决了不同Node节点Pod互通问题，从而形成一个扁平化网络，默认情况下，Kubernetes 网络允许所有 Pod 到 Pod 的流量</li>
<li><p>在一些场景中，我们不希望Pod之间默认相互访问，例如：</p>
<ul>
<li>应用程序间的访问控制。例如微服务A允许访问微服务B，微服务C不能访问微服务A</li>
<li>开发环境命名空间不能访问测试环境命名空间Pod</li>
<li>当Pod暴露到外部时，需要做Pod白名单</li>
<li>多租户网络环境隔离</li>
</ul>
</li>
<li><p>所以，我们需要使用<strong>network policy</strong>对Pod网络进行隔离。支持对Pod级别和Namespace级别网络访问控制。</p>
</li>
<li><p>acl Pod网络<strong>入口</strong>方向隔离 </p>
<ul>
<li>基于Pod级网络隔离：只允许特定对象访问Pod（使用标签定义），允许白名单上的IP地址或者IP段访问Pod</li>
<li>基于Namespace级网络隔离：多个命名空间，A和B命名空间Pod完全隔离。</li>
</ul>
</li>
<li><p>acl Pod网络<strong>出口</strong>方向隔离</p>
<ul>
<li>拒绝某个Namespace上所有Pod访问外部</li>
<li>基于目的IP的网络隔离：只允许Pod访问白名单上的IP地址或者IP段</li>
<li>基于目标端口的网络隔离：只允许Pod访问白名单上的端口</li>
</ul>
</li>
</ol>
<p><img src="/img/k8s/k8s_372.png" width="50%"> </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. 对 default 空间下 带标签  role: db 的pod 做网络策略</span><br><span class="line">2. 入口策略: 这个网段 cidr: 172.17.0.0/16 除了 172.17.1.0/24 以外的ip 都可以访问</span><br><span class="line">3. myproject 这个命名空间 可以访问 </span><br><span class="line">4. 标签有 role: frontend 的pod 可以访问</span><br><span class="line">5. 可以访问的port是 6379端口 </span><br><span class="line">6. 出口策略: 可以访问 10.0.0.0/24 这个网段的 5978端口</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">配置解析：</span><br><span class="line">- podSelector：用于选择策略应用到的Pod组。</span><br><span class="line">- policyTypes：其可以包括任一Ingress，Egress或两者。该policyTypes字段指示给定的策略用于Pod的入站流量、还是出站流量，或者两者都应用。如果未指定任何值，则默认值为Ingress，如果网络策略有出口规则，则设置egress。</span><br><span class="line">- Ingress：from是可以访问的白名单，可以来自于IP段、命名空间、Pod标签等，ports是可以访问的端口。</span><br><span class="line">- Egress：这个Pod组可以访问外部的IP段和端口。</span><br></pre></td></tr></table></figure>
<h3 id="入站、出站网络流量访问控制案例"><a href="#入站、出站网络流量访问控制案例" class="headerlink" title="入站、出站网络流量访问控制案例"></a>入站、出站网络流量访问控制案例</h3><p><strong>Pod访问限制</strong></p>
<ol>
<li>准备测试环境，1组web pod，2个client pod</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# kubectl get pods -o wide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">my-nginx-77fdbc8556-gfqd5   1/1     Running   0          53m   10.244.36.72     k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-sm5ln   1/1     Running   0          53m   10.244.159.135   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-tbm4n   1/1     Running   0          53m   10.244.169.132   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl get pods --show-labels</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">my-nginx-77fdbc8556-gfqd5   1/1     Running   0          54m   app=my-nginx,pod-template-hash=77fdbc8556</span><br><span class="line">my-nginx-77fdbc8556-sm5ln   1/1     Running   0          54m   app=my-nginx,pod-template-hash=77fdbc8556</span><br><span class="line">my-nginx-77fdbc8556-tbm4n   1/1     Running   0          54m   app=my-nginx,pod-template-hash=77fdbc8556</span><br><span class="line"></span><br><span class="line">1. 限制当前命名空间下 app=my-nginx pod 做网络隔离 </span><br><span class="line">2. 只允许default命名空间携带run=client1标签的Pod访问 80端口</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# vim ns.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: test-network-policy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  podSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: my-nginx</span><br><span class="line">  policyTypes:</span><br><span class="line">  - Ingress</span><br><span class="line">  ingress:</span><br><span class="line">  - from:</span><br><span class="line">    - namespaceSelector:</span><br><span class="line">        matchLabels:</span><br><span class="line">          project: default</span><br><span class="line">    - podSelector:</span><br><span class="line">        matchLabels:</span><br><span class="line">          run: client1</span><br><span class="line">    ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">隔离策略配置：</span><br><span class="line">1. Pod对象:           default命名空间携带app: my-nginx标签的Pod</span><br><span class="line">2. 允许访问端口：      80</span><br><span class="line">3. 允许访问对象：      default命名空间携带run=client1标签的Pod</span><br><span class="line">4. 拒绝访问对象：      除允许访问对象外的所有对象</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 先在不做策略的时候 测试访问 run client1 和 run client2 </span><br><span class="line">[root@k8s-master1 demo]# kubectl run client1 --generator=run-pod/v1 --image=busybox --command -- sleep 36000</span><br><span class="line">[root@k8s-master1 demo]# kubectl run client2 --generator=run-pod/v1 --image=busybox --command -- sleep 36000</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl get pods --show-labels</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE     LABELS</span><br><span class="line">client1                     1/1     Running   0          3m20s   run=client1</span><br><span class="line">client2                     1/1     Running   0          4s      run=client2</span><br><span class="line">my-nginx-77fdbc8556-gfqd5   1/1     Running   0          64m     app=my-nginx,pod-template-hash=77fdbc8556</span><br><span class="line">my-nginx-77fdbc8556-sm5ln   1/1     Running   0          64m     app=my-nginx,pod-template-hash=77fdbc8556</span><br><span class="line">my-nginx-77fdbc8556-tbm4n   1/1     Running   0          64m     app=my-nginx,pod-template-hash=77fdbc8556</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl get pods -o wide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">client1                     1/1     Running   0          73s   10.244.169.133   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-gfqd5   1/1     Running   0          61m   10.244.36.72     k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-sm5ln   1/1     Running   0          61m   10.244.159.135   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-tbm4n   1/1     Running   0          61m   10.244.169.132   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it client1 sh</span><br><span class="line"># 可以ping通pod </span><br><span class="line">/ # ping 10.244.36.72</span><br><span class="line">PING 10.244.36.72 (10.244.36.72): 56 data bytes</span><br><span class="line">64 bytes from 10.244.36.72: seq=0 ttl=62 time=33.420 ms</span><br><span class="line"></span><br><span class="line"># 可以访问80 下载页面</span><br><span class="line">/ # wget 10.244.36.72</span><br><span class="line">Connecting to 10.244.36.72 (10.244.36.72:80)</span><br><span class="line">saving to 'index.html'</span><br><span class="line">index.html           100% |********************************************************************************************************************************************************************************************|   612  0:00:00 ETA</span><br><span class="line">'index.html' saved</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it client2 sh</span><br><span class="line">/ # wget 10.244.36.72</span><br><span class="line">saving to 'index.html'</span><br><span class="line">index.html           100% |********************************************************************************************************************************************************************************************|   612  0:00:00 ETA</span><br><span class="line">'index.html' saved</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 增加规则 </span><br><span class="line"># Calico 支持 acl , Flannel 不支持 acl , Flannel 没法做 NetworkPolicy</span><br><span class="line">[root@k8s-master1 demo]# kubectl apply -f ns.yaml </span><br><span class="line">networkpolicy.networking.k8s.io/test-network-policy created</span><br><span class="line"># 规则是 只有携带  run=client1 标签的pod 可以访问</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 测试</span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it client2 sh</span><br><span class="line">/ # rm -rf index.html </span><br><span class="line">/ # wget 10.244.36.72</span><br><span class="line">Connecting to 10.244.36.72 (10.244.36.72:80)   # 不通，无法访问</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it client1 sh</span><br><span class="line">/ # rm -rf index.html </span><br><span class="line">/ # wget 10.244.36.72</span><br><span class="line">Connecting to 10.244.36.72 (10.244.36.72:80)</span><br><span class="line">saving to 'index.html'</span><br><span class="line">index.html           100% |********************************************************************************************************************************************************************************************|   612  0:00:00 ETA</span><br><span class="line">'index.html' saved</span><br><span class="line"></span><br><span class="line"># client1 可以下载访问</span><br><span class="line"># client2 无法下载访问</span><br><span class="line"># 实际环境 多加上几组标签,精确粒度限制</span><br></pre></td></tr></table></figure>
<p><strong>命名空间隔离</strong> </p>
<ol>
<li>两个开发团队,都有自己的命名空间,他们之间的pod都不可以相互访问 </li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# kubectl run client3 --generator=run-pod/v1 --image=busybox -n kube-system --command -- sleep 36000</span><br><span class="line"># 取消刚才的限制 </span><br><span class="line">[root@k8s-master1 demo]# kubectl delete -f ns.yaml </span><br><span class="line">networkpolicy.networking.k8s.io "test-network-policy" deleted</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# kubectl get pods -o wide</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">client1                     1/1     Running   0          27m   10.244.169.133   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">client2                     1/1     Running   0          24m   10.244.169.134   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-gfqd5   1/1     Running   0          88m   10.244.36.72     k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-sm5ln   1/1     Running   0          88m   10.244.159.135   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">my-nginx-77fdbc8556-tbm4n   1/1     Running   0          88m   10.244.169.132   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl get pods -o wide -n kube-system</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE     IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">calico-kube-controllers-5cc7b68d7c-xb5rf   1/1     Running   1          7h15m   192.168.0.102    k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">calico-node-hwt8c                          1/1     Running   1          7h15m   192.168.0.103    k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">calico-node-v7c4g                          1/1     Running   1          7h15m   192.168.0.101    k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">calico-node-wfp2f                          1/1     Running   1          7h15m   192.168.0.102    k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">client3                                    1/1     Running   0          8m18s   10.244.159.136   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">coredns-6d8cfdd59d-6wwkz                   1/1     Running   1          6h54m   10.244.36.69     k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line"># 两个命名空间的pod 可以互通</span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it client3 sh -n kube-system</span><br><span class="line">/ # ping 10.244.36.72</span><br><span class="line">PING 10.244.36.72 (10.244.36.72): 56 data bytes</span><br><span class="line">64 bytes from 10.244.36.72: seq=0 ttl=62 time=0.630 ms</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 需求：</span><br><span class="line">1. default命名空间下所有pod可以互相访问，</span><br><span class="line">2. 其他命名空间不能访问default命名空间Pod。</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# vim ns2.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: NetworkPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: deny-from-other-namespaces </span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  podSelector: &#123;&#125;</span><br><span class="line">  policyTypes:</span><br><span class="line">  - Ingress</span><br><span class="line">  ingress:</span><br><span class="line">  - from:</span><br><span class="line">    - podSelector: &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"># podSelector: &#123;&#125;：      default命名空间下所有Pod</span><br><span class="line"># from.podSelector: &#123;&#125; : 如果未配置具体的规则，默认不允许</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 执行测试</span><br><span class="line">[root@k8s-master1 demo]# kubectl apply -f ns2.yaml </span><br><span class="line">networkpolicy.networking.k8s.io/deny-from-other-namespaces created</span><br><span class="line"></span><br><span class="line"># kube-system下的client3无法ping通 default下的pod</span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it client3 sh -n kube-system</span><br><span class="line">/ # ping 10.244.36.72</span><br><span class="line">PING 10.244.36.72 (10.244.36.72): 56 data bytes</span><br><span class="line"></span><br><span class="line"># default下的pod 可以正常互通</span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it client2 sh </span><br><span class="line">/ # ping 10.244.36.72</span><br><span class="line">PING 10.244.36.72 (10.244.36.72): 56 data bytes</span><br><span class="line">64 bytes from 10.244.36.72: seq=0 ttl=62 time=13.809 ms</span><br><span class="line"></span><br><span class="line"># 也可以ping通 kube-system 下的</span><br><span class="line">/ # ping 10.244.159.136</span><br><span class="line">PING 10.244.159.136 (10.244.159.136): 56 data bytes</span><br><span class="line">64 bytes from 10.244.159.136: seq=0 ttl=62 time=0.538 ms</span><br><span class="line"></span><br><span class="line"># 测试dns解析 需要部署 busybox镜像 指定版本 1.28.4</span><br></pre></td></tr></table></figure>
<h3 id="Flannel-实现网络隔离"><a href="#Flannel-实现网络隔离" class="headerlink" title="Flannel 实现网络隔离"></a>Flannel 实现网络隔离</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1. 需要 canal 插件支持</span><br><span class="line">2. 阿里云可以试试 vpc 能不能跑 Calico bgp</span><br><span class="line">3. 虚拟机可以跑 Calico </span><br><span class="line"></span><br><span class="line">机房: </span><br><span class="line">1. Calico bgp 打通</span><br><span class="line">2. 路由反射器</span><br><span class="line">3. 对接每个节点的网关路由器</span><br><span class="line">4. lvs 对 pod 做负载均衡 </span><br><span class="line"></span><br><span class="line">支持:</span><br><span class="line">Calico BGP  1000个节点以内</span><br><span class="line">Flannel     100个节点以内 </span><br><span class="line">大公司有资源</span><br><span class="line">小公司还是 一个业务一个圈子好一些</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1. 阿里云主机 </span><br><span class="line">    Flannel:</span><br><span class="line">		vxlan     互通</span><br><span class="line">		host-gw   不通</span><br><span class="line">    Calico:</span><br><span class="line">		bgp       不通</span><br><span class="line">		Route Reflector 模式（RR）不通</span><br><span class="line">		ipip      未测试</span><br><span class="line">	</span><br><span class="line">2. 本地虚拟机</span><br><span class="line">    Flannel:</span><br><span class="line">		vxlan     互通</span><br><span class="line">		host-gw   互通</span><br><span class="line">    Calico:</span><br><span class="line">		bgp       互通</span><br><span class="line">		Route Reflector 模式（RR）互通</span><br><span class="line">		ipip:     互通</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/06/k8s-base07/" rel="next" title="05 Helm 应用包管理器">
                <i class="fa fa-chevron-left"></i> 05 Helm 应用包管理器
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/09/k8s-08/" rel="prev" title="08 Kubernetes 控制器（管理Pod）">
                08 Kubernetes 控制器（管理Pod） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/Greeen.jpg" alt="Harris Li">
            
              <p class="site-author-name" itemprop="name">Harris Li</p>
              <p class="site-description motion-element" itemprop="description">Beijing</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">108</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#交换和路由"><span class="nav-number">1.</span> <span class="nav-text">交换和路由</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#交换技术"><span class="nav-number">1.1.</span> <span class="nav-text">交换技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#重点1-在一个2层交换机下的两台服务器的通信流程"><span class="nav-number">1.1.1.</span> <span class="nav-text">重点1: 在一个2层交换机下的两台服务器的通信流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重点2-不在一个局域网之内-主机A-和-主机B-通信流程"><span class="nav-number">1.1.2.</span> <span class="nav-text">重点2: 不在一个局域网之内,主机A 和 主机B 通信流程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-网络模型"><span class="nav-number">2.</span> <span class="nav-text">Kubernetes 网络模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-网络组件之-Flannel"><span class="nav-number">3.</span> <span class="nav-text">Kubernetes 网络组件之 Flannel</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Flannel-部署"><span class="nav-number">3.1.</span> <span class="nav-text">Flannel 部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Flannel-工作模式及原理"><span class="nav-number">3.2.</span> <span class="nav-text">Flannel 工作模式及原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VXLAN"><span class="nav-number">3.3.</span> <span class="nav-text">VXLAN</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VXLAN-数据包的传输流程"><span class="nav-number">3.4.</span> <span class="nav-text">VXLAN 数据包的传输流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#veth-pair-对"><span class="nav-number">3.4.1.</span> <span class="nav-text">veth pair(对)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Host-GW"><span class="nav-number">3.5.</span> <span class="nav-text">Host-GW</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小总结"><span class="nav-number">3.6.</span> <span class="nav-text">小总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#阿里云主机的-host-gw方案不通"><span class="nav-number">3.7.</span> <span class="nav-text">阿里云主机的 host-gw方案不通</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-网络方案之-Calico"><span class="nav-number">4.</span> <span class="nav-text">Kubernetes 网络方案之 Calico</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BGP-概述"><span class="nav-number">4.1.</span> <span class="nav-text">BGP 概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Calico-BGP实现"><span class="nav-number">4.2.</span> <span class="nav-text">Calico BGP实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Calico-部署"><span class="nav-number">4.3.</span> <span class="nav-text">Calico 部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Calico-管理工具"><span class="nav-number">4.4.</span> <span class="nav-text">Calico 管理工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Calico-BGP-原理剖析"><span class="nav-number">4.5.</span> <span class="nav-text">Calico BGP 原理剖析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Route-Reflector-模式（RR）"><span class="nav-number">4.6.</span> <span class="nav-text">Route Reflector 模式（RR）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPIP-模式"><span class="nav-number">4.7.</span> <span class="nav-text">IPIP 模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CNI-网络方案优缺点及最终选择"><span class="nav-number">4.8.</span> <span class="nav-text">CNI 网络方案优缺点及最终选择</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#办公网络与K8S网络如何互通"><span class="nav-number">4.9.</span> <span class="nav-text">办公网络与K8S网络如何互通</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网络策略"><span class="nav-number">5.</span> <span class="nav-text">网络策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么需要网络隔离？"><span class="nav-number">5.1.</span> <span class="nav-text">为什么需要网络隔离？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#入站、出站网络流量访问控制案例"><span class="nav-number">5.2.</span> <span class="nav-text">入站、出站网络流量访问控制案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Flannel-实现网络隔离"><span class="nav-number">5.3.</span> <span class="nav-text">Flannel 实现网络隔离</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Harris Li</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
