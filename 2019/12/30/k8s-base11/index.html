<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="k8s,">










<meta name="keywords" content="k8s">
<meta property="og:type" content="article">
<meta property="og:title" content="09 基于 K8S 构建 Jenkins 微服务发布平台">
<meta property="og:url" content="https://touchlixiang.github.io/2019/12/30/k8s-base11/index.html">
<meta property="og:site_name" content="My Notes">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://touchlixiang.github.io/img/mix_3.jpg">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_260.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_261.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_262.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_263.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_264.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_265.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_266.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_267.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_268.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_275.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_269.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_270.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_271.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_272.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_273.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_274.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_276.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_277.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_278.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_279.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_280.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_281.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_282.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_283.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_284.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_285.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_285.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_286.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_287.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_288.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_289.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_290.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_291.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_292.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_293.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_294.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_295.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_296.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_297.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_298.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_299.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_300.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_301.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_302.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_303.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_304.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_305.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_306.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_307.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_308.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_309.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_310.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_311.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_312.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_313.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_315.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_314.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_316.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_317.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_318.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_319.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_320.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_321.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_322.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_323.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_324.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_325.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_326.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_327.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_328.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_329.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_330.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_331.png">
<meta property="og:updated_time" content="2020-01-07T10:42:18.490Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="09 基于 K8S 构建 Jenkins 微服务发布平台">
<meta name="twitter:image" content="https://touchlixiang.github.io/img/mix_3.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://touchlixiang.github.io/2019/12/30/k8s-base11/">





  <title>09 基于 K8S 构建 Jenkins 微服务发布平台 | My Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">My Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记不住的一定要写在这里</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://touchlixiang.github.io/2019/12/30/k8s-base11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Harris Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/Greeen.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">09 基于 K8S 构建 Jenkins 微服务发布平台</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-30T08:02:01+08:00">
                2019-12-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="/img/mix_3.jpg" width="50%"><br><a id="more"></a></p>
<h2 id="发布流程设计"><a href="#发布流程设计" class="headerlink" title="发布流程设计"></a>发布流程设计</h2><p><img src="/img/k8s/k8s_260.png" width="50%"></p>
<ol>
<li>拉取代码</li>
<li>编译</li>
<li>把jar包打到镜像里</li>
<li>部署到k8s平台,写yaml文件</li>
<li>暴露你的应用 </li>
</ol>
<h2 id="准备基础环境"><a href="#准备基础环境" class="headerlink" title="准备基础环境"></a>准备基础环境</h2><ol>
<li>K8S（Ingress Controller，CoreDNS） </li>
<li>Helm v3</li>
<li>Gitlab</li>
<li>Harbor 并启用Chart存储功能</li>
<li>MySQL（微服务数据库）</li>
<li>eureka 注册中心</li>
</ol>
<h3 id="K8S-环境"><a href="#K8S-环境" class="headerlink" title="K8S 环境"></a>K8S 环境</h3><h4 id="coredns"><a href="#coredns" class="headerlink" title="coredns"></a>coredns</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# kubectl get pods -n kube-system</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d8cfdd59d-k5wl9      1/1     Running   12         6d18h</span><br><span class="line">kube-flannel-ds-amd64-2k5kz   1/1     Running   6          6d18h</span><br><span class="line">kube-flannel-ds-amd64-gvs6b   1/1     Running   12         6d18h</span><br><span class="line">kube-flannel-ds-amd64-hwglz   1/1     Running   13         6d18h</span><br></pre></td></tr></table></figure>
<h4 id="ingress"><a href="#ingress" class="headerlink" title="ingress"></a>ingress</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# kubectl get pods -n ingress-nginx</span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-ingress-controller-2zvq5   1/1     Running   6          6d18h</span><br><span class="line">nginx-ingress-controller-9hq5n   1/1     Running   13         6d18h</span><br><span class="line">nginx-ingress-controller-k5vsm   1/1     Running   12         6d18h</span><br></pre></td></tr></table></figure>
<h4 id="PV自动供给-NFS"><a href="#PV自动供给-NFS" class="headerlink" title="PV自动供给 NFS"></a>PV自动供给 NFS</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># NFS服务器,每个Node上安装nfs-utils包，用于mount挂载时用</span><br><span class="line">[root@k8s-node2 ~]# yum install nfs-utils</span><br><span class="line"></span><br><span class="line">[root@k8s-node2 ~]# vi /etc/exports</span><br><span class="line">/ifs/kubernetes *(rw,no_root_squash)</span><br><span class="line"></span><br><span class="line">[root@k8s-node2 ~]# mkdir -p /ifs/kubernetes</span><br><span class="line">[root@k8s-node2 ~]# systemctl daemon-reload</span><br><span class="line">[root@k8s-node2 ~]# systemctl start nfs</span><br><span class="line">[root@k8s-node2 ~]# systemctl enable nfs</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># 由于K8S不支持NFS动态供给，还需要先安装上图中的nfs-client-provisioner插件</span><br><span class="line">[root@k8s-master1 opt]# unzip nfs-client.zip </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 opt]# cd nfs-client</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs-client]# ls -l</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 root root  225 Jan  6 14:48 class.yaml       # StorageClass 声明使用哪种存储插件，它来对接存储,设置好 StorageClass 名称</span><br><span class="line">-rw-r--r-- 1 root root  981 Jan  5 10:36 deployment.yaml  # 该服务帮我们自动创建 pv</span><br><span class="line">-rw-r--r-- 1 root root 1526 Jan  5 10:36 rbac.yaml        # 动态创建pv插件需要连接apiserver ，所以需要授权</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs-client]# vim deployment.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nfs-client-provisioner</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nfs-client-provisioner</span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs-client-provisioner</span><br><span class="line">          image: lizhenliang/nfs-client-provisioner:latest</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs-client-root</span><br><span class="line">              mountPath: /persistentvolumes</span><br><span class="line">          env:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: fuseim.pri/ifs</span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: 172.31.228.53</span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /ifs/kubernetes</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: 172.31.228.53</span><br><span class="line">            path: /ifs/kubernetes</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 创建 pv 动态供给 </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs-client]# kubectl apply -f class.yaml </span><br><span class="line">[root@k8s-master1 nfs-client]# kubectl apply -f rbac.yaml </span><br><span class="line">[root@k8s-master1 nfs-client]# kubectl apply -f deployment.yaml </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs-client]# kubectl get sc</span><br><span class="line">NAME                  PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri/ifs   47s</span><br><span class="line"></span><br><span class="line"># 查看自动创建pv的pod,当申请资源的时候这个pod会自动去创建pv</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs-client]#  kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner-769f87c8f6-7hn29   1/1     Running   0          51s</span><br></pre></td></tr></table></figure>
<h3 id="应用包管理器-Helm-V3"><a href="#应用包管理器-Helm-V3" class="headerlink" title="应用包管理器 Helm V3"></a>应用包管理器 Helm V3</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 opt]# wget https://get.helm.sh/helm-v3.0.0-linux-amd64.tar.gz</span><br><span class="line">[root@k8s-master1 opt]# tar zxvf helm-v3.0.0-linux-amd64.tar.gz </span><br><span class="line">[root@k8s-master1 opt]# mv linux-amd64/helm /usr/bin/</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 配置国内Chart仓库 </span><br><span class="line">[root@k8s-master1 opt]# helm repo add stable http://mirror.azure.cn/kubernetes/charts</span><br><span class="line">[root@k8s-master1 opt]# helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 opt]# helm repo list</span><br><span class="line">NAME  	URL                                                   </span><br><span class="line">stable	http://mirror.azure.cn/kubernetes/charts              </span><br><span class="line">aliyun	https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 opt]# helm search repo mysql</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 安装 push 插件</span><br><span class="line">helm plugin install https://github.com/chartmuseum/helm-push</span><br><span class="line"></span><br><span class="line"># 如果网络下载不了，也可以直接解压课件里包：</span><br><span class="line">tar zxvf helm-push_0.7.1_linux_amd64.tar.gz</span><br><span class="line">mkdir -p /root/.local/share/helm/plugins/helm-push</span><br><span class="line">chmod +x bin/*</span><br><span class="line">mv bin plugin.yaml /root/.local/share/helm/plugins/helm-push</span><br></pre></td></tr></table></figure>
<h3 id="微服务数据库-MySQL"><a href="#微服务数据库-MySQL" class="headerlink" title="微服务数据库 MySQL"></a>微服务数据库 MySQL</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master2]# yum -y install mariadb mariadb-server</span><br><span class="line">[root@k8s-master2]# systemctl start mariadb</span><br><span class="line">[root@k8s-master2]# systemctl enable mariadb</span><br><span class="line">[root@k8s-master2]# mysql_secure_installation</span><br><span class="line"></span><br><span class="line"># 授权访问用户</span><br><span class="line">[root@k8s-master2]# mysql -uroot -p</span><br><span class="line">MariaDB [(none)]&gt; grant all on *.* to 'root'@'%' identified by '123456';</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 将微服务数据库导入 </span><br><span class="line">[root@k8s-master1 db]# scp *.sql root@172.17.70.252:/tmp</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; create database tb_order CHARACTER SET utf8mb4;</span><br><span class="line">MariaDB [(none)]&gt; create database tb_stock CHARACTER SET utf8mb4;</span><br><span class="line">MariaDB [(none)]&gt; create database tb_product CHARACTER SET utf8mb4; </span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; use tb_order;</span><br><span class="line">MariaDB [tb_order]&gt; source /tmp/order.sql;</span><br><span class="line"></span><br><span class="line">MariaDB [tb_order]&gt; use tb_stock;</span><br><span class="line">MariaDB [tb_stock]&gt; source /tmp/stock.sql;</span><br><span class="line"></span><br><span class="line">MariaDB [tb_stock]&gt; use tb_product;</span><br><span class="line">MariaDB [tb_product]&gt; source /tmp/product.sql;</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| tb_order           |</span><br><span class="line">| tb_product         |</span><br><span class="line">| tb_stock           |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">7 rows in set (0.03 sec)</span><br></pre></td></tr></table></figure>
<h3 id="代码版本仓库-Gitlab"><a href="#代码版本仓库-Gitlab" class="headerlink" title="代码版本仓库 Gitlab"></a>代码版本仓库 Gitlab</h3><h4 id="docker-部署-gitlab"><a href="#docker-部署-gitlab" class="headerlink" title="docker 部署 gitlab"></a>docker 部署 gitlab</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master2 pinpoint-docker]# mkdir -p /opt/gitlab</span><br><span class="line">[root@k8s-master2 pinpoint-docker]# cd /opt/gitlab</span><br><span class="line"># 数据目录挂载在本机,之后备份该目录即可</span><br><span class="line">docker run -d \</span><br><span class="line">  --name gitlab \</span><br><span class="line">  -p 8443:443 \</span><br><span class="line">  -p 9999:80 \</span><br><span class="line">  -p 9998:22 \</span><br><span class="line">  -v $PWD/config:/etc/gitlab \</span><br><span class="line">  -v $PWD/logs:/var/log/gitlab \</span><br><span class="line">  -v $PWD/data:/var/opt/gitlab \</span><br><span class="line">  -v /etc/localtime:/etc/localtime \</span><br><span class="line">  lizhenliang/gitlab-ce-zh:latest</span><br><span class="line"></span><br><span class="line"># 稍微等待几分钟启动后</span><br><span class="line"># 访问地址：http://IP:9999</span><br><span class="line"># 初次会先设置管理员密码 ，然后登陆，默认管理员用户名root，密码就是刚设置的。</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_261.png" width="50%"></p>
<p><img src="/img/k8s/k8s_262.png" width="50%"></p>
<h3 id="镜像仓库-Harbor"><a href="#镜像仓库-Harbor" class="headerlink" title="镜像仓库 Harbor"></a>镜像仓库 Harbor</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"># 之前部署的步骤,按照实际IP填写 </span><br><span class="line"># 该主机也需要二进制安装docker </span><br><span class="line">[root@k8s-master2]# scp root@172.17.70.254:/opt/src/docker-18.09.6.tgz .</span><br><span class="line">[root@k8s-master2]# scp root@172.17.70.254:/usr/lib/systemd/system/docker.service .</span><br><span class="line">[root@k8s-master2]# scp root@172.17.70.254:/etc/docker/daemon.json .</span><br><span class="line">[root@k8s-master2]# tar -zxvf docker-18.09.6.tgz </span><br><span class="line">[root@k8s-master2]# mv docker/* /usr/bin/</span><br><span class="line">[root@k8s-master2]# mv docker.service /usr/lib/systemd/system</span><br><span class="line">[root@k8s-master2]# mkdir -p /etc/docker</span><br><span class="line">[root@k8s-master2]# mv daemon.json /etc/docker/</span><br><span class="line"></span><br><span class="line">[root@k8s-master2]# cat /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">    "registry-mirrors": ["http://bc437cce.m.daocloud.io"],          # 镜像加速</span><br><span class="line">    "insecure-registries": ["172.17.70.252"]                        # 可信任IP 回头换成harbor地址</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@k8s-node1 src]# systemctl start docker</span><br><span class="line">[root@k8s-node1 src]# systemctl enable docker</span><br><span class="line">[root@k8s-node1 src]# docker info</span><br><span class="line"></span><br><span class="line"># 上传文件</span><br><span class="line">[root@k8s-master2 src]# ls -l</span><br><span class="line">-rw-r--r-- 1 root root  17237024 Nov 13 14:33 docker-compose-Linux-x86_64</span><br><span class="line">-rw-r--r-- 1 root root 580462944 Nov 13 14:34 harbor-offline-installer-v1.8.4.tgz</span><br><span class="line"></span><br><span class="line"># 部署 compose</span><br><span class="line">[root@k8s-master2 src]# mv docker-compose-Linux-x86_64 /usr/local/bin/docker-compose</span><br><span class="line">[root@k8s-master2 src]# chmod +x /usr/local/bin/docker-compose </span><br><span class="line">[root@k8s-master2 src]# docker-compose -version</span><br><span class="line">docker-compose version 1.25.0dev, build bc57a1bd</span><br><span class="line"></span><br><span class="line"># 部署 harbor</span><br><span class="line">[root@k8s-master2 src]# tar -xf harbor-offline-installer-v1.8.4.tgz -C /opt/</span><br><span class="line">[root@k8s-master2 src]# cd /opt/harbor/</span><br><span class="line"># 修改主机名和管理员密码、数据库密码</span><br><span class="line">hostname: 172.17.70.252             # http</span><br><span class="line">harbor_admin_password: 123456       # 访问密码</span><br><span class="line">database:</span><br><span class="line">    password: 123456</span><br><span class="line"></span><br><span class="line"># 准备</span><br><span class="line">[root@k8s-master2 src]# ./prepare</span><br><span class="line"># 安装  --with-chartmuseum 参数表示启用Charts存储功能。</span><br><span class="line">[root@k8s-master2 src]# ./install.sh --with-chartmuseum</span><br><span class="line"># web访问</span><br><span class="line">http://123.56.14.192</span><br><span class="line"># 列出</span><br><span class="line">docker-compose ps</span><br><span class="line"></span><br><span class="line"># 配置Docker可信任 </span><br><span class="line">由于habor未配置https，还需要在docker配置可信</span><br><span class="line">[root@Docker harbor]# vim /etc/docker/daemon.json </span><br><span class="line"># 写入进项仓库 IP+port</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    "registry-mirrors": ["http://f1361db2.m.daocloud.io"],</span><br><span class="line">    "insecure-registries": ["172.17.70.252"]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 重启docker </span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker.service</span><br><span class="line"></span><br><span class="line">[root@Docker nginx]# docker info</span><br><span class="line">Insecure Registries:</span><br><span class="line"> 172.17.70.252</span><br><span class="line"> 127.0.0.0/8</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_263.png" width="50%"></p>
<h2 id="在-Kubernetes-中部署-Jenkins"><a href="#在-Kubernetes-中部署-Jenkins" class="headerlink" title="在 Kubernetes 中部署 Jenkins"></a>在 Kubernetes 中部署 Jenkins</h2><p><img src="/img/k8s/k8s_264.png" width="50%"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">参考：</span><br><span class="line">https://github.com/jenkinsci/kubernetes-plugin/tree/fc40c869edfd9e3904a9a56b0f80c5a25e988fa1/src/main/kubernetes</span><br></pre></td></tr></table></figure>
<ol>
<li>Jenkins 需要持久化存储</li>
<li>K8S的pod不固定,所以需要持久化存储 pv,pvc</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 opt]# unzip jenkins.zip </span><br><span class="line">Archive:  jenkins.zip</span><br><span class="line">   creating: jenkins/</span><br><span class="line">  inflating: jenkins/deployment.yml  </span><br><span class="line">  inflating: jenkins/ingress.yml     </span><br><span class="line">  inflating: jenkins/rbac.yml        </span><br><span class="line">  inflating: jenkins/service-account.yml  </span><br><span class="line">  inflating: jenkins/service.yml     </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 opt]# cd jenkins</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 jenkins]# ls -l</span><br><span class="line">-rw-r--r-- 1 root root 1953 Jan  5 10:36 deployment.yml</span><br><span class="line">-rw-r--r-- 1 root root  349 Jan  5 10:36 ingress.yml</span><br><span class="line">-rw-r--r-- 1 root root  908 Jan  5 10:36 rbac.yml               # 授权 k8s-apiserver  </span><br><span class="line">-rw-r--r-- 1 root root  914 Jan  5 10:36 service-account.yml    # 访问 k8s-apiserver 调度创建pod</span><br><span class="line">-rw-r--r-- 1 root root  270 Jan  5 10:36 service.yml</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 jenkins]# cat deployment.yml </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment </span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins</span><br><span class="line">  labels:</span><br><span class="line">    name: jenkins</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: jenkins </span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: jenkins</span><br><span class="line">      labels:</span><br><span class="line">        name: jenkins</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 10</span><br><span class="line">      serviceAccountName: jenkins</span><br><span class="line">      containers:</span><br><span class="line">        - name: jenkins</span><br><span class="line">          # 官方长期维护版本</span><br><span class="line">          image: jenkins/jenkins:lts </span><br><span class="line">          imagePullPolicy: Always</span><br><span class="line">          ports:</span><br><span class="line">            # 8080 ui</span><br><span class="line">            # 50000 slave访问master端口</span><br><span class="line">            - containerPort: 8080</span><br><span class="line">            - containerPort: 50000</span><br><span class="line">          resources:</span><br><span class="line">            limits:</span><br><span class="line">              cpu: 1</span><br><span class="line">              memory: 1Gi</span><br><span class="line">            requests:</span><br><span class="line">              cpu: 0.5</span><br><span class="line">              memory: 500Mi</span><br><span class="line">          env:</span><br><span class="line">            - name: LIMITS_MEMORY</span><br><span class="line">              valueFrom:</span><br><span class="line">                resourceFieldRef:</span><br><span class="line">                  resource: limits.memory</span><br><span class="line">                  divisor: 1Mi</span><br><span class="line">            - name: JAVA_OPTS</span><br><span class="line">              value: -Xmx$(LIMITS_MEMORY)m -XshowSettings:vm -Dhudson.slaves.NodeProvisioner.initialDelay=0 -Dhudson.slaves.NodeProvisioner.MARGIN=50 -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: jenkins-home</span><br><span class="line">              # 挂载点</span><br><span class="line">              mountPath: /var/jenkins_home</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /login</span><br><span class="line">              port: 8080</span><br><span class="line">            initialDelaySeconds: 60</span><br><span class="line">            timeoutSeconds: 5</span><br><span class="line">            failureThreshold: 12</span><br><span class="line">          readinessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              path: /login</span><br><span class="line">              port: 8080</span><br><span class="line">            initialDelaySeconds: 60</span><br><span class="line">            timeoutSeconds: 5</span><br><span class="line">            failureThreshold: 12</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 1000</span><br><span class="line">      volumes:</span><br><span class="line">        # 数据卷</span><br><span class="line">        - name: jenkins-home</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">            # pvc</span><br><span class="line">            claimName: jenkins-home</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  # 自动供给</span><br><span class="line">  name: jenkins-home</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: "managed-nfs-storage"</span><br><span class="line">  accessModes: ["ReadWriteOnce"]</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 5Gi</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 jenkins]# cat service.yml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    name: jenkins</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 8080</span><br><span class="line">      protocol: TCP</span><br><span class="line">      nodePort: 30006</span><br><span class="line">    - name: agent</span><br><span class="line">      port: 50000</span><br><span class="line">      protocol: TCP</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 jenkins]# cat ingress.yml </span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/ssl-redirect: "true"</span><br><span class="line">    nginx.ingress.kubernetes.io/proxy-body-size: 100m</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: jenkins.ctnrs.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: jenkins</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 创建</span><br><span class="line">[root@k8s-master1 jenkins]# kubectl apply -f .</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 jenkins]# kubectl get pods,svc,pv,pvc -o wide</span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE   IP            NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/jenkins-557cf6fd7f-nvwbp                  1/1     Running   0          10m   10.244.1.38   k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">pod/nfs-client-provisioner-769f87c8f6-7hn29   1/1     Running   0          99m   10.244.2.26   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                        AGE     SELECTOR</span><br><span class="line">service/jenkins      NodePort    10.0.0.47    <span class="tag">&lt;<span class="name">none</span>&gt;</span>        80:30006/TCP,50000:31324/TCP   10m     name=jenkins</span><br><span class="line">service/kubernetes   ClusterIP   10.0.0.1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>        443/TCP                        6d20h   <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                  STORAGECLASS          REASON   AGE   VOLUMEMODE</span><br><span class="line">persistentvolume/pvc-ffe668d2-1fd1-403d-87c6-739ccf6bd6ee   5Gi        RWO            Delete           Bound    default/jenkins-home   managed-nfs-storage            10m   Filesystem</span><br><span class="line"></span><br><span class="line">NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE   VOLUMEMODE</span><br><span class="line">persistentvolumeclaim/jenkins-home   Bound    pvc-ffe668d2-1fd1-403d-87c6-739ccf6bd6ee   5Gi        RWO            managed-nfs-storage   10m   Filesystem</span><br><span class="line"></span><br><span class="line"># 查看日志</span><br><span class="line">[root@k8s-master1 jenkins]# kubectl logs jenkins-557cf6fd7f-nvwbp -f</span><br><span class="line"></span><br><span class="line"># 初始化密码 启动日志中查看到 0791683090e046489635805ade39f81c</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># web访问</span><br><span class="line">http://47.240.14.16:30006/</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 修改时区 </span><br><span class="line"># 打开 【系统管理】-&gt;【脚本命令行】运行下面的命令</span><br><span class="line">System.setProperty('org.apache.commons.jelly.tags.fmt.timeZone', 'Asia/Shanghai')</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_265.png" width="50%"></p>
<p><img src="/img/k8s/k8s_266.png" width="50%"></p>
<p><img src="/img/k8s/k8s_267.png" width="50%"></p>
<p><img src="/img/k8s/k8s_268.png" width="50%"></p>
<p><img src="/img/k8s/k8s_275.png" width="50%"></p>
<h2 id="Jenkins-Pipeline"><a href="#Jenkins-Pipeline" class="headerlink" title="Jenkins Pipeline"></a>Jenkins Pipeline</h2><h3 id="Jenkins-Pipeline-及参数化构建"><a href="#Jenkins-Pipeline-及参数化构建" class="headerlink" title="Jenkins Pipeline 及参数化构建"></a>Jenkins Pipeline 及参数化构建</h3><ol>
<li>Jenkins Pipeline是一套插件，支持在Jenkins中实现集成和持续交付管道；</li>
<li>Pipeline通过特定语法对简单到复杂的传输管道进行建模；</li>
<li>声明式：遵循与Groovy相同语法。pipeline { }</li>
<li>脚本式：支持Groovy大部分功能，也是非常表达和灵活的工具。node { }</li>
<li>Jenkins Pipeline的定义被写入一个文本文件，称为Jenkinsfile。</li>
<li>参考</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://jenkins.io/doc/book/pipeline/syntax/</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_269.png" width="50%"></p>
<h3 id="安装插件-Jenkins-Pipeline"><a href="#安装插件-Jenkins-Pipeline" class="headerlink" title="安装插件 Jenkins Pipeline"></a>安装插件 Jenkins Pipeline</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 修改国内插件源</span><br><span class="line"># 修改实际下载插件地址</span><br><span class="line"># 在持久化目录中 </span><br><span class="line">[root@k8s-node2 kubernetes]# cd default-jenkins-home-pvc-ffe668d2-1fd1-403d-87c6-739ccf6bd6ee/</span><br><span class="line">[root@k8s-node2 default-jenkins-home-pvc-ffe668d2-1fd1-403d-87c6-739ccf6bd6ee]# cd updates </span><br><span class="line"></span><br><span class="line"># sed 批量替换</span><br><span class="line"># 替换清华源下载插件地址</span><br><span class="line">sed -i 's/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g' default.json</span><br><span class="line"># 替换URL检查地址</span><br><span class="line">sed -i 's/http:\/\/www.google.com/https:\/\/www.baidu.com/g' default.json</span><br><span class="line"></span><br><span class="line"># 页面重启 jenkins 服务</span><br><span class="line">http://47.240.14.16:30006/restart   YES</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 安装插件 </span><br><span class="line">http://47.240.14.16:30006/pluginManager/</span><br><span class="line"># 选择可用插件 搜索 Pipeline</span><br><span class="line">http://47.240.14.16:30006/pluginManager/available</span><br><span class="line"># 安装插件完成后 创建job出现 流水线 为正常</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_270.png" width="50%"></p>
<p><img src="/img/k8s/k8s_271.png" width="50%"></p>
<p><img src="/img/k8s/k8s_272.png" width="50%"></p>
<h3 id="创建测试-Pipeline"><a href="#创建测试-Pipeline" class="headerlink" title="创建测试 Pipeline"></a>创建测试 Pipeline</h3><p><img src="/img/k8s/k8s_273.png" width="50%"></p>
<ol>
<li>Pipeline 的脚本语法为 Groovy </li>
<li>选择一个声明式的用例粘贴出来去修改</li>
</ol>
<p><img src="/img/k8s/k8s_274.png" width="50%"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 基础语法</span><br><span class="line"># 1. stages:    大步骤,拉取代码 到编译、发布 每一步都为步骤</span><br><span class="line"># 2. stage:     小步骤,卸载一个大步骤里</span><br><span class="line"># 3. steps:     小步骤里面的小单元，具体任务的分节</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">   </span><br><span class="line">   stages &#123;</span><br><span class="line">      stage('1. 拉取代码') &#123;</span><br><span class="line">         steps &#123;</span><br><span class="line">		    echo 'Hello World'</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">	  </span><br><span class="line">	  stage('2. 代码编译') &#123;</span><br><span class="line">	     steps &#123;</span><br><span class="line">		    echo 'Hello World'</span><br><span class="line">         &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	  </span><br><span class="line">	  stage('3. 单元测试') &#123;</span><br><span class="line">	     steps &#123;</span><br><span class="line">		    echo 'Hello World'</span><br><span class="line">         &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	  </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_276.png" width="50%"></p>
<h3 id="参数化构建"><a href="#参数化构建" class="headerlink" title="参数化构建"></a>参数化构建</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 多个项目部署, 套用一个pipeline，找出不同点</span><br><span class="line">1. git地址</span><br><span class="line">2. 分支名</span><br><span class="line">3. 部署的机器</span><br><span class="line">4. 打出的包名</span><br><span class="line"></span><br><span class="line"># 知道不同点,那么可以使用参数化构建</span><br></pre></td></tr></table></figure>
<h4 id="流水线生成-git-项目地址"><a href="#流水线生成-git-项目地址" class="headerlink" title="流水线生成 git 项目地址"></a>流水线生成 git 项目地址</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 测试生成 git项目地址 选择框</span><br><span class="line">2. 复制代码到 pipeline </span><br><span class="line">3. 保存后先构建一次,再进入项目会看到 构建+参数选项</span><br><span class="line">4. 在这里就可以选择 发布项目的git地址</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">	parameters &#123;</span><br><span class="line">	  choice choices: ['172.31.228.51:9999/root/a.git', '172.31.228.51:9999/root/b.git', '172.31.228.51:9999/root/c.git'], description: '请选择要发布的项目git地址', name: 'git'</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">   stages &#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_277.png" width="50%"></p>
<p><img src="/img/k8s/k8s_278.png" width="50%"></p>
<p><img src="/img/k8s/k8s_279.png" width="50%"></p>
<p><img src="/img/k8s/k8s_280.png" width="50%"></p>
<h4 id="流水线生成-分支名"><a href="#流水线生成-分支名" class="headerlink" title="流水线生成 分支名"></a>流水线生成 分支名</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 动态参数化构建</span><br><span class="line"># 分支名需要动态的从选择的 git地址里面 后去所有分支</span><br></pre></td></tr></table></figure>
<h4 id="流水线生成-部署的机器"><a href="#流水线生成-部署的机器" class="headerlink" title="流水线生成 部署的机器"></a>流水线生成 部署的机器</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">	parameters &#123;</span><br><span class="line">	  choice choices: ['172.31.228.51:9999/root/a.git', '172.31.228.51:9999/root/b.git', '172.31.228.51:9999/root/c.git'], description: '请选择要发布的项目git地址', name: 'git'</span><br><span class="line">	  choice choices: ['172.31.228.50', '172.31.228.52', '172.31.228.53'], description: '请选择要发布到的服务器', name: 'host'</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_281.png" width="50%"></p>
<p><img src="/img/k8s/k8s_282.png" width="50%"></p>
<p><img src="/img/k8s/k8s_283.png" width="50%"></p>
<h3 id="脚本中获取参数"><a href="#脚本中获取参数" class="headerlink" title="脚本中获取参数"></a>脚本中获取参数</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 通过设置的Name 就是变量名获取值</span><br><span class="line"># pipeline 脚本中直接获取</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">   agent any</span><br><span class="line">	parameters &#123;</span><br><span class="line">	  choice choices: ['172.31.228.51:9999/root/a.git', '172.31.228.51:9999/root/b.git', '172.31.228.51:9999/root/c.git'], description: '请选择要发布的项目git地址', name: 'git'</span><br><span class="line">	  choice choices: ['172.31.228.50', '172.31.228.52', '172.31.228.53'], description: '请选择要发布到的服务器', name: 'host'</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">   stages &#123;</span><br><span class="line">      stage('1. 拉取代码') &#123;</span><br><span class="line">         steps &#123;</span><br><span class="line">		    echo "$&#123;git&#125;"</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">	  </span><br><span class="line">	  stage('2. 代码编译') &#123;</span><br><span class="line">	     steps &#123;</span><br><span class="line">		    echo 'Hello World'</span><br><span class="line">         &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	  </span><br><span class="line">	  stage('3. 单元测试') &#123;</span><br><span class="line">	     steps &#123;</span><br><span class="line">		    echo 'Hello World'</span><br><span class="line">         &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	  </span><br><span class="line">	  stage('4. 部署') &#123;</span><br><span class="line">	     steps &#123;</span><br><span class="line">		    echo "$&#123;host&#125;"</span><br><span class="line">         &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	  </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_284.png" width="50%"></p>
<p><img src="/img/k8s/k8s_285.png" width="50%"></p>
<h2 id="Jenkins-在-Kubernetes-中动态创建代理"><a href="#Jenkins-在-Kubernetes-中动态创建代理" class="headerlink" title="Jenkins 在 Kubernetes 中动态创建代理"></a>Jenkins 在 Kubernetes 中动态创建代理</h2><h3 id="Jenkins-Master-Slave架构"><a href="#Jenkins-Master-Slave架构" class="headerlink" title="Jenkins Master/Slave架构"></a>Jenkins Master/Slave架构</h3><p><img src="/img/k8s/k8s_285.png" width="50%"></p>
<ol>
<li>上面的例子中,所有的动态创建都是在Jenkins服务器中处理完成 </li>
<li>我们的Jenkins部署在了k8s里,所以是pod里的Jenkins服务 处理的编辑构建等操作</li>
<li>如果我们的项目很多,每天都做持续继承的频率也很高,面对大批量的任务处理,1个pod是很难支持的</li>
<li>所以我们需要使用 Jenkins Master/Slave架构 , Master负责任务的分配,Slave完成job任务 </li>
<li>Slave 之前是作为一个虚拟机或者物理机存在,它与Master保持通信获取任务,解决 Jenkins 服务问题</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 jenkins]# kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">jenkins-6459665769-2dzp7                  1/1     Running   0          97m</span><br><span class="line">nfs-client-provisioner-769f87c8f6-sdk9q   1/1     Running   0          118m</span><br></pre></td></tr></table></figure>
<h3 id="架构说明"><a href="#架构说明" class="headerlink" title="架构说明"></a>架构说明</h3><p><img src="/img/k8s/k8s_286.png" width="50%"></p>
<ol>
<li>传统的Jenkins部署完成后, 再在其他的虚拟机上部署几个Jenkins 做为Slave ，在页面的管理节点中配置好</li>
<li>当点击job构建的时候 Master将任务分配给Slave去完成,Master 本身没有太大工作压力</li>
</ol>
<p><img src="/img/k8s/k8s_287.png" width="50%"></p>
<ol>
<li>当用k8s环境的时候,Slave也应该作为pod运行在k8s中，Master的任务交给pod中的Slave去完成</li>
<li>考虑到两种运行方式,预先启动和动态创建，预先创建也没有问题,但是会一直消耗资源</li>
<li>动态创建Slave，当执行任务的时候,master来组织创建Slave pod ,然后在把任务交给Slave去完成,完成后销毁pod 即开即用，节省资源</li>
</ol>
<h3 id="动态创建代理"><a href="#动态创建代理" class="headerlink" title="动态创建代理"></a>动态创建代理</h3><ol>
<li>Kubernetes插件：Jenkins在Kubernetes集群中运行动态代理 </li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">插件介绍：https://github.com/jenkinsci/kubernetes-plugin</span><br></pre></td></tr></table></figure>
<h4 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h4><p><img src="/img/k8s/k8s_288.png" width="50%"></p>
<ol>
<li>如果想动态的在k8s中创建Slave pod 需要配置连接参数</li>
<li>连接的k8s地址</li>
<li>连接的Jenkins地址</li>
</ol>
<h4 id="配置插件"><a href="#配置插件" class="headerlink" title="配置插件"></a>配置插件</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. 系统配置最下面</span><br><span class="line">2. 首先 Jenkins Master 是运行在k8s里面的,作为一个pod 他本身就可以访问到k8s下面的pod资源</span><br><span class="line">3. 他连接k8s地址可以用svc名字访问,dns可以解析到</span><br><span class="line">4. Kubernetes 地址: https://kubernetes.default </span><br><span class="line">5. 如果 Jenkins 是部署在外面 需要连接k8s的外部地址  https://172.31.228.50:6443 并且需要添加CA证书和凭据</span><br><span class="line">6. Jenkins 地址 ：http://jenkins.default  同样适用svc地址 也可以使用当前页面的地址+端口</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 jenkins]# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                        AGE</span><br><span class="line">jenkins      NodePort    10.0.0.51    <span class="tag">&lt;<span class="name">none</span>&gt;</span>        80:30006/TCP,50000:30523/TCP   144m</span><br><span class="line">kubernetes   ClusterIP   10.0.0.1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>        443/TCP                        7d14h</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_289.png" width="50%"></p>
<p><img src="/img/k8s/k8s_290.png" width="50%"></p>
<p><img src="/img/k8s/k8s_291.png" width="50%"></p>
<p><img src="/img/k8s/k8s_292.png" width="50%"></p>
<h4 id="自定义构建-Jenkins-Slave-镜像"><a href="#自定义构建-Jenkins-Slave-镜像" class="headerlink" title="自定义构建 Jenkins Slave 镜像"></a>自定义构建 Jenkins Slave 镜像</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 现在 jenkins 已经知道连接 k8s了，现在要考虑如何创建pod代理</span><br><span class="line">2. 创建pod需要 jenkins Slave 镜像 </span><br><span class="line">3. k8s通过这个镜像拉起 jenkins Slave</span><br><span class="line">参考：https://github.com/jenkinsci/docker-jnlp-slave</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 制作镜像需要考虑的事</span><br><span class="line"># 镜像中要完成: 代码拉取 代码编译 单元测试 构建镜像 </span><br><span class="line">1. 什么开发语言,不同的开发环境 java - mvn  ， go语言编译 和 python环境  </span><br><span class="line">2. 构建镜像 docker</span><br><span class="line">3. 部署到k8s helm</span><br><span class="line">4. 推送镜像</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># java 为例</span><br><span class="line">1. 代码编译: maven jdk </span><br><span class="line">2. 打包镜像: docker </span><br><span class="line">3. 持续部署: helm</span><br><span class="line">4. slave的agent：slave.jar</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 镜像 如何 作为slave存在 </span><br><span class="line">1. 传统方式就是在 jenkins 管理页面添加,添加后就可以连接到slave节点,启动agent与master交互</span><br><span class="line">2. 每个slave上有个agent jar包 ，会与master实时通信，kill jar包就会不可用</span><br><span class="line">3. 镜像中必须包含 slave的agent ，传统方式会自动安装的，镜像里面需要自己安装，然后才能连接master，得到下发任务</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 opt]# unzip jenkins-slave.zip </span><br><span class="line">[root@k8s-master1 opt]# cd jenkins-slave</span><br><span class="line">[root@k8s-master1 jenkins-slave]# ls -l</span><br><span class="line"></span><br><span class="line">-rw-r--r-- 1 root root      435 Dec 26 15:49 Dockerfile</span><br><span class="line">-rwxr-xr-x 1 root root 37818368 Nov 13 21:39 helm</span><br><span class="line">-rw-r--r-- 1 root root     1980 Nov 24 14:56 jenkins-slave</span><br><span class="line">-rwxr-xr-x 1 root root 46677376 Dec 26 15:43 kubectl</span><br><span class="line">-rw-r--r-- 1 root root    10409 Nov 24 14:56 settings.xml</span><br><span class="line">-rw-r--r-- 1 root root   770802 Nov 24 14:56 slave.jar</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># docker环境,使用数据卷挂载即可，pod在node上启动,node上都有docker ，docker in docker</span><br><span class="line"># kubectl 连接 k8s 需要认证信息 也就是客户端访问</span><br><span class="line"># 参考：https://github.com/jenkinsci/docker-jnlp-slave</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 jenkins-slave]# vim Dockerfile </span><br><span class="line"></span><br><span class="line">FROM centos:7</span><br><span class="line">LABEL maintainer lizhenliang</span><br><span class="line"></span><br><span class="line">RUN yum install -y java-1.8.0-openjdk maven curl git libtool-ltdl-devel &amp;&amp; \</span><br><span class="line">    yum clean all &amp;&amp; \</span><br><span class="line">    rm -rf /var/cache/yum/* &amp;&amp; \</span><br><span class="line">    mkdir -p /usr/share/jenkins</span><br><span class="line"></span><br><span class="line">COPY slave.jar /usr/share/jenkins/slave.jar         # agent jar包</span><br><span class="line">COPY jenkins-slave /usr/bin/jenkins-slave           # shell脚本 管理启动 slave.jar  他们都是官方提供的</span><br><span class="line">COPY settings.xml /etc/maven/settings.xml           # </span><br><span class="line">RUN chmod +x /usr/bin/jenkins-slave</span><br><span class="line">COPY helm kubectl /usr/bin/                         # helm 二进制程序 用来部署k8s,kubectl 用来 连接k8s 查看资源状态等 操作k8s部署删除</span><br><span class="line"></span><br><span class="line">ENTRYPOINT ["jenkins-slave"]</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 构建镜像</span><br><span class="line">[root@k8s-master1 jenkins-slave]# docker build -t jenkins-slave:jdk-1.8 .</span><br><span class="line"></span><br><span class="line"># 推送到harbor公共仓库中</span><br><span class="line">[root@k8s-master1 jenkins-slave]# docker tag jenkins-slave:jdk-1.8 172.31.228.51/library/jenkins-slave:jdk-1.8</span><br><span class="line">[root@k8s-master1 jenkins-slave]# docker login 172.31.228.51</span><br><span class="line">[root@k8s-master1 jenkins-slave]# docker push 172.31.228.51/library/jenkins-slave:jdk-1.8</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_293.png" width="50%"></p>
<h3 id="测试动态创建-slave"><a href="#测试动态创建-slave" class="headerlink" title="测试动态创建 slave"></a>测试动态创建 slave</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. 生成创建pod </span><br><span class="line">2. jenkins pipeline 创建pod slave </span><br><span class="line">3. - name: jnlp 是固定的</span><br><span class="line">4. 打印hostname 查看job是不是在pod中的slave运行</span><br><span class="line"># 参考: https://plugins.jenkins.io/kubernetes  -&gt; Declarative Pipeline</span><br><span class="line"></span><br><span class="line"># 会拉取镜像 jenkins/jnlp-slave 3.35-5-alpine ccf03f44972a 3 months ago 141MB</span><br><span class="line"># 同时运行两个构建 在不同的node上创建了pod去执行任务</span><br><span class="line"># label 'jenkins-slave' 需要变化,不能同一时间运行同一个</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">      kubernetes &#123;</span><br><span class="line">        label 'jenkins-slave'</span><br><span class="line">        yaml """</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-slave</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: jnlp</span><br><span class="line">  image: 172.31.228.51/library/jenkins-slave:jdk-1.8</span><br><span class="line">"""</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">	parameters &#123;</span><br><span class="line">	  choice choices: ['172.31.228.51:9999/root/a.git', '172.31.228.51:9999/root/b.git', '172.31.228.51:9999/root/c.git'], description: '请选择要发布的项目git地址', name: 'git'</span><br><span class="line">	  choice choices: ['172.31.228.50', '172.31.228.52', '172.31.228.53'], description: '请选择要发布到的服务器', name: 'host'</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">   stages &#123;</span><br><span class="line">      stage('1. 拉取代码') &#123;</span><br><span class="line">         steps &#123;</span><br><span class="line">		    echo "$&#123;git&#125;"</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">	  </span><br><span class="line">	  stage('2. 代码编译') &#123;</span><br><span class="line">	     steps &#123;</span><br><span class="line">		    echo 'Hello World'</span><br><span class="line">         &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	  </span><br><span class="line">	  stage('3. 单元测试') &#123;</span><br><span class="line">	     steps &#123;</span><br><span class="line">		    echo 'Hello World'</span><br><span class="line">         &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	  </span><br><span class="line">	  stage('4. 部署') &#123;</span><br><span class="line">	     steps &#123;</span><br><span class="line">		    echo "$&#123;host&#125;"</span><br><span class="line">			sh "hostname"</span><br><span class="line">         &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	  </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_294.png" width="50%"></p>
<p><img src="/img/k8s/k8s_295.png" width="50%"></p>
<p><img src="/img/k8s/k8s_296.png" width="50%"></p>
<h2 id="Pipeline-集成-Helm-发布微服务项目"><a href="#Pipeline-集成-Helm-发布微服务项目" class="headerlink" title="Pipeline 集成 Helm 发布微服务项目"></a>Pipeline 集成 Helm 发布微服务项目</h2><p><img src="/img/k8s/k8s_297.png" width="50%"></p>
<p><img src="/img/k8s/k8s_298.png" width="50%"></p>
<ol>
<li>k8s 动态创建 jenkins slave pod</li>
<li>jenkins slave pod 完成 拉取代码 -&gt; 代码编译 -&gt; 单元测试 -&gt; 构建镜像 -&gt; Helm部署到k8s </li>
</ol>
<h3 id="需要的插件"><a href="#需要的插件" class="headerlink" title="需要的插件"></a>需要的插件</h3><ol>
<li>Git Parameter                    # 动态从git中后去所有分支</li>
<li>Git                              # 拉取代码</li>
<li>Pipeline                         # Pipeline </li>
<li>Config File Provider             # 将配置文件存放在 jenkins 里 让Pipeline引用,放到slave pod 中 (kubectl 配置文件 kubeconfig), 直接放到镜像中不太安全</li>
<li>kubernetes                       # 动态创建代理</li>
<li>Extended Choice Parameter        # 扩展参数可选配置 (多选)</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 微服务 需要选择的点</span><br><span class="line">1. 分支 </span><br><span class="line">2. 微服务名称</span><br><span class="line">3. 端口</span><br><span class="line">4. 命名空间</span><br><span class="line">5. 副本数</span><br><span class="line">6. chart模板  </span><br><span class="line"></span><br><span class="line"># 一般方法 : dp.yaml svc.yaml ing.yaml configmap.yaml 一套,使用sed 's###g' xx.yaml 替换</span><br><span class="line"># helm : 一键部署/卸载 模板化部署 传参不同的环境</span><br></pre></td></tr></table></figure>
<h3 id="准备chart目录"><a href="#准备chart目录" class="headerlink" title="准备chart目录"></a>准备chart目录</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 opt]# tar -xf ms-0.1.0.tgz </span><br><span class="line">[root@k8s-master1 opt]# cd ms</span><br><span class="line">[root@k8s-master1 ms]# ls -l</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 root root  101 Jan  1  1970 Chart.yaml</span><br><span class="line">drwxr-xr-x 2 root root 4096 Jan  7 15:16 templates</span><br><span class="line">-rw-r--r-- 1 root root  638 Jan  1  1970 values.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 添加 repo </span><br><span class="line">[root@k8s-master1 ms]# helm repo add --username admin --password lx@68328153 myrepo http://172.31.228.51/chartrepo/library</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ms]# helm repo list</span><br><span class="line">NAME  	URL                                                   </span><br><span class="line">stable	http://mirror.azure.cn/kubernetes/charts              </span><br><span class="line">aliyun	https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line">myrepo	http://172.31.228.51/chartrepo/library</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 推送 与 安装Chart</span><br><span class="line">[root@k8s-master1 opt]# helm push ms-0.1.0.tgz --username=admin --password=lx@68328153  http://172.31.228.51/chartrepo/microservice</span><br><span class="line">Pushing ms-0.1.0.tgz to http://172.31.228.51/chartrepo/microservice...</span><br><span class="line">Done.</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_299.png" width="50%"></p>
<h3 id="准备-git-项目-和-源代码"><a href="#准备-git-项目-和-源代码" class="headerlink" title="准备 git 项目 和 源代码"></a>准备 git 项目 和 源代码</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab创建ms项目</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_300.png" width="50%"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 拉取项目到本地 </span><br><span class="line">[root@k8s-master1 microservic-code]# cd /root/microservic-code</span><br><span class="line">[root@k8s-master1 microservic-code]# git clone http://47.240.13.206:9999/root/ms.git</span><br><span class="line"></span><br><span class="line"># 将dev3分支的代码 拷贝到ms下</span><br><span class="line">[root@k8s-master1 microservic-code]# cp -rf simple-microservice-dev3/* ms/</span><br><span class="line">[root@k8s-master1 microservic-code]# ls -l ms</span><br><span class="line"></span><br><span class="line"># 上传代码 提交缓存区</span><br><span class="line">[root@k8s-master1 microservic-code]# cd ms/</span><br><span class="line">[root@k8s-master1 ms]# git add .</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ms]# git config --global user.email "365042337@.qq.com"</span><br><span class="line">[root@k8s-master1 ms]# git config --global user.name "touchlixiang"</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ms]# git commit -m 'all'</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ms]# git push origin master</span><br><span class="line">Username for 'http://47.240.13.206:9999': root</span><br><span class="line">Password for 'http://root@47.240.13.206:9999': </span><br><span class="line">Counting objects: 416, done.</span><br><span class="line">Delta compression using up to 2 threads.</span><br><span class="line">Compressing objects: 100% (312/312), done.</span><br><span class="line">Writing objects: 100% (416/416), 758.09 KiB | 0 bytes/s, done.</span><br><span class="line">Total 416 (delta 55), reused 0 (delta 0)</span><br><span class="line">remote: Resolving deltas: 100% (55/55), done.</span><br><span class="line">To http://47.240.13.206:9999/root/ms.git</span><br><span class="line"> * [new branch]      master -&gt; master</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_301.png" width="50%"></p>
<h3 id="修改-Pipeline-默认变量"><a href="#修改-Pipeline-默认变量" class="headerlink" title="修改 Pipeline 默认变量"></a>修改 Pipeline 默认变量</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def registry = "172.31.228.51"</span><br><span class="line">def git_url = "http://172.31.228.51:9999/root/ms.git"</span><br></pre></td></tr></table></figure>
<h3 id="创建凭据"><a href="#创建凭据" class="headerlink" title="创建凭据"></a>创建凭据</h3><h4 id="连接-harbor"><a href="#连接-harbor" class="headerlink" title="连接 harbor"></a>连接 harbor</h4><p><img src="/img/k8s/k8s_302.png" width="50%"></p>
<p><img src="/img/k8s/k8s_303.png" width="50%"></p>
<p><img src="/img/k8s/k8s_304.png" width="50%"></p>
<h4 id="连接-gitlab"><a href="#连接-gitlab" class="headerlink" title="连接 gitlab"></a>连接 gitlab</h4><p><img src="/img/k8s/k8s_305.png" width="50%"></p>
<h4 id="修改-Pipeline-凭据变量"><a href="#修改-Pipeline-凭据变量" class="headerlink" title="修改 Pipeline 凭据变量"></a>修改 Pipeline 凭据变量</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 这两个凭证 点击更新 复制ID </span><br><span class="line">def harbor_registry_auth = "e2666836-7e4a-4d25-a4f0-f97a7711cda7"</span><br><span class="line">def git_auth = "70ab1d82-b8cb-4dcd-a520-9b257daaf44f"</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_306.png" width="50%"></p>
<h4 id="把所有的插件-安装好"><a href="#把所有的插件-安装好" class="headerlink" title="把所有的插件 安装好"></a>把所有的插件 安装好</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">所需插件: Git Parameter/Git/Pipeline/Config File Provider/kubernetes/Extended Choice Parameter</span><br></pre></td></tr></table></figure>
<h4 id="kubeconfig-凭据"><a href="#kubeconfig-凭据" class="headerlink" title="kubeconfig 凭据"></a>kubeconfig 凭据</h4><p><img src="/img/k8s/k8s_307.png" width="50%"></p>
<p><img src="/img/k8s/k8s_308.png" width="50%"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 修改 Pipeline 凭据变量 </span><br><span class="line">def k8s_auth = "c3e46862-a03a-4f8b-91ff-7a0c8f86b796"</span><br><span class="line"></span><br><span class="line"># 需要kubeconfi配置文件</span><br><span class="line"># 二进制部署 需要单独生成 使用admin证书</span><br><span class="line">[root@k8s-master1 k8s]# cd /root/ansible-k8s-deploy/ssl/k8s/</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 k8s]# vim kubeconfig.sh</span><br><span class="line"># 设置集群参数 </span><br><span class="line">kubectl config set-cluster kubernetes --server=https://172.31.228.50:6443 --embed-certs=true --certificate-authority=ca.pem --kubeconfig=config</span><br><span class="line"></span><br><span class="line"># 设置客户端认证参数</span><br><span class="line">kubectl config set-credentials cluster-admin --certificate-authority=ca.pem --embed-certs=true --client-key=admin-key.pem --client-certificate=admin.pem --kubeconfig=config</span><br><span class="line"></span><br><span class="line"># 设置上下文参数</span><br><span class="line">kubectl config set-context default --cluster=kubernetes --user=cluster-admin --kubeconfig=config</span><br><span class="line"></span><br><span class="line"># 设置当前环境的default</span><br><span class="line">kubectl config use-context default --kubeconfig=config</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 k8s]# bash kubeconfig.sh </span><br><span class="line">Cluster "kubernetes" set.</span><br><span class="line">User "cluster-admin" set.</span><br><span class="line">Context "default" created.</span><br><span class="line">Switched to context "default".</span><br><span class="line"></span><br><span class="line"># 将生成的 config里面的所有内容 复制到 k8s_auth 的 Configuration File</span><br><span class="line">[root@k8s-master1 k8s]# cat config</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_309.png" width="50%"></p>
<p><img src="/img/k8s/k8s_310.png" width="50%"></p>
<p><img src="/img/k8s/k8s_311.png" width="50%"></p>
<h3 id="创建新的流水线-ms"><a href="#创建新的流水线-ms" class="headerlink" title="创建新的流水线 ms"></a>创建新的流水线 ms</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 别忘记修改配置文件的变量 再确认一次</span><br><span class="line">#!/usr/bin/env groovy</span><br><span class="line">// 所需插件: Git Parameter/Git/Pipeline/Config File Provider/kubernetes/Extended Choice Parameter</span><br><span class="line">// 公共</span><br><span class="line">def registry = "172.31.228.51"</span><br><span class="line">// 项目</span><br><span class="line">def project = "microservice"</span><br><span class="line">def git_url = "http://172.31.228.51:9999/root/ms.git"</span><br><span class="line">def gateway_domain_name = "gateway.ctnrs.com"</span><br><span class="line">def portal_domain_name = "portal.ctnrs.com"</span><br><span class="line">// 认证</span><br><span class="line">def image_pull_secret = "registry-pull-secret"</span><br><span class="line">def harbor_registry_auth = "e2666836-7e4a-4d25-a4f0-f97a7711cda7"</span><br><span class="line">def git_auth = "70ab1d82-b8cb-4dcd-a520-9b257daaf44f"</span><br><span class="line">// ConfigFileProvider ID</span><br><span class="line">def k8s_auth = "c3e46862-a03a-4f8b-91ff-7a0c8f86b796"</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 将文件内容粘贴进入流水线</span><br><span class="line"># 第一次构建预配置</span><br><span class="line"># 第二次通过参数化构建 什么都不选 再让构建跑一次 看看能不能获取到所有分支</span><br><span class="line"># 纯写 Pipeline 前1、2次会有些问题,要读取参数</span><br><span class="line"># 第二次 我没有选择任何要构建的服务,运行的时候也走到了编译步骤，不会有任何部署，出现编译问题再重新试试</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 k8s]# kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">jenkins-6459665769-2dzp7                  1/1     Running   0          8h</span><br><span class="line">jenkins-slave-8810d-rffzp                 1/1     Running   0          10s</span><br><span class="line">nfs-client-provisioner-769f87c8f6-sdk9q   1/1     Running   0          8h</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_312.png" width="50%"></p>
<p><img src="/img/k8s/k8s_313.png" width="50%"></p>
<p><img src="/img/k8s/k8s_315.png" width="50%"></p>
<p><img src="/img/k8s/k8s_314.png" width="50%"></p>
<p><img src="/img/k8s/k8s_316.png" width="50%"></p>
<h3 id="创建新的分支"><a href="#创建新的分支" class="headerlink" title="创建新的分支"></a>创建新的分支</h3><p><img src="/img/k8s/k8s_317.png" width="50%"></p>
<p><img src="/img/k8s/k8s_318.png" width="50%"></p>
<p><img src="/img/k8s/k8s_319.png" width="50%"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 修改下镜像的地址 安装时间服务太慢使用老师的镜像仓库下的镜像</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_320.png" width="50%"></p>
<h3 id="部署一个服务测试"><a href="#部署一个服务测试" class="headerlink" title="部署一个服务测试"></a>部署一个服务测试</h3><p><img src="/img/k8s/k8s_321.png" width="50%"></p>
<p><img src="/img/k8s/k8s_322.png" width="50%"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 k8s]# kubectl get pods -n ms -o wide</span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE   IP            NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">eureka-0                              1/1     Running   0          9h    10.244.2.28   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">eureka-1                              1/1     Running   3          30h   10.244.1.42   k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">eureka-2                              1/1     Running   2          30h   10.244.0.52   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">ms-gateway-service-6bb588dbdd-tbsrb   1/1     Running   0          91s   10.244.0.55   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line"># eureka 查看注册</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_323.png" width="50%"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 k8s]# helm ls -n ms</span><br><span class="line">NAME           	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART   	APP VERSION</span><br><span class="line">gateway-service	ms       	1       	2020-01-07 09:19:28.140796979 +0000 UTC	deployed	ms-0.1.0	0.1.0</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 没问题的话 把剩下的服务 一起部署</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_324.png" width="50%"></p>
<p><img src="/img/k8s/k8s_325.png" width="50%"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 templates]# kubectl get pods -n ms -o wide</span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE     IP            NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">eureka-0                              1/1     Running   0          9h      10.244.2.28   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">eureka-1                              1/1     Running   3          30h     10.244.1.42   k8s-node1     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">eureka-2                              1/1     Running   2          30h     10.244.0.52   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">ms-gateway-service-6bb588dbdd-tbsrb   1/1     Running   0          17m     10.244.0.55   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">ms-order-service-565fb84987-pzgt9     1/1     Running   0          2m12s   10.244.0.56   k8s-node2     <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">ms-portal-service-777596f65-hhcjv     1/1     Running   0          2m16s   10.244.2.45   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">ms-product-service-6987b969-s6xbm     1/1     Running   0          2m16s   10.244.2.46   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line">ms-stock-service-5b5b88865d-r9kjv     1/1     Running   0          2m2s    10.244.2.47   k8s-master1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_326.png" width="50%"></p>
<p><img src="/img/k8s/k8s_327.png" width="50%"></p>
<h3 id="手动删除所有服务"><a href="#手动删除所有服务" class="headerlink" title="手动删除所有服务"></a>手动删除所有服务</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># helm 删除 </span><br><span class="line">helm ls -n ms</span><br><span class="line"></span><br><span class="line">helm uninstall gateway-service -n ms</span><br><span class="line">helm uninstall portal-service -n ms</span><br><span class="line">helm uninstall order-service -n ms</span><br><span class="line">helm uninstall stock-service -n ms</span><br><span class="line">helm uninstall product-service -n ms</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ms]# kubectl get pods,svc,ing -n ms</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 我修改了数据库连接地址 ms项目中的 重新Git提交 再打包一次</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ms]# git add .</span><br><span class="line">[root@k8s-master1 ms]# git commit -m 'all 2'</span><br><span class="line">[root@k8s-master1 ms]# git push origin master</span><br><span class="line"></span><br><span class="line"># 再把master的容器镜像修改一下 再重新部署看看</span><br><span class="line"># 我刚才页面的问题是我代码里的 连接数据库地址没有改 再上线前一定要做好检查工作</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_328.png" width="50%"></p>
<p><img src="/img/k8s/k8s_329.png" width="50%"></p>
<p><img src="/img/k8s/k8s_330.png" width="50%"></p>
<p><img src="/img/k8s/k8s_331.png" width="50%"></p>
<h3 id="回滚思路"><a href="#回滚思路" class="headerlink" title="回滚思路"></a>回滚思路</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 重新部署镜像 </span><br><span class="line">2. jenkins 中获取 镜像仓库的镜像 tag  , 脚本动态从harbor api 获取某个API下的所有镜像列表,</span><br><span class="line">3. 拿到镜像列表选择 要回滚的镜像版本 重新部署</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/30/k8s-base10/" rel="next" title="08 微服务链路监控系统">
                <i class="fa fa-chevron-left"></i> 08 微服务链路监控系统
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/31/k8s-13/" rel="prev" title="13 k8s 配置管理">
                13 k8s 配置管理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/Greeen.jpg" alt="Harris Li">
            
              <p class="site-author-name" itemprop="name">Harris Li</p>
              <p class="site-description motion-element" itemprop="description">Beijing</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">119</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#发布流程设计"><span class="nav-number">1.</span> <span class="nav-text">发布流程设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备基础环境"><span class="nav-number">2.</span> <span class="nav-text">准备基础环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#K8S-环境"><span class="nav-number">2.1.</span> <span class="nav-text">K8S 环境</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#coredns"><span class="nav-number">2.1.1.</span> <span class="nav-text">coredns</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ingress"><span class="nav-number">2.1.2.</span> <span class="nav-text">ingress</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PV自动供给-NFS"><span class="nav-number">2.1.3.</span> <span class="nav-text">PV自动供给 NFS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用包管理器-Helm-V3"><span class="nav-number">2.2.</span> <span class="nav-text">应用包管理器 Helm V3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#微服务数据库-MySQL"><span class="nav-number">2.3.</span> <span class="nav-text">微服务数据库 MySQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码版本仓库-Gitlab"><span class="nav-number">2.4.</span> <span class="nav-text">代码版本仓库 Gitlab</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-部署-gitlab"><span class="nav-number">2.4.1.</span> <span class="nav-text">docker 部署 gitlab</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#镜像仓库-Harbor"><span class="nav-number">2.5.</span> <span class="nav-text">镜像仓库 Harbor</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在-Kubernetes-中部署-Jenkins"><span class="nav-number">3.</span> <span class="nav-text">在 Kubernetes 中部署 Jenkins</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jenkins-Pipeline"><span class="nav-number">4.</span> <span class="nav-text">Jenkins Pipeline</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Jenkins-Pipeline-及参数化构建"><span class="nav-number">4.1.</span> <span class="nav-text">Jenkins Pipeline 及参数化构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装插件-Jenkins-Pipeline"><span class="nav-number">4.2.</span> <span class="nav-text">安装插件 Jenkins Pipeline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建测试-Pipeline"><span class="nav-number">4.3.</span> <span class="nav-text">创建测试 Pipeline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参数化构建"><span class="nav-number">4.4.</span> <span class="nav-text">参数化构建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#流水线生成-git-项目地址"><span class="nav-number">4.4.1.</span> <span class="nav-text">流水线生成 git 项目地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#流水线生成-分支名"><span class="nav-number">4.4.2.</span> <span class="nav-text">流水线生成 分支名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#流水线生成-部署的机器"><span class="nav-number">4.4.3.</span> <span class="nav-text">流水线生成 部署的机器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#脚本中获取参数"><span class="nav-number">4.5.</span> <span class="nav-text">脚本中获取参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jenkins-在-Kubernetes-中动态创建代理"><span class="nav-number">5.</span> <span class="nav-text">Jenkins 在 Kubernetes 中动态创建代理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Jenkins-Master-Slave架构"><span class="nav-number">5.1.</span> <span class="nav-text">Jenkins Master/Slave架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#架构说明"><span class="nav-number">5.2.</span> <span class="nav-text">架构说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态创建代理"><span class="nav-number">5.3.</span> <span class="nav-text">动态创建代理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装插件"><span class="nav-number">5.3.1.</span> <span class="nav-text">安装插件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置插件"><span class="nav-number">5.3.2.</span> <span class="nav-text">配置插件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义构建-Jenkins-Slave-镜像"><span class="nav-number">5.3.3.</span> <span class="nav-text">自定义构建 Jenkins Slave 镜像</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试动态创建-slave"><span class="nav-number">5.4.</span> <span class="nav-text">测试动态创建 slave</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pipeline-集成-Helm-发布微服务项目"><span class="nav-number">6.</span> <span class="nav-text">Pipeline 集成 Helm 发布微服务项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#需要的插件"><span class="nav-number">6.1.</span> <span class="nav-text">需要的插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备chart目录"><span class="nav-number">6.2.</span> <span class="nav-text">准备chart目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备-git-项目-和-源代码"><span class="nav-number">6.3.</span> <span class="nav-text">准备 git 项目 和 源代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改-Pipeline-默认变量"><span class="nav-number">6.4.</span> <span class="nav-text">修改 Pipeline 默认变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建凭据"><span class="nav-number">6.5.</span> <span class="nav-text">创建凭据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#连接-harbor"><span class="nav-number">6.5.1.</span> <span class="nav-text">连接 harbor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#连接-gitlab"><span class="nav-number">6.5.2.</span> <span class="nav-text">连接 gitlab</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改-Pipeline-凭据变量"><span class="nav-number">6.5.3.</span> <span class="nav-text">修改 Pipeline 凭据变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#把所有的插件-安装好"><span class="nav-number">6.5.4.</span> <span class="nav-text">把所有的插件 安装好</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kubeconfig-凭据"><span class="nav-number">6.5.5.</span> <span class="nav-text">kubeconfig 凭据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建新的流水线-ms"><span class="nav-number">6.6.</span> <span class="nav-text">创建新的流水线 ms</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建新的分支"><span class="nav-number">6.7.</span> <span class="nav-text">创建新的分支</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署一个服务测试"><span class="nav-number">6.8.</span> <span class="nav-text">部署一个服务测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手动删除所有服务"><span class="nav-number">6.9.</span> <span class="nav-text">手动删除所有服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#回滚思路"><span class="nav-number">6.10.</span> <span class="nav-text">回滚思路</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Harris Li</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
