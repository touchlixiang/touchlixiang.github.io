<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="k8s,">










<meta name="keywords" content="k8s">
<meta property="og:type" content="article">
<meta property="og:title" content="15 K8S 存储 卷">
<meta property="og:url" content="https://touchlixiang.github.io/2020/03/11/k8s-base17/index.html">
<meta property="og:site_name" content="My Notes">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://touchlixiang.github.io/img/mix_3.jpg">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_374.png">
<meta property="og:image" content="https://touchlixiang.github.io/img/k8s/k8s_375.png">
<meta property="og:updated_time" content="2020-03-19T14:52:01.999Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="15 K8S 存储 卷">
<meta name="twitter:image" content="https://touchlixiang.github.io/img/mix_3.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://touchlixiang.github.io/2020/03/11/k8s-base17/">





  <title>15 K8S 存储 卷 | My Notes</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">My Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">记不住的一定要写在这里</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://touchlixiang.github.io/2020/03/11/k8s-base17/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Harris Li">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/Greeen.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="My Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">15 K8S 存储 卷</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-11T18:19:37+08:00">
                2020-03-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="/img/mix_3.jpg" width="50%"><br><a id="more"></a></p>
<h2 id="将磁盘挂载到容器"><a href="#将磁盘挂载到容器" class="headerlink" title="将磁盘挂载到容器"></a>将磁盘挂载到容器</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 容器重新启动时,卷的内容将保持不变，新容器可以识别前一个容器写入卷的所有文件</span><br><span class="line">2. 一个pod中有多个容器,这个卷可以被所有容器使用</span><br></pre></td></tr></table></figure>
<h2 id="emptyDir-卷"><a href="#emptyDir-卷" class="headerlink" title="emptyDir 卷"></a>emptyDir 卷</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 创建一个空卷，挂载到Pod中的容器。</span><br><span class="line">2. Pod删除该卷也会被删除,随着pod的生命周期 而存在</span><br><span class="line">3. 应用场景：Pod中容器之间数据共享,一个pod中有多个容器,他们之间完成数据共享,不使用数据卷容器之间的文件系统是隔离的，只能看到自己的</span><br><span class="line">4. 使用数据卷让容器之间某个目录达到共享</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">1. emptyDir 临时将数据写入磁盘</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# cat fortune-svc.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: fortune-nodeport</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">    nodePort: 30123</span><br><span class="line">  selector:</span><br><span class="line">    app: fortune</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# cat fortune-pod.yaml </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: ReplicaSet</span><br><span class="line">metadata:</span><br><span class="line">  name: fortune</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: fortune</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: fortune</span><br><span class="line">    spec: </span><br><span class="line">      containers:</span><br><span class="line"></span><br><span class="line">      - image: centos:7             # 容器1 写数据到 /var/htdocs/index.html </span><br><span class="line">        name: html-generator</span><br><span class="line">        command: ["bash","-c","for i in &#123;1..100&#125;;do echo $i &gt;&gt; /var/htdocs/index.html;sleep 10;done"]</span><br><span class="line">        volumeMounts:               # html卷挂载到/var/htdocs</span><br><span class="line">        - name: html</span><br><span class="line">          mountPath: /var/htdocs</span><br><span class="line"></span><br><span class="line">      - image: nginx:1.16           # 容器2 web服务</span><br><span class="line">        name: web-server</span><br><span class="line">        volumeMounts:               # html卷挂载到/usr/share/nginx/html</span><br><span class="line">        - name: html</span><br><span class="line">          mountPath: /usr/share/nginx/html</span><br><span class="line">          readOnly: true</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          protocol: TCP</span><br><span class="line">      volumes:                      # 设定一个名字叫 html的emptyDir卷，挂载到上面的两个容器里</span><br><span class="line">      - name: html          </span><br><span class="line">        emptyDir: &#123;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. pod 包含两个容器和1个挂载到两个容器的共用卷，在不同的路径上</span><br><span class="line">2. 当html-generator 容器启动时 每10秒循环一个数据输出到 /var/htdocs/index.html </span><br><span class="line">3. web-server 是 nginx服务 他的静态目录为 /usr/share/nginx/html</span><br></pre></td></tr></table></figure>
<h2 id="hostPath-卷"><a href="#hostPath-卷" class="headerlink" title="hostPath 卷"></a>hostPath 卷</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 1. hostPath卷指向节点文件系统上的目录</span><br><span class="line"># 2. 在同一个节点上运行并且hostPath卷使用相同路径的POD 可以看到相同的文件</span><br><span class="line"># 3. hostPath 卷 是持久性存储</span><br><span class="line"># 4. emptyDir 卷 的内容会随着pod被删除时而删除</span><br><span class="line"># 5. hostPath 用来访问节点上的数据，常用于单节点的持久化存储,不要用它来做跨pod的持久化数据</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 ~]# kubectl get pods -n kube-system</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d8cfdd59d-w2xnx      1/1     Running   5          7d18h</span><br><span class="line">kube-flannel-ds-amd64-q29r8   1/1     Running   10         9d</span><br><span class="line">kube-flannel-ds-amd64-xh7c4   1/1     Running   9          9d</span><br><span class="line">kube-flannel-ds-amd64-xq7gq   1/1     Running   10         9d</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# kubectl describe pod kube-flannel-ds-amd64-q29r8 -n kube-system</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_374.png" width="50%"> </p>
<h2 id="持久化存储"><a href="#持久化存储" class="headerlink" title="持久化存储"></a>持久化存储</h2><h3 id="持久化存储的作用"><a href="#持久化存储的作用" class="headerlink" title="持久化存储的作用"></a>持久化存储的作用</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 当运行在一个Pod中的应用程序需要将数据保存到磁盘上,并且该Pod重新调度到另外一个节点时,也要求具有相同的数据可用。</span><br><span class="line">2. 数据需要可以从任何集群节点访问,因此必须将数据存储在某种类型的网络存储(NAS)中</span><br></pre></td></tr></table></figure>
<h3 id="使用NFS作为底层存储"><a href="#使用NFS作为底层存储" class="headerlink" title="使用NFS作为底层存储"></a>使用NFS作为底层存储</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1. 集群并未运行在云服务器上 而是自建环境，需要有自己的存储集群</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 选择 master2 作为服务端</span><br><span class="line"># 关键：客户端，也就是node上也要安装</span><br><span class="line">[root@k8s-node1 ~]# yum install -y nfs-utils </span><br><span class="line">[root@k8s-node2 ~]# yum install -y nfs-utils </span><br><span class="line">[root@k8s-master2 ~]# yum install -y nfs-utils</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 配置服务端的访问路径 启动服务端守护进程</span><br><span class="line"># 得有这个目录才能挂载</span><br><span class="line">[root@k8s-master2 ~]# mkdir -p /data/nfs</span><br><span class="line"></span><br><span class="line">[root@k8s-master2 ~]# vim /etc/exports</span><br><span class="line">/data/nfs *(rw,no_root_squash)</span><br><span class="line"></span><br><span class="line">[root@k8s-master2 ~]# systemctl start nfs</span><br><span class="line"></span><br><span class="line">[root@k8s-master2 ~]# ps -ef|grep nfs</span><br></pre></td></tr></table></figure>
<h3 id="创建-mongodb-数据库-pod-测试持久化存储"><a href="#创建-mongodb-数据库-pod-测试持久化存储" class="headerlink" title="创建 mongodb 数据库 pod 测试持久化存储"></a>创建 mongodb 数据库 pod 测试持久化存储</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 配置启动</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# vim mongodb-pod.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb</span><br><span class="line">spec:</span><br><span class="line">  volumes:                          # 定义卷</span><br><span class="line">  - name: mongodb-data              # 卷名 在挂载的时候需要用到</span><br><span class="line">    nfs:                            # 使用nfs共享作为卷的外部存储</span><br><span class="line">      server: 172.31.228.68         # nfs 服务器地址</span><br><span class="line">      path: /data/nfs               # nfs 服务挂载路径</span><br><span class="line">  containers:</span><br><span class="line">  - image: mongo</span><br><span class="line">    name: mongodb</span><br><span class="line">    volumeMounts:                   # mongodb-data 卷挂载到 /data/db</span><br><span class="line">    - name: mongodb-data            # 挂载卷的时候引用卷名</span><br><span class="line">      mountPath: /data/db           # mongodb 默认的数据存放路径</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 27017          # mongodb 服务端口</span><br><span class="line">      protocol: TCP</span><br></pre></td></tr></table></figure>
<h4 id="向-MongoDB-pod-里面插入数据"><a href="#向-MongoDB-pod-里面插入数据" class="headerlink" title="向 MongoDB pod 里面插入数据"></a>向 MongoDB pod 里面插入数据</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# kubectl get pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">mongodb   1/1     Running   0          73s   10.244.0.31   k8s-node1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it mongodb mongo</span><br><span class="line"></span><br><span class="line">&gt; use mystore</span><br><span class="line">switched to db mystore</span><br><span class="line">&gt; db.doo.insert(&#123;name:'leo'&#125;)</span><br><span class="line">WriteResult(&#123; "nInserted" : 1 &#125;)</span><br><span class="line">&gt; db.doo.find()</span><br><span class="line">&#123; "_id" : ObjectId("5e72e43d3bb458e3186a18c5"), "name" : "leo" &#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试持久化存储"><a href="#测试持久化存储" class="headerlink" title="测试持久化存储"></a>测试持久化存储</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 删除 Pod </span><br><span class="line">[root@k8s-master1 demo]# kubectl delete pod mongodb</span><br><span class="line">pod "mongodb" deleted</span><br><span class="line"></span><br><span class="line"># 重新创建到其他节点</span><br><span class="line"># 如果一直在node1创建,使用节点选择器指定node上创建</span><br><span class="line">[root@k8s-master1 demo]# kubectl get pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">mongodb   1/1     Running   0          83s   10.244.1.40   k8s-node2   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line"># 查看数据 </span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it mongodb mongo</span><br><span class="line">&gt; use mystore</span><br><span class="line">switched to db mystore</span><br><span class="line">&gt; db.doo.find()</span><br><span class="line">&#123; "_id" : ObjectId("5e72e43d3bb458e3186a18c5"), "name" : "leo" &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 1. 删除了Pod并重建,数据仍然存在,后端使用持久化存储,多个Pod可以将数据写入持久化存储来保存数据</span><br><span class="line"># 2. 清理该Pod,但是先不清理nfs中的数据,后面继续测试</span><br></pre></td></tr></table></figure>
<h3 id="其他存储技术"><a href="#其他存储技术" class="headerlink" title="其他存储技术"></a>其他存储技术</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. 参考: 官方文档</span><br><span class="line">https://kubernetes.io/docs/concepts/storage/volumes/</span><br><span class="line"></span><br><span class="line">2. Kubernetes中的Volume提供了在容器中挂载外部存储的能力</span><br><span class="line">Pod需要设置卷来源（spec.volume）和挂载点（spec.containers.volumeMounts）两个信息后才可以使用相应的Volume</span><br><span class="line"></span><br><span class="line">3.本地数据卷</span><br><span class="line">hostPath 持久化 挂载node中的目录到pod中</span><br><span class="line">emptyDir 非持久化 随着pod删除数据也一并删除</span><br></pre></td></tr></table></figure>
<h2 id="从底层存储技术-解耦-Pod"><a href="#从底层存储技术-解耦-Pod" class="headerlink" title="从底层存储技术 解耦 Pod"></a>从底层存储技术 解耦 Pod</h2><h3 id="持久卷和持久卷声明"><a href="#持久卷和持久卷声明" class="headerlink" title="持久卷和持久卷声明"></a>持久卷和持久卷声明</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 开发人员需要一定数量的持久化存储 向K8S请求 类似创建Pod时请求CPU和内存 </span><br><span class="line">2. 系统管理员配置存储服务 让 开发人员能使用 </span><br><span class="line">3. 之前我们一直使用Pod常规卷,下面学习 持久卷</span><br></pre></td></tr></table></figure>
<h3 id="持久卷"><a href="#持久卷" class="headerlink" title="持久卷"></a>持久卷</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. PersistenVolume（PV） </span><br><span class="line">2. 专业的存储人员来做底层存储，然后通过k8s注册持久卷</span><br><span class="line">3. 创建持久卷的时候,可以指定大小和访问模式</span><br><span class="line">4. 集群用户需要在Pod中使用使用持久卷(PV)时,先创建持久卷声明(PVC),指定需要的容量和访问方式</span><br><span class="line">5. 持久卷声明 会发送给 k8s的api,k8s找到匹配的持久卷PV并绑定到PVC上</span><br><span class="line">6. 持久卷声明 可以当做Pod的一个卷来使用,其他用户不能使用相同的持久卷,除非先通过删除PVC绑定来释放</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">持久卷由集群管理员创建,并被Pod通过持久卷生命消费</span><br><span class="line"># PV 和 PVC 流程</span><br><span class="line">1. 集群管理员创建某类型的网络存储(NFS或者Ceph) </span><br><span class="line">2. 集群管理员向k8s api 发送请求 创建持久卷PV </span><br><span class="line">3. 用户(使用者) 创建持久卷声明(PVC)</span><br><span class="line">4. k8s找到一个匹配足够容量的PV并设置访问模式,最终将这个PVC绑定给这个PV</span><br><span class="line">5. 用户创建一个Pod，并通过配置卷引用PVC</span><br></pre></td></tr></table></figure>
<h3 id="创建-PV-持久卷"><a href="#创建-PV-持久卷" class="headerlink" title="创建 PV 持久卷"></a>创建 PV 持久卷</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. PersistenVolume（PV）：对存储资源创建和使用的抽象，使得存储作为集群中的资源管理。(专业的存储人员来做)</span><br><span class="line">2. PV 可以是存储人员定义,他们会创建很多pv等待pvc来挂载</span><br><span class="line">静态: 手动创建资源</span><br><span class="line">动态: 自动创建PV</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 在Kubernetes集群中，PV 作为存储资源存在。PVC 是对PV资源的请求和使用，也是对PV存储资源的”提取证”，而Pod通过PVC来使用PV。</span><br><span class="line"># PV 和 PVC 之间的交互过程有着自己的生命周期，这个生命周期分为5个阶段：</span><br><span class="line"></span><br><span class="line">1. 供应(Provisioning)：即PV的创建，可以直接创建PV（静态方式），也可以使用StorageClass 动态创建</span><br><span class="line">2. 绑定（Binding）：将PV分配给PVC</span><br><span class="line">3. 使用（Using）：Pod通过PVC使用该Volume</span><br><span class="line">4. 释放（Releasing）：Pod释放Volume并删除PVC</span><br><span class="line">5. 回收（Reclaiming）：回收PV，可以保留PV以便下次使用，也可以直接从云存储中删除</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 存储卷的存在下面的4种状态：</span><br><span class="line">1. Available：可用状态，处于此状态表明PV以及准备就绪了，可以被PVC使用了。</span><br><span class="line">2. Bound：绑定状态，表明PV已被分配给了PVC。</span><br><span class="line">3. Released：释放状态，表明PVC解绑PV，但还未执行回收策略。</span><br><span class="line">4. Failed：错误状态，表明PV发生错误。</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# kubectl explain PersistentVolume</span><br><span class="line">KIND:     PersistentVolume</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# vim nfs-pv.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:                                 # 定义pv 容量大小</span><br><span class="line">    storage: 5Gi          </span><br><span class="line">  accessModes:                              # 访问模式</span><br><span class="line">  - ReadWriteMany</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain     # 持久化卷 回收策略 当声明释放后,pv将会被保留(不删除和释放)</span><br><span class="line">  nfs:                                      # 存储类型 位置 和 其他属性</span><br><span class="line">    path: /data/nfs</span><br><span class="line">    server: 172.31.228.68</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1. 访问模式的可选范围如下：</span><br><span class="line">  ReadWriteOnce：    该卷能够以 读写模式 被加载到一个节点上。</span><br><span class="line">  ReadOnlyMany：     该卷能够以 只读模式 加载到多个节点上。</span><br><span class="line">  ReadWriteMany：    该卷能够以 读写模式 被多个节点同时加载。</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# kubectl create -f nfs-pv.yaml </span><br><span class="line">persistentvolume/mongodb-pv created</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl get pv</span><br><span class="line">NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">mongodb-pv   5Gi        RWX            Retain           Available                                   4s</span><br><span class="line"></span><br><span class="line"># Retain    默认回收策略</span><br><span class="line"># Available 可用状态</span><br></pre></td></tr></table></figure>
<h3 id="创建-PVC-持久卷声明"><a href="#创建-PVC-持久卷声明" class="headerlink" title="创建 PVC 持久卷声明"></a>创建 PVC 持久卷声明</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# kubectl explain PersistentVolumeClaim</span><br><span class="line">KIND:     PersistentVolumeClaim</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# vim nfs-pvc.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb-pvc             # 声明(pvc)的名称,pod中会引用到</span><br><span class="line">spec:</span><br><span class="line">  resources:                    # 申请5G的存储空间</span><br><span class="line">    requests:</span><br><span class="line">      storage: 5Gi</span><br><span class="line">  accessModes:                  # 访问模式 </span><br><span class="line">  - ReadWriteMany</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. resources 资源; 财力</span><br><span class="line">2. 注意：持久卷的容量必须满足声明的需求,并且卷的访问模式必须包含申明中指定的访问模式</span><br><span class="line">否则pvc会无限期的处于未绑定状态,一旦存在匹配的PV，PVC绑定此PV，</span><br><span class="line">就算集群中存在很多的50G的PV，需要100G容量的PVC也不会匹配满足需求的PV。直到集群中有100G的PV时，PVC才会被绑定。</span><br><span class="line">3. 如果没有指定存储类和设置选取器，PVC会根据存储空间容量大小和访问模式匹配符合的PV</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# kubectl get pvc</span><br><span class="line">NAME          STATUS   VOLUME       CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">mongodb-pvc   Bound    mongodb-pv   5Gi        RWX                           82s</span><br><span class="line"></span><br><span class="line"># 在 CLI 下，访问模式缩写为: RWO、ROX、RWX涉及工作节点数量而不是Pod数量</span><br><span class="line">RWO：ReadWriteOnce</span><br><span class="line">ROX：ReadOnlyMany</span><br><span class="line">RWX：ReadWriteMany</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl get pv</span><br><span class="line">NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS   REASON   AGE</span><br><span class="line">mongodb-pv   5Gi        RWX            Retain           Bound    default/mongodb-pvc                           30m</span><br><span class="line"></span><br><span class="line"># Bound 进入绑定状态 将PV分配给PVC </span><br><span class="line"># mongodb-pv 持久卷绑定给 default/mongodb-pvc 持久卷声明</span><br><span class="line"># default/mongodb-pvc default是持久卷声明的命名空间 </span><br><span class="line"># 持久卷PV是集群范围的，持久卷声明需要被同一命名空间的Pod创建</span><br></pre></td></tr></table></figure>
<h3 id="Pod-使用-PVC-持久卷声明"><a href="#Pod-使用-PVC-持久卷声明" class="headerlink" title="Pod 使用 PVC 持久卷声明"></a>Pod 使用 PVC 持久卷声明</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# vim mongodb-pod-pvc.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb</span><br><span class="line">spec:</span><br><span class="line">  # nodeSelector:</span><br><span class="line">  #  gpu: "true"</span><br><span class="line">  volumes:</span><br><span class="line">  - name:  mongodb-data</span><br><span class="line">    persistentVolumeClaim:</span><br><span class="line">      claimName: mongodb-pvc          # 引用持久卷声明 pvc name</span><br><span class="line">  containers:</span><br><span class="line">  - image: mongo</span><br><span class="line">    name: mongodb</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: mongodb-data</span><br><span class="line">      mountPath: /data/db</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 27017</span><br><span class="line">      protocol: TCP</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# kubectl get pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">mongodb   1/1     Running   0          19s   10.244.0.35   k8s-node1   <span class="tag">&lt;<span class="name">none</span>&gt;</span>           <span class="tag">&lt;<span class="name">none</span>&gt;</span></span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it mongodb mongo</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl create -f mongodb-pod-pvc.yaml </span><br><span class="line">pod/mongodb created</span><br><span class="line"></span><br><span class="line">&gt; use mystore</span><br><span class="line">switched to db mystore</span><br><span class="line">&gt; db.doo.find()</span><br><span class="line">&#123; "_id" : ObjectId("5e72e43d3bb458e3186a18c5"), "name" : "leo" &#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用-PV-和-PVC-的好处"><a href="#使用-PV-和-PVC-的好处" class="headerlink" title="使用 PV 和 PVC 的好处"></a>使用 PV 和 PVC 的好处</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 研发人员不用担心 底层的存储技术 只需要申请容量和访问模式</span><br><span class="line">2. 其他的 pod 无法使用一个 被绑定的pvc</span><br></pre></td></tr></table></figure>
<h3 id="回收持久卷"><a href="#回收持久卷" class="headerlink" title="回收持久卷"></a>回收持久卷</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 删除 Pod </span><br><span class="line">[root@k8s-master1 demo]# kubectl delete pod mongodb</span><br><span class="line"></span><br><span class="line"># 删除 PVC</span><br><span class="line">[root@k8s-master1 demo]# kubectl delete pvc mongodb-pvc</span><br><span class="line">persistentvolumeclaim "mongodb-pvc" deleted</span><br><span class="line"></span><br><span class="line"># 重新创建 PVC </span><br><span class="line">[root@k8s-master1 demo]# kubectl get pvc</span><br><span class="line">NAME          STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">mongodb-pvc   Pending                                                     8s</span><br><span class="line"></span><br><span class="line"># 为什么不绑定 查看 PV </span><br><span class="line">[root@k8s-master1 demo]# kubectl get pv</span><br><span class="line">NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                 STORAGECLASS   REASON   AGE</span><br><span class="line">mongodb-pv   5Gi        RWX            Retain           Released   default/mongodb-pvc                           116m</span><br><span class="line"></span><br><span class="line"># Released 释放状态，表明PVC解绑PV，但还未执行回收策略。</span><br><span class="line"># 说明这个卷里面的数据 还没有被清理</span><br></pre></td></tr></table></figure>
<h4 id="手动回收持久卷"><a href="#手动回收持久卷" class="headerlink" title="手动回收持久卷"></a>手动回收持久卷</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. persistentVolumeReclaimPolicy: Retain ，该设置告诉k8s，PVC和PV解绑后,保留卷和数据</span><br><span class="line">2. 手动回收 删除和更新创建持久卷资源,你可以自己决定是否删除底层存储中的文件,也可以不删除在下一个Pod中复用</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># 测试不删除底层数据,然后手动删除持久卷,重建资源</span><br><span class="line">[root@k8s-master1 demo]# kubectl delete pv mongodb-pv</span><br><span class="line">persistentvolume "mongodb-pv" deleted</span><br><span class="line"></span><br><span class="line"># 底层数据不清理</span><br><span class="line">[root@k8s-master2 opt]# cd /data/nfs/</span><br><span class="line">[root@k8s-master2 nfs]# ls -l</span><br><span class="line">total 336</span><br><span class="line">-rw------- 1 polkitd input 20480 Mar 19 17:27 collection-0-485674314440757453.wt</span><br><span class="line">-rw------- 1 polkitd input 36864 Mar 19 17:27 collection-2-485674314440757453.wt</span><br><span class="line">-rw------- 1 polkitd input  4096 Mar 19 11:18 collection-4-485674314440757453.wt</span><br><span class="line">-rw------- 1 polkitd input 20480 Mar 19 17:27 collection-8-485674314440757453.wt</span><br><span class="line">drwx------ 2 polkitd input  4096 Mar 19 17:27 diagnostic.data</span><br><span class="line">-rw------- 1 polkitd input 20480 Mar 19 17:27 index-1-485674314440757453.wt</span><br><span class="line">-rw------- 1 polkitd input 36864 Mar 19 17:27 index-3-485674314440757453.wt</span><br><span class="line">-rw------- 1 polkitd input  4096 Mar 19 17:27 index-5-485674314440757453.wt</span><br><span class="line">-rw------- 1 polkitd input 12288 Mar 19 17:27 index-6-485674314440757453.wt</span><br><span class="line">-rw------- 1 polkitd input 20480 Mar 19 11:18 index-9-485674314440757453.wt</span><br><span class="line">drwx------ 2 polkitd input  4096 Mar 19 17:15 journal</span><br><span class="line">-rw------- 1 polkitd input 36864 Mar 19 17:27 _mdb_catalog.wt</span><br><span class="line">-rw------- 1 polkitd input     0 Mar 19 17:27 mongod.lock</span><br><span class="line">-rw------- 1 polkitd input 36864 Mar 19 17:27 sizeStorer.wt</span><br><span class="line">-rw------- 1 polkitd input   114 Mar 19 11:14 storage.bson</span><br><span class="line">-rw------- 1 polkitd input    47 Mar 19 11:14 WiredTiger</span><br><span class="line">-rw------- 1 polkitd input  4096 Mar 19 17:27 WiredTigerLAS.wt</span><br><span class="line">-rw------- 1 polkitd input    21 Mar 19 11:15 WiredTiger.lock</span><br><span class="line">-rw------- 1 polkitd input  1188 Mar 19 17:27 WiredTiger.turtle</span><br><span class="line">-rw------- 1 polkitd input 61440 Mar 19 17:27 WiredTiger.wt</span><br><span class="line"></span><br><span class="line"># 重建持久卷 持久卷声明 Pod</span><br><span class="line">[root@k8s-master1 demo]# kubectl get pv</span><br><span class="line">NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">mongodb-pv   5Gi        RWX            Retain           Available                                   3s</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl create -f nfs-pvc.yaml </span><br><span class="line">persistentvolumeclaim/mongodb-pvc created</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl create -f mongodb-pod-pvc.yaml </span><br><span class="line">pod/mongodb created</span><br><span class="line"></span><br><span class="line"># 数据复用</span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it mongodb mongo</span><br><span class="line">&gt; use mystore</span><br><span class="line">switched to db mystore</span><br><span class="line">&gt; db.doo.find()</span><br><span class="line">&#123; "_id" : ObjectId("5e72e43d3bb458e3186a18c5"), "name" : "leo" &#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试删除-PV和底层数据"><a href="#测试删除-PV和底层数据" class="headerlink" title="测试删除 PV和底层数据"></a>测试删除 PV和底层数据</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 demo]# kubectl delete pod mongodb</span><br><span class="line">[root@k8s-master1 demo]# kubectl delete pvc mongodb-pvc</span><br><span class="line">[root@k8s-master1 demo]# kubectl delete pv mongodb-pv</span><br><span class="line">[root@k8s-master2 nfs]# rm -rf *</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl create -f nfs-pv.yaml </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl create -f nfs-pvc.yaml </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl get pv</span><br><span class="line">NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS   REASON   AGE</span><br><span class="line">mongodb-pv   5Gi        RWX            Retain           Bound    default/mongodb-pvc                           7s</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl get pvc</span><br><span class="line">NAME          STATUS   VOLUME       CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">mongodb-pvc   Bound    mongodb-pv   5Gi        RWX                           8s</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl create -f mongodb-pod-pvc.yaml </span><br><span class="line">pod/mongodb created</span><br><span class="line"></span><br><span class="line"># 无法复用之前的数据,已经被手动清理</span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it mongodb mongo</span><br><span class="line">&gt; use mystore</span><br><span class="line">switched to db mystore</span><br><span class="line">&gt; db.doo.find()</span><br><span class="line">&gt; db.doo.insert(&#123;name:'Lex'&#125;)</span><br><span class="line">WriteResult(&#123; "nInserted" : 1 &#125;)</span><br><span class="line">&gt; db.doo.find()</span><br><span class="line">&#123; "_id" : ObjectId("5e733ee540bc22899dc58827"), "name" : "Lex" &#125;</span><br><span class="line"></span><br><span class="line"># 数据已重新被创建</span><br><span class="line">[root@k8s-master2 nfs]# ls -l</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><img src="/img/k8s/k8s_375.png" width="50%"> </p>
<h4 id="自动回收持久卷"><a href="#自动回收持久卷" class="headerlink" title="自动回收持久卷"></a>自动回收持久卷</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 当前的回收策略可选值包括：</span><br><span class="line">Retain:     持久化卷被释放后，需要手工进行回收操作。</span><br><span class="line"></span><br><span class="line">Recycle:    基础擦除（“rm-rf /thevolume/*”） 可用于再次声明，可被不同的持久卷声明和Pod引用</span><br><span class="line">Delete:     相关的存储资产，例如AWSEBS或GCE PD卷一并删除。  彻底删除底层</span><br><span class="line">目前，只有NFS和HostPath支持Recycle策略，AWSEBS、GCE PD支持Delete策略。</span><br><span class="line"></span><br><span class="line"># 再创建持久卷PV的时候,一定要检查卷中的底层存储支持什么回收策略</span><br><span class="line"># 可以更改当前使用的持久卷的回收策略，如果之前的delete或者Recycle，那么可改成Retain，手动回收来保持重要数据</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"># 测试 nfs 的 Recycle 回收策略 是否删除了底层数据 和 被新的PVC复用</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# vim nfs-pv.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteMany</span><br><span class="line">  persistentVolumeReclaimPolicy: Recycle</span><br><span class="line">  nfs:</span><br><span class="line">    path: /data/nfs</span><br><span class="line">    server: 172.31.228.68</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl apply -f nfs-pv.yaml </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# kubectl edit pv mongodb-pv</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# kubectl get pvc</span><br><span class="line">NAME          STATUS   VOLUME       CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">mongodb-pvc   Bound    mongodb-pv   5Gi        RWX                           11m</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 ~]# kubectl get pv</span><br><span class="line">NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS   REASON   AGE</span><br><span class="line">mongodb-pv   5Gi        RWX            Recycle          Bound    default/mongodb-pvc                           12m</span><br><span class="line"></span><br><span class="line"># 删除 pvc pv pod</span><br><span class="line">[root@k8s-master1 demo]# kubectl delete pod mongodb</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl get pv</span><br><span class="line">NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                 STORAGECLASS   REASON   AGE</span><br><span class="line">mongodb-pv   5Gi        RWX            Recycle          Released   default/mongodb-pvc                           13m</span><br><span class="line"></span><br><span class="line"># Released 释放状态，表明PVC解绑PV，但还未执行回收策略。</span><br><span class="line"># 过了一会 变成 Available 说明 pv被自动回收了 查看数据</span><br><span class="line">[root@k8s-master1 demo]# kubectl get pv</span><br><span class="line">NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">mongodb-pv   5Gi        RWX            Recycle          Available                                   14m</span><br><span class="line"></span><br><span class="line"># nfs 中的数据也被rm掉</span><br><span class="line">[root@k8s-master2 nfs]# ls -l</span><br><span class="line">total 0</span><br><span class="line"></span><br><span class="line"># 重新创建并绑定 </span><br><span class="line">[root@k8s-master1 demo]# kubectl create -f nfs-pvc.yaml </span><br><span class="line">persistentvolumeclaim/mongodb-pvc created</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl create -f mongodb-pod-pvc.yaml </span><br><span class="line">pod/mongodb created</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl get pvc</span><br><span class="line">NAME          STATUS   VOLUME       CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">mongodb-pvc   Bound    mongodb-pv   5Gi        RWX                           8s</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 demo]# kubectl get pv</span><br><span class="line">NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS   REASON   AGE</span><br><span class="line">mongodb-pv   5Gi        RWX            Recycle          Bound    default/mongodb-pvc                           15m</span><br><span class="line"></span><br><span class="line"># 绑定成功,数据被清理,新的pv</span><br><span class="line">[root@k8s-master1 demo]# kubectl exec -it mongodb mongo</span><br><span class="line"></span><br><span class="line">&gt; use mystore</span><br><span class="line">switched to db mystore</span><br><span class="line">&gt; db.doo.find()</span><br></pre></td></tr></table></figure>
<h2 id="PV-动态供给"><a href="#PV-动态供给" class="headerlink" title="PV 动态供给"></a>PV 动态供给</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 主要是针对容量问题，手动划分非常麻烦，如果pvc的容量匹配不上pv就无法绑定 </span><br><span class="line">2. k8s的动态供给就是可以动态划分容量 </span><br><span class="line">3. StorageClass声明存储插件，用于自动创建PV。</span><br></pre></td></tr></table></figure>
<h3 id="k8s-支持持久卷的存储插件"><a href="#k8s-支持持久卷的存储插件" class="headerlink" title="k8s 支持持久卷的存储插件"></a>k8s 支持持久卷的存储插件</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://kubernetes.io/docs/concepts/storage/persistent-volumes/</span><br></pre></td></tr></table></figure>
<h3 id="NFS-PV-动态供给"><a href="#NFS-PV-动态供给" class="headerlink" title="NFS PV 动态供给"></a>NFS PV 动态供给</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># 创建RBAC授权</span><br><span class="line"># 动态创建pv插件需要连接apiserver ，所以需要授权</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs]# vim rbac.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["persistentvolumes"]</span><br><span class="line">    verbs: ["get", "list", "watch", "create", "delete"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["persistentvolumeclaims"]</span><br><span class="line">    verbs: ["get", "list", "watch", "update"]</span><br><span class="line">  - apiGroups: ["storage.k8s.io"]</span><br><span class="line">    resources: ["storageclasses"]</span><br><span class="line">    verbs: ["get", "list", "watch"]</span><br><span class="line">  - apiGroups: [""]</span><br><span class="line">    resources: ["events"]</span><br><span class="line">    verbs: ["list", "watch", "create", "update", "patch"]</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: run-nfs-client-provisioner</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nfs-client-provisioner</span><br><span class="line">    namespace: default</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nfs-client-provisioner-runner</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># 创建nfs的nfs-client-provisioner</span><br><span class="line"># 该服务帮我们自动创建pv</span><br><span class="line"># 参考地址:</span><br><span class="line">https://github.com/kubernetes-incubator/external-storage</span><br><span class="line">https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client/deploy</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs]# vim deployment-nfs.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nfs-client-provisioner</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccount: nfs-client-provisioner</span><br><span class="line">      containers:</span><br><span class="line">      - name: nfs-client-provisioner</span><br><span class="line">        image: lizhenliang/nfs-client-provisioner:v2.0.0</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          mountPath: /persistentvolumes</span><br><span class="line">        env:</span><br><span class="line">          - name: PROVISIONER_NAME</span><br><span class="line">            value: fuseim.pri/ifs</span><br><span class="line">          - name: NFS_SERVER</span><br><span class="line">            value: 172.31.228.68</span><br><span class="line">          - name: NFS_PATH</span><br><span class="line">            value: /data/nfs</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: 172.31.228.68</span><br><span class="line">            path: /data/nfs</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># StorageClass 定义</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs]# vim storageclass-nfs.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: storage.k8s.io/v1beta1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">provisioner: fuseim.pri/ifs</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 创建</span><br><span class="line">[root@k8s-master1 nfs]# kubectl create -f rbac.yaml </span><br><span class="line">serviceaccount/nfs-client-provisioner created</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs]# kubectl create -f deployment-nfs.yaml </span><br><span class="line">deployment.apps/nfs-client-provisioner created</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs]# kubectl create -f storageclass-nfs.yaml</span><br><span class="line">storageclass.storage.k8s.io/managed-nfs-storage created</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs]# kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner-56f4b98d47-v4nf6   1/1     Running   0          85s</span><br></pre></td></tr></table></figure>
<h3 id="nfs-自动供给-机制"><a href="#nfs-自动供给-机制" class="headerlink" title="nfs 自动供给 机制"></a>nfs 自动供给 机制</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1. 动态存储卷供应使用StorageClass进行实现，其允许存储卷按需被创建。</span><br><span class="line">2. 如果没有动态存储供应，Kubernetes集群的管理员将不得不通过手工的方式类创建新的存储卷。</span><br><span class="line">3. 通过动态存储卷，Kubernetes将能够按照用户的需要，自动创建其需要的存储。</span><br><span class="line"></span><br><span class="line">1）集群管理员预先创建存储类（StorageClass）；</span><br><span class="line">2）用户创建使用存储类的持久化存储声明(PVC：PersistentVolumeClaim)；</span><br><span class="line">3）存储持久化声明通知系统，它需要一个持久化存储(PV: PersistentVolume)；</span><br><span class="line">4）系统读取存储类的信息；</span><br><span class="line">5）系统基于存储类的信息，在后台自动创建PVC需要的PV；</span><br><span class="line">6）用户创建一个使用PVC的Pod；</span><br><span class="line">7）Pod中的应用通过PVC进行数据的持久化；</span><br><span class="line">8）而PVC使用PV进行数据的最终持久化处理。</span><br><span class="line"></span><br><span class="line">fuseim.pri/ifs 为上面deployment上创建的PROVISIONER_NAME。</span><br></pre></td></tr></table></figure>
<h3 id="创建-PVC"><a href="#创建-PVC" class="headerlink" title="创建 PVC"></a>创建 PVC</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">1. 在存储类被正确创建后，就可以创建PersistenetVolumeClaim来请求StorageClass，</span><br><span class="line">2. 而StorageClass将会为PersistenetVolumeClaim自动创建一个可用PersistentVolume。</span><br><span class="line">3. PersistenetVolumeClaim是对PersistenetVolume的声明，即PersistenetVolume为存储的提供者，而PersistenetVolumeClaim为存储的消费者。</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs]# vim nfs-pvc-dp.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb-pvc</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: managed-nfs-storage</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 5Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteMany</span><br><span class="line"></span><br><span class="line"># storageClassName: managed-nfs-storage # pvc 请求自定义存储类 去创建pv </span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs]# kubectl create -f nfs-pvc-dp.yaml </span><br><span class="line">persistentvolumeclaim/mongodb-pvc created</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs]# kubectl get pvc</span><br><span class="line">NAME          STATUS   VOLUME                                                         CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">mongodb-pvc   Bound    default-mongodb-pvc-pvc-9248dad6-b64b-48c3-a3a3-d9f576a0c412   5Gi        RWX            managed-nfs-storage   71s</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs]# kubectl get pv</span><br><span class="line">NAME                                                           CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">default-mongodb-pvc-pvc-9248dad6-b64b-48c3-a3a3-d9f576a0c412   5Gi        RWX            Delete           Bound    default/mongodb-pvc   managed-nfs-storage            74s</span><br><span class="line"></span><br><span class="line"># Delete 是默认的回收策略 也就是当删除pvc与pv的绑定关系后 pv也会被删除 彻底删除底层 </span><br><span class="line"># 如果要修改 在 StorageClass 增加 reclaimPolicy: Retain 手动回收资源</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 nfs]# vim  mongodb-pod-pvc.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: mongodb</span><br><span class="line">spec:</span><br><span class="line">  # nodeSelector:</span><br><span class="line">  #  gpu: "true"</span><br><span class="line">  volumes:</span><br><span class="line">  - name:  mongodb-data</span><br><span class="line">    persistentVolumeClaim:</span><br><span class="line">      claimName: mongodb-pvc</span><br><span class="line">  containers:</span><br><span class="line">  - image: mongo</span><br><span class="line">    name: mongodb</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: mongodb-data</span><br><span class="line">      mountPath: /data/db</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 27017</span><br><span class="line">      protocol: TCP</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs]# kubectl create -f mongodb-pod-pvc.yaml </span><br><span class="line">[root@k8s-master1 nfs]# kubectl exec -it mongodb mongo</span><br><span class="line">&gt; use mystore</span><br><span class="line">switched to db mystore</span><br><span class="line">&gt; db.doo.find()</span><br><span class="line">WriteResult(&#123; "nInserted" : 1 &#125;)</span><br><span class="line">&gt; db.doo.find()</span><br><span class="line">&#123; "_id" : ObjectId("5e7384172fb631dbf214e42d"), "name" : "123" &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 删除 pod 和 pvc</span><br><span class="line">[root@k8s-master1 nfs]# kubectl delete pod mongodb</span><br><span class="line">pod "mongodb" deleted</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs]# kubectl delete pvc mongodb-pvc</span><br><span class="line">persistentvolumeclaim "mongodb-pvc" deleted</span><br><span class="line"></span><br><span class="line"># pv 被完全删除了 </span><br><span class="line">[root@k8s-master1 nfs]# kubectl get pv</span><br><span class="line">No resources found in default namespace.</span><br><span class="line"></span><br><span class="line"># nfs 下的数据还存在</span><br><span class="line">[root@k8s-master2 nfs]# ls -l</span><br><span class="line">total 4</span><br><span class="line">drwxrwxrwx 4 polkitd root 4096 Mar 19 22:42 archived-default-mongodb-pvc-pvc-9248dad6-b64b-48c3-a3a3-d9f576a0c412</span><br><span class="line"></span><br><span class="line"># 在重新创建一个 pvc </span><br><span class="line">[root@k8s-master1 nfs]# kubectl create -f mongodb-pod-pvc.yaml </span><br><span class="line">pod/mongodb created</span><br><span class="line"></span><br><span class="line"># 会发现绑定了一块新的 VOLUME</span><br><span class="line">[root@k8s-master1 nfs]# kubectl get pvc</span><br><span class="line">NAME          STATUS   VOLUME                                                         CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">mongodb-pvc   Bound    default-mongodb-pvc-pvc-9f9f3be5-8e1c-44db-bb36-fdb7219199d1   5Gi        RWX            managed-nfs-storage   2s</span><br><span class="line"></span><br><span class="line">[root@k8s-master2 nfs]# ls -l</span><br><span class="line">total 8</span><br><span class="line">drwxrwxrwx 4 polkitd root 4096 Mar 19 22:42 archived-default-mongodb-pvc-pvc-9248dad6-b64b-48c3-a3a3-d9f576a0c412</span><br><span class="line">drwxrwxrwx 4 polkitd root 4096 Mar 19 22:46 default-mongodb-pvc-pvc-9f9f3be5-8e1c-44db-bb36-fdb7219199d1</span><br></pre></td></tr></table></figure>
<h3 id="查看存储类"><a href="#查看存储类" class="headerlink" title="查看存储类"></a>查看存储类</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master1 nfs]# kubectl get sc</span><br><span class="line">NAME                  PROVISIONER      AGE</span><br><span class="line">managed-nfs-storage   fuseim.pri/ifs   26m</span><br><span class="line"></span><br><span class="line">[root@k8s-master1 nfs]# kubectl get  sc managed-nfs-storage -o yaml</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: "2020-03-19T14:22:39Z"</span><br><span class="line">  name: managed-nfs-storage</span><br><span class="line">  resourceVersion: "160399"</span><br><span class="line">  selfLink: /apis/storage.k8s.io/v1/storageclasses/managed-nfs-storage</span><br><span class="line">  uid: 08256c53-3ca7-4aa4-b0c2-620b94bd7110</span><br><span class="line">provisioner: fuseim.pri/ifs</span><br><span class="line">reclaimPolicy: Delete</span><br><span class="line">volumeBindingMode: Immediate</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/11/k8s-base16/" rel="next" title="14 K8S 服务发现 Service">
                <i class="fa fa-chevron-left"></i> 14 K8S 服务发现 Service
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/03/19/k8s-base18/" rel="prev" title="16 K8S ConfigMap 和 Secret 配置应用程序">
                16 K8S ConfigMap 和 Secret 配置应用程序 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/Greeen.jpg" alt="Harris Li">
            
              <p class="site-author-name" itemprop="name">Harris Li</p>
              <p class="site-description motion-element" itemprop="description">Beijing</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">119</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#将磁盘挂载到容器"><span class="nav-number">1.</span> <span class="nav-text">将磁盘挂载到容器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#emptyDir-卷"><span class="nav-number">2.</span> <span class="nav-text">emptyDir 卷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hostPath-卷"><span class="nav-number">3.</span> <span class="nav-text">hostPath 卷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#持久化存储"><span class="nav-number">4.</span> <span class="nav-text">持久化存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#持久化存储的作用"><span class="nav-number">4.1.</span> <span class="nav-text">持久化存储的作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用NFS作为底层存储"><span class="nav-number">4.2.</span> <span class="nav-text">使用NFS作为底层存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-mongodb-数据库-pod-测试持久化存储"><span class="nav-number">4.3.</span> <span class="nav-text">创建 mongodb 数据库 pod 测试持久化存储</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#向-MongoDB-pod-里面插入数据"><span class="nav-number">4.3.1.</span> <span class="nav-text">向 MongoDB pod 里面插入数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试持久化存储"><span class="nav-number">4.3.2.</span> <span class="nav-text">测试持久化存储</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他存储技术"><span class="nav-number">4.4.</span> <span class="nav-text">其他存储技术</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#从底层存储技术-解耦-Pod"><span class="nav-number">5.</span> <span class="nav-text">从底层存储技术 解耦 Pod</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#持久卷和持久卷声明"><span class="nav-number">5.1.</span> <span class="nav-text">持久卷和持久卷声明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久卷"><span class="nav-number">5.2.</span> <span class="nav-text">持久卷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-PV-持久卷"><span class="nav-number">5.3.</span> <span class="nav-text">创建 PV 持久卷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-PVC-持久卷声明"><span class="nav-number">5.4.</span> <span class="nav-text">创建 PVC 持久卷声明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod-使用-PVC-持久卷声明"><span class="nav-number">5.5.</span> <span class="nav-text">Pod 使用 PVC 持久卷声明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-PV-和-PVC-的好处"><span class="nav-number">5.6.</span> <span class="nav-text">使用 PV 和 PVC 的好处</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#回收持久卷"><span class="nav-number">5.7.</span> <span class="nav-text">回收持久卷</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#手动回收持久卷"><span class="nav-number">5.7.1.</span> <span class="nav-text">手动回收持久卷</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试删除-PV和底层数据"><span class="nav-number">5.7.2.</span> <span class="nav-text">测试删除 PV和底层数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自动回收持久卷"><span class="nav-number">5.7.3.</span> <span class="nav-text">自动回收持久卷</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PV-动态供给"><span class="nav-number">6.</span> <span class="nav-text">PV 动态供给</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#k8s-支持持久卷的存储插件"><span class="nav-number">6.1.</span> <span class="nav-text">k8s 支持持久卷的存储插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NFS-PV-动态供给"><span class="nav-number">6.2.</span> <span class="nav-text">NFS PV 动态供给</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nfs-自动供给-机制"><span class="nav-number">6.3.</span> <span class="nav-text">nfs 自动供给 机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-PVC"><span class="nav-number">6.4.</span> <span class="nav-text">创建 PVC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看存储类"><span class="nav-number">6.5.</span> <span class="nav-text">查看存储类</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Harris Li</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
